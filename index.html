<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>7 Wonders Score Sheet</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&display=swap');

        :root {
            --colore-primario: #3a5a78; --colore-secondario: #d4ac6e; --colore-sfondo: #1e1e1e;
            --colore-superficie: #2d2d2d; --colore-testo: #f0f0f0; --colore-testo-fioco: #a0a0a0;
            --colore-successo: #6aab75; --colore-pericolo: #c86c6c; --colore-oro: #ffd700;
            --colore-argento: #c0c0c0; --colore-bronzo: #cd7f32;
        }

        body { font-family: 'Roboto', sans-serif; background-color: var(--colore-sfondo); color: var(--colore-testo); margin: 0; padding: 20px; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
        main { width: 100%; max-width: 550px; background-color: var(--colore-superficie); padding: 25px 30px; border-radius: 12px; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2); box-sizing: border-box; }
        .logo { display: block; margin: 0 auto 20px auto; max-width: 80%; height: auto; text-align: center; }
        .logo-container { text-align: center; margin-bottom: 20px; }
        .logo-container img { max-width: 80%; height: auto; }
        #app-subtitle {
            font-family: 'Cinzel', serif;
            text-align: center;
            font-size: 1.8em;
            color: var(--colore-secondario);
            margin-top: -15px;
            margin-bottom: 25px;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.4);
        }
        h2, h3 { border-bottom: 2px solid var(--colore-primario); padding-bottom: 10px; margin-bottom: 20px; }
        
        section { transition: opacity 0.3s ease-in-out; }
        
        /* Language Switcher */
        #language-switcher { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .lang-btn { background-color: #444; padding: 8px 15px; font-size: 14px; }
        .lang-btn.active { background-color: var(--colore-secondario); color: #111; }

        /* Landing Page */
        #landing-sezione .gruppo-bottoni { flex-direction: column; }
        #support-section { margin-top: 40px; text-align: center; }
        .paypal-logo {
            width: 22px;
            height: auto;
        }
        #paypal-btn {
            background: linear-gradient(180deg, #0079C1 0%, #005EA6 100%);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: auto;
            max-width: 320px;
            padding: 12px 25px;
            border: 1px solid #003057;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0, 121, 193, 0.3);
            transition: all 0.3s ease;
            font-weight: bold;
            color: white;
            text-decoration: none;
        }
        #paypal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 121, 193, 0.4);
            filter: none;
            background: linear-gradient(180deg, #0084d6 0%, #0069b8 100%);
        }
        #credits {
            margin-top: 30px;
            text-align: center;
            font-size: 0.8em;
            color: var(--colore-testo-fioco);
        }
        #credits a {
            color: var(--colore-secondario);
            text-decoration: none;
        }
        #credits a:hover {
            text-decoration: underline;
        }


        /* Rules Section */
        #regolamento-sezione p {
            text-align: left;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        .collapsible-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            color: var(--colore-secondario);
            margin-top: 10px;
            margin-bottom: 0;
            border-bottom: 1px solid var(--colore-primario);
        }
        .collapsible-header:hover {
            filter: brightness(1.2);
        }
        .toggle-icon {
            font-size: 1.5em;
            font-weight: bold;
            transition: transform 0.3s ease;
        }
        .collapsible-header.active .toggle-icon {
            transform: rotate(45deg);
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, padding 0.4s ease-out, margin-bottom 0.4s ease-out;
            padding: 0 15px;
            margin-bottom: 0;
        }
        .collapsible-content ul {
            text-align: left;
            line-height: 1.6;
            padding-left: 20px;
            margin-top: 15px;
            margin-bottom: 15px;
        }
        .collapsible-content li {
            margin-bottom: 10px;
        }
        
        /* Game Selection Screen */
        #selezione-gioco-sezione .gruppo-bottoni {
            flex-direction: column;
            gap: 15px;
        }
        .game-selection-btn {
            text-align: left;
            padding: 20px;
            font-size: 1.1em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .game-selection-btn .game-title {
            font-weight: bold;
        }
        .game-selection-btn .game-subtitle {
            font-size: 0.8em;
            color: var(--colore-testo-fioco);
            font-weight: normal;
        }


        /* Setup */
        .player-header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--colore-primario); margin-bottom: 20px; }
        .player-header h3 { border-bottom: none; margin-bottom: 0; padding-bottom: 10px; }
        .player-header .header-options { display: flex; align-items: center; gap: 15px; }
        .player-header .checkbox-item { margin-bottom: 10px; font-size: 0.8em; }
        .form-group { display: flex; gap: 10px; margin-bottom: 25px; }
        .form-group-column { flex-direction: column; }
        .player-input, .location-input { width: 100%; padding: 12px; border: 1px solid #444; border-radius: 8px; background-color: #333; color: var(--colore-testo); font-size: 16px; box-sizing: border-box; }
        .players-list { list-style: none; padding: 0; }
        .giocatore-setup-item { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 10px; background-color: #383838; padding: 10px 15px; border-radius: 6px; margin-bottom: 8px; font-size: 18px; }
        .nome-giocatore-input { background: none; border: none; color: var(--colore-testo); font-weight: bold; font-size: 18px; font-family: 'Roboto', sans-serif; flex-grow: 1; padding: 5px; border-radius: 4px; }
        .nome-giocatore-input:focus { outline: none; background-color: rgba(255, 255, 255, 0.1); }
        .nome-giocatore-input:disabled { color: var(--colore-testo-fioco); cursor: not-allowed; }
        .delete-player-btn { background: none; border: none; color: var(--colore-pericolo); font-size: 20px; cursor: pointer; padding: 0 5px; line-height: 1; }
        .delete-player-btn:disabled { color: #555; cursor: not-allowed; }
        .wonder-select, .team-select { background-color: #444; color: var(--colore-testo); border: 1px solid #555; border-radius: 5px; padding: 8px; font-size: 14px; flex-shrink: 0; }
        .opzioni-partita { margin-top: 20px; padding: 15px; background-color: #383838; border-radius: 8px;}
        .opzioni-partita h4 { margin-top: 0; margin-bottom: 10px; }
        .checkbox-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .checkbox-item { display: flex; align-items: center; justify-content: space-between; }
        
        /* Toggle Switch Styles */
        .toggle-switch { position: relative; display: inline-block; width: 51px; height: 31px; flex-shrink: 0;}
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 31px; }
        .slider:before { position: absolute; content: ""; height: 23px; width: 23px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--colore-successo); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Punteggio */
        #punteggio-sezione h2 { text-align: center; color: white; border: none; padding: 10px 15px; border-radius: 8px; transition: background-color 0.4s ease; }
        #punteggio-inputs-container { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        .punteggio-giocatore-riga { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 15px; }
        .punteggio-giocatore-riga label { font-size: 18px; }
        .input-stepper { display: flex; align-items: center; justify-content: flex-end; gap: 8px; }
        .stepper-btn { font-size: 20px; width: 40px; height: 40px; text-align: center; padding: 0; line-height: 40px; flex-shrink: 0; }
        .input-punteggio { padding: 12px; border: 1px solid #444; border-radius: 8px; background-color: #333; color: var(--colore-testo); font-size: 18px; width: 60px; box-sizing: border-box; text-align: center; }
        
        .manual-date-input {
            width: 100%;
        }
        
        /* Stili per la sezione Scienza */
        .science-icon-grid,
        .punteggio-giocatore-riga.science-row {
            display: grid;
            grid-template-columns: 1fr repeat(4, 1fr);
            align-items: center;
            gap: 10px 15px;
        }
        .science-icon-grid {
            margin-bottom: 8px;
            align-items: end;
        }
        .punteggio-giocatore-riga.science-row .input-punteggio {
            width: 100%;
        }
        .science-icon { max-height: 30px; margin: auto; display: block; }
        #avviso-categoria { font-size: 0.9em; text-align: center; color: var(--colore-testo-fioco); background: #222; padding: 8px; border-radius: 5px; margin-bottom: 15px; }
        
        /* Risultati */
        .header-info { text-align: right; font-size: 0.8em; color: var(--colore-testo-fioco); margin-bottom: -10px; margin-top: -10px; }
        #lista-classifica { list-style: none; padding: 0; margin-bottom: 30px; }
        .risultato-giocatore, .risultato-squadra { padding: 15px; margin-bottom: 10px; background-color: #383838; border-radius: 8px; }
        .risultato-header { display: flex; justify-content: space-between; align-items: center; font-size: 20px; }
        .nome { font-weight: bold; display: flex; flex-direction: column; align-items: flex-start; }
        .wonder-display { font-style: italic; font-weight: normal; font-size: 0.7em; color: var(--colore-testo-fioco); margin-top: 2px; }
        .wonder-display-duel span { display: block; line-height: 1.3; }
        .punteggio-finale { font-weight: bold; background-color: var(--colore-primario); padding: 5px 12px; border-radius: 6px; color: white; }
        .medaglia { margin-right: 15px; font-size: 24px; }
        .risultato-squadra.vincitore .nome, .risultato-giocatore.vincitore .nome { color: var(--colore-oro); }
        .tie-breaker { font-size: 0.7em; font-weight: normal; color: var(--colore-testo-fioco); margin-left: 5px; }
        .risultato-breakdown { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #444; }
        .breakdown-item { background-color: #2c2c2c; padding: 4px 8px; border-radius: 5px; font-size: 14px; cursor: help; }
        .dettaglio-squadra { margin-top: 15px; padding-top: 15px; border-top: 1px solid #444; font-size: 0.9em; display: flex; flex-direction: column; gap: 15px; }
        .dettaglio-giocatore-individuale { background-color: #2c2c2c; padding: 10px; border-radius: 6px; }
        .dettaglio-giocatore-individuale .risultato-header { font-size: 16px; }
        .dettaglio-giocatore-individuale .risultato-breakdown { font-size: 12px; margin-top: 10px; padding-top: 10px; gap: 8px; }

        /* Bottoni */
        button { padding: 12px 20px; border: none; border-radius: 8px; background-color: var(--colore-primario); color: white; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.2s, transform 0.1s; }
        button:hover { filter: brightness(1.15); }
        button:active { transform: scale(0.98); }
        button:disabled { background-color: #555; color: #999; cursor: not-allowed; filter: none; }
        .bottone-grande { width: 100%; padding: 15px; margin-top: 10px; }
        .gruppo-bottoni { display: flex; gap: 10px; margin-top: 20px; }
        .gruppo-bottoni .bottone-grande { flex: 1; width: auto; font-size: 14px; padding: 12px 5px; }
        #nav-punteggio { justify-content: space-between; }
        .start-game-btn, #nuovaPartitaBtn { background-color: var(--colore-secondario); color: #111; }
        #nextCatBtn { background-color: var(--colore-successo); }
        .random-wonder-btn { padding: 8px 12px; font-size: 16px; flex-shrink: 0; }
        .hidden { display: none !important; }

        @media (max-width: 480px) {
            main { padding: 20px 15px; }
            .gruppo-bottoni { flex-wrap: wrap; }
            .punteggio-giocatore-riga { grid-template-columns: 1fr; gap: 5px; }
            .punteggio-giocatore-riga label { text-align: left; }
            .input-stepper { justify-content: flex-start; }
            .checkbox-container { gap: 10px; }
            .checkbox-item { flex-direction: column; align-items: flex-start; gap: 8px; }
            .player-header { flex-direction: column; align-items: flex-start; }
            .player-header .header-options { width: 100%; justify-content: space-between; }
            .player-header .checkbox-item { flex-direction: row; gap: 10px; }
        }
    </style>
</head>
<body>
    <main>
        <div id="language-switcher">
            <button id="lang-it" class="lang-btn active">IT</button>
            <button id="lang-en" class="lang-btn">EN</button>
        </div>

        <section id="landing-sezione">
            <div class="logo-container">
                <img src="https://i.imgur.com/p1PgYrh.png" alt="Logo 7 Wonders 2nd Edition">
            </div>
            <div id="app-subtitle">Companion App</div>
            <div class="gruppo-bottoni">
                <button id="landingNuovaPartitaBtn" class="bottone-grande" data-lang-key="startNewGame"></button>
                <button id="landingRegolamentoBtn" class="bottone-grande" data-lang-key="rulesClarifications"></button>
            </div>
            <div id="support-section">
                <a href="https://paypal.me/TFerrari308" target="_blank" id="paypal-btn">
                    <img src="https://i.postimg.cc/hj0x6wFB/pngimg-com-paypal-PNG7.png" alt="PayPal Logo" class="paypal-logo">
                    <span data-lang-key="supportProject"></span>
                </a>
            </div>
            <div id="credits"></div>
        </section>
        
        <section id="selezione-gioco-sezione" class="hidden">
            <h2 data-lang-key="chooseGameVersion"></h2>
            <div class="gruppo-bottoni">
                <button id="select-game-1ed" class="bottone-grande game-selection-btn">
                    <div>
                        <div class="game-title">7 Wonders</div>
                        <div class="game-subtitle" data-lang-key="game1stEdition"></div>
                    </div>
                    <span>&rarr;</span>
                </button>
                <button id="select-game-2ed" class="bottone-grande game-selection-btn">
                     <div>
                        <div class="game-title">7 Wonders</div>
                        <div class="game-subtitle" data-lang-key="game2ndEdition"></div>
                    </div>
                    <span>&rarr;</span>
                </button>
                <button id="select-game-architects" class="bottone-grande game-selection-btn">
                     <div>
                        <div class="game-title">7 Wonders: Architects</div>
                    </div>
                    <span>&rarr;</span>
                </button>
                <button id="select-game-duel" class="bottone-grande game-selection-btn">
                     <div>
                        <div class="game-title">7 Wonders: Duel</div>
                    </div>
                    <span>&rarr;</span>
                </button>
            </div>
            <div class="gruppo-bottoni">
                <button id="backToHomeFromGameSelectBtn" class="bottone-grande" data-lang-key="backToHome"></button>
            </div>
        </section>

        <section id="regolamento-sezione" class="hidden">
            <h2 data-lang-key="rulesClarifications"></h2>
            <p data-lang-key="rulesDisclaimer"></p>
            
            <div data-lang-group="rulesBaseGame">
                <h4 class="collapsible-header"><span data-lang-key="rulesBaseGame_title"></span><span class="toggle-icon">Ôºã</span></h4>
                <div class="collapsible-content"><ul></ul></div>
            </div>
            <div data-lang-group="rulesLeaders">
                <h4 class="collapsible-header"><span data-lang-key="rulesLeaders_title"></span><span class="toggle-icon">Ôºã</span></h4>
                <div class="collapsible-content"><ul></ul></div>
            </div>
            <div data-lang-group="rulesArmada">
                <h4 class="collapsible-header"><span data-lang-key="rulesArmada_title"></span><span class="toggle-icon">Ôºã</span></h4>
                <div class="collapsible-content"><ul></ul></div>
            </div>
            <div data-lang-group="rulesCities">
                <h4 class="collapsible-header"><span data-lang-key="rulesCities_title"></span><span class="toggle-icon">Ôºã</span></h4>
                <div class="collapsible-content"><ul></ul></div>
            </div>
            <div data-lang-group="rulesEdifice">
                <h4 class="collapsible-header"><span data-lang-key="rulesEdifice_title"></span><span class="toggle-icon">Ôºã</span></h4>
                <div class="collapsible-content"><ul></ul></div>
            </div>
             <div data-lang-group="rulesBabel">
                <h4 class="collapsible-header"><span data-lang-key="rulesBabel_title"></span><span class="toggle-icon">Ôºã</span></h4>
                <div class="collapsible-content"><ul></ul></div>
            </div>
            <div data-lang-group="rulesPromo">
                <h4 class="collapsible-header"><span data-lang-key="rulesPromo_title"></span><span class="toggle-icon">Ôºã</span></h4>
                <div class="collapsible-content"><ul></ul></div>
            </div>

            <div class="gruppo-bottoni">
                <button id="backToHomeFromRulesBtn" class="bottone-grande" data-lang-key="backToHome"></button>
            </div>
        </section>

        <!-- SETUP 1ST EDITION -->
        <section id="setup-1ed-sezione" class="hidden">
            <div class="logo-container">
                <img src="https://i.postimg.cc/8zKZnZ89/pngegg.png" alt="Logo 7 Wonders 1st Edition" style="max-width: 60%;">
            </div>
            <h2 data-lang-key="setupGame1ed"></h2>
            <div class="form-group form-group-column">
                <input type="text" id="nomeGiocatoreInput-1ed" class="player-input" data-lang-placeholder-key="playerNamePlaceholder">
                <button id="aggiungiGiocatoreBtn-1ed" data-lang-key="add"></button>
            </div>
            <div class="player-header">
                <h3 data-lang-key="playersAndWonders"></h3>
                <div class="header-options">
                    <div class="checkbox-item hidden" id="team-play-container-1ed">
                        <label for="team-play-checkbox-1ed" style="font-size:1em;" data-lang-key="teamGame"></label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="team-play-checkbox-1ed">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <button id="randomWonderBtn-1ed" class="random-wonder-btn" data-lang-key="randomWonders"></button>
                </div>
            </div>
            <ul id="listaGiocatori-1ed" class="players-list"></ul>
            <div class="opzioni-partita">
                <h4 data-lang-key="expansions"></h4>
                <div class="checkbox-container">
                    <div class="checkbox-item"><label for="esp-1ed-cities">Cities</label><label class="toggle-switch"><input type="checkbox" id="esp-1ed-cities"><span class="slider"></span></label></div>
                    <div class="checkbox-item"><label for="esp-1ed-leaders">Leaders</label><label class="toggle-switch"><input type="checkbox" id="esp-1ed-leaders"><span class="slider"></span></label></div>
                    <div class="checkbox-item"><label for="esp-1ed-armada">Armada</label><label class="toggle-switch"><input type="checkbox" id="esp-1ed-armada"><span class="slider"></span></label></div>
                    <div class="checkbox-item"><label for="esp-1ed-babel">Babel</label><label class="toggle-switch"><input type="checkbox" id="esp-1ed-babel"><span class="slider"></span></label></div>
                    <div class="checkbox-item"><label for="esp-1ed-wonderpack">Wonder Pack</label><label class="toggle-switch"><input type="checkbox" id="esp-1ed-wonderpack"><span class="slider"></span></label></div>
                    <div class="checkbox-item"><label for="esp-1ed-siracusa">Siracusa</label><label class="toggle-switch"><input type="checkbox" id="esp-1ed-siracusa"><span class="slider"></span></label></div>
                    <div class="checkbox-item"><label for="esp-1ed-catan">Catan</label><label class="toggle-switch"><input type="checkbox" id="esp-1ed-catan"><span class="slider"></span></label></div>
                </div>
            </div>
             <div class="opzioni-partita">
                <h4 data-lang-key="location"></h4>
                <div class="form-group" style="margin-bottom: 0;">
                     <input type="text" id="luogoPartitaInput-1ed" class="location-input" data-lang-placeholder-key="locationPlaceholder">
                </div>
            </div>
            <div class="opzioni-partita">
                <h4 data-lang-key="dateAndTime"></h4>
                <div class="checkbox-item">
                    <label for="date-toggle-1ed" data-lang-key="useManualDate"></label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="date-toggle-1ed">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="form-group hidden" id="manual-date-container-1ed" style="margin-top: 15px; margin-bottom: 0;">
                    <input type="datetime-local" id="manual-date-input-1ed" class="input-punteggio manual-date-input">
                </div>
            </div>
            <div class="gruppo-bottoni">
                <button class="back-to-game-select bottone-grande" data-lang-key="backToGameSelect"></button>
                <button id="iniziaPartitaBtn-1ed" class="bottone-grande start-game-btn" disabled data-lang-key="start"></button>
            </div>
        </section>

        <!-- SETUP 2ND EDITION -->
        <section id="setup-2ed-sezione" class="hidden">
            <div class="logo-container">
                <img src="https://i.imgur.com/p1PgYrh.png" alt="Logo 7 Wonders 2nd Edition">
            </div>
            <h2 data-lang-key="setupGame2ed"></h2>
            <div class="form-group form-group-column">
                <input type="text" id="nomeGiocatoreInput-2ed" class="player-input" data-lang-placeholder-key="playerNamePlaceholder">
                <button id="aggiungiGiocatoreBtn-2ed" data-lang-key="add"></button>
            </div>
            <div class="player-header">
                <h3 data-lang-key="playersAndWonders"></h3>
                <div class="header-options">
                     <div class="checkbox-item hidden" id="team-play-container-2ed">
                        <label for="team-play-checkbox-2ed" style="font-size:1em;" data-lang-key="teamGame"></label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="team-play-checkbox-2ed">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <button id="randomWonderBtn-2ed" class="random-wonder-btn" data-lang-key="randomWonders"></button>
                </div>
            </div>
            <ul id="listaGiocatori-2ed" class="players-list"></ul>
             <div class="opzioni-partita">
                <h4 data-lang-key="expansions"></h4>
                <div class="checkbox-container">
                    <div class="checkbox-item"><label for="esp-2ed-cities">Cities</label><label class="toggle-switch"><input type="checkbox" id="esp-2ed-cities"><span class="slider"></span></label></div>
                    <div class="checkbox-item"><label for="esp-2ed-leaders">Leaders</label><label class="toggle-switch"><input type="checkbox" id="esp-2ed-leaders"><span class="slider"></span></label></div>
                    <div class="checkbox-item"><label for="esp-2ed-armada">Armada</label><label class="toggle-switch"><input type="checkbox" id="esp-2ed-armada"><span class="slider"></span></label></div>
                    <div class="checkbox-item"><label for="esp-2ed-edifice">Edifice</label><label class="toggle-switch"><input type="checkbox" id="esp-2ed-edifice"><span class="slider"></span></label></div>
                </div>
            </div>
            <div class="opzioni-partita">
                <h4 data-lang-key="location"></h4>
                <div class="form-group" style="margin-bottom: 0;">
                     <input type="text" id="luogoPartitaInput-2ed" class="location-input" data-lang-placeholder-key="locationPlaceholder">
                </div>
            </div>
            <div class="opzioni-partita">
                <h4 data-lang-key="dateAndTime"></h4>
                <div class="checkbox-item">
                    <label for="date-toggle-2ed" data-lang-key="useManualDate"></label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="date-toggle-2ed">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="form-group hidden" id="manual-date-container-2ed" style="margin-top: 15px; margin-bottom: 0;">
                    <input type="datetime-local" id="manual-date-input-2ed" class="input-punteggio manual-date-input">
                </div>
            </div>
            <div class="gruppo-bottoni">
                <button class="back-to-game-select bottone-grande" data-lang-key="backToGameSelect"></button>
                <button id="resetSettingsBtn-2ed" data-lang-key="reset"></button>
                <button id="iniziaPartitaBtn-2ed" class="bottone-grande start-game-btn" disabled data-lang-key="start"></button>
            </div>
        </section>

        <!-- SETUP ARCHITECTS -->
        <section id="setup-architects-sezione" class="hidden">
            <div class="logo-container">
                <img src="https://i.postimg.cc/mgqzt9fK/arc-common-logo-1630334595b-VXy-Z-large.png" alt="Logo 7 Wonders Architects">
            </div>
            <h2 data-lang-key="setupGameArchitects"></h2>
             <div class="form-group form-group-column">
                <input type="text" id="nomeGiocatoreInput-architects" class="player-input" data-lang-placeholder-key="playerNamePlaceholder">
                <button id="aggiungiGiocatoreBtn-architects" data-lang-key="add"></button>
            </div>
             <div class="player-header">
                <h3 data-lang-key="playersAndWonders"></h3>
                <div class="header-options">
                    <button id="randomWonderBtn-architects" class="random-wonder-btn" data-lang-key="randomWonders"></button>
                </div>
            </div>
            <ul id="listaGiocatori-architects" class="players-list"></ul>
             <div class="opzioni-partita">
                <h4 data-lang-key="expansions"></h4>
                <div class="checkbox-container" style="grid-template-columns: 1fr;">
                    <div class="checkbox-item">
                        <label for="esp-architects-medals">Medals</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="esp-architects-medals">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>
             <div class="opzioni-partita">
                <h4 data-lang-key="location"></h4>
                <div class="form-group" style="margin-bottom: 0;">
                     <input type="text" id="luogoPartitaInput-architects" class="location-input" data-lang-placeholder-key="locationPlaceholder">
                </div>
            </div>
            <div class="opzioni-partita">
                <h4 data-lang-key="dateAndTime"></h4>
                <div class="checkbox-item">
                    <label for="date-toggle-architects" data-lang-key="useManualDate"></label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="date-toggle-architects">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="form-group hidden" id="manual-date-container-architects" style="margin-top: 15px; margin-bottom: 0;">
                    <input type="datetime-local" id="manual-date-input-architects" class="input-punteggio manual-date-input">
                </div>
            </div>
             <div class="gruppo-bottoni">
                 <button class="back-to-game-select bottone-grande" data-lang-key="backToGameSelect"></button>
                 <button id="iniziaPartitaBtn-architects" class="bottone-grande start-game-btn" disabled data-lang-key="start"></button>
             </div>
        </section>

        <!-- SETUP DUEL -->
        <section id="setup-duel-sezione" class="hidden">
            <div class="logo-container">
                <img src="https://i.postimg.cc/vmV19mGT/7WDuel.png" alt="Logo 7 Wonders Duel">
            </div>
            <h2 data-lang-key="setupGameDuel"></h2>
            <div class="form-group form-group-column">
                <input type="text" id="nomeGiocatoreInput-duel" class="player-input" data-lang-placeholder-key="playerNamePlaceholder">
                <button id="aggiungiGiocatoreBtn-duel" data-lang-key="add"></button>
            </div>
             <div class="player-header">
                <h3 data-lang-key="playersAndWonders"></h3>
                 <div class="header-options">
                    <button id="randomWonderBtn-duel" class="random-wonder-btn" data-lang-key="randomWonders" disabled></button>
                </div>
            </div>
            <ul id="listaGiocatori-duel" class="players-list"></ul>
              <div class="opzioni-partita">
                <h4 data-lang-key="expansions"></h4>
                <div class="checkbox-container">
                    <div class="checkbox-item"><label for="esp-duel-pantheon">Pantheon</label><label class="toggle-switch"><input type="checkbox" id="esp-duel-pantheon"><span class="slider"></span></label></div>
                    <div class="checkbox-item"><label for="esp-duel-agora">Agora</label><label class="toggle-switch"><input type="checkbox" id="esp-duel-agora"><span class="slider"></span></label></div>
                    <div class="checkbox-item"><label for="esp-duel-messe">Messe</label><label class="toggle-switch"><input type="checkbox" id="esp-duel-messe"><span class="slider"></span></label></div>
                    <div class="checkbox-item"><label for="esp-duel-statue">Statua della Libert√†</label><label class="toggle-switch"><input type="checkbox" id="esp-duel-statue"><span class="slider"></span></label></div>
                    <div class="checkbox-item"><label for="esp-duel-stonehenge">Stonehenge</label><label class="toggle-switch"><input type="checkbox" id="esp-duel-stonehenge"><span class="slider"></span></label></div>
                    <div class="checkbox-item"><label for="esp-duel-sagrada">Sagrada Familia</label><label class="toggle-switch"><input type="checkbox" id="esp-duel-sagrada"><span class="slider"></span></label></div>
                </div>
            </div>
            <div class="opzioni-partita">
                 <h4 data-lang-key="instantVictory"></h4>
                 <div id="instant-victory-buttons-duel" class="gruppo-bottoni" style="flex-direction: column; gap: 8px; margin-top: 10px;">
                    <!-- Buttons will be generated by JS -->
                 </div>
            </div>
             <div class="opzioni-partita">
                <h4 data-lang-key="location"></h4>
                <div class="form-group" style="margin-bottom: 0;">
                     <input type="text" id="luogoPartitaInput-duel" class="location-input" data-lang-placeholder-key="locationPlaceholder">
                </div>
            </div>
            <div class="opzioni-partita">
                <h4 data-lang-key="dateAndTime"></h4>
                <div class="checkbox-item">
                    <label for="date-toggle-duel" data-lang-key="useManualDate"></label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="date-toggle-duel">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="form-group hidden" id="manual-date-container-duel" style="margin-top: 15px; margin-bottom: 0;">
                    <input type="datetime-local" id="manual-date-input-duel" class="input-punteggio manual-date-input">
                </div>
            </div>
             <div class="gruppo-bottoni">
                 <button class="back-to-game-select bottone-grande" data-lang-key="backToGameSelect"></button>
                 <button id="iniziaPartitaBtn-duel" class="bottone-grande start-game-btn" disabled data-lang-key="start"></button>
             </div>
        </section>

        <section id="punteggio-sezione" class="hidden">
            <h2 id="titolo-categoria-punteggio"></h2>
            <div id="punteggio-inputs-container"></div>
            <div class="gruppo-bottoni" id="nav-punteggio">
                <button id="backToSetupBtn" data-lang-key="backToSetup"></button>
                <button id="prevCatBtn" data-lang-key="back">‚Üê </button>
                <button id="nextCatBtn" data-lang-key="next"> ‚Üí</button>
            </div>
        </section>

        <section id="risultati-sezione" class="hidden"></section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ===============================================
            // A. ALL VARIABLES AND CONSTANTS
            // ===============================================

            const sezioni = { 
                landing: document.getElementById('landing-sezione'), 
                selezioneGioco: document.getElementById('selezione-gioco-sezione'),
                regolamento: document.getElementById('regolamento-sezione'), 
                'setup-1ed': document.getElementById('setup-1ed-sezione'),
                'setup-2ed': document.getElementById('setup-2ed-sezione'), 
                'setup-architects': document.getElementById('setup-architects-sezione'),
                'setup-duel': document.getElementById('setup-duel-sezione'),
                punteggio: document.getElementById('punteggio-sezione'), 
                risultati: document.getElementById('risultati-sezione')
            };

            const bottoni = {
                nuovaPartitaLanding: document.getElementById('landingNuovaPartitaBtn'),
                regolamentoLanding: document.getElementById('landingRegolamentoBtn'),
                backToHomeFromRules: document.getElementById('backToHomeFromRulesBtn'),
                backToHomeFromGameSelect: document.getElementById('backToHomeFromGameSelectBtn'),
                selectGame1ed: document.getElementById('select-game-1ed'),
                selectGame2ed: document.getElementById('select-game-2ed'),
                selectGameArchitects: document.getElementById('select-game-architects'),
                selectGameDuel: document.getElementById('select-game-duel'),
                prevCat: document.getElementById('prevCatBtn'), nextCat: document.getElementById('nextCatBtn'),
                backToSetup: document.getElementById('backToSetupBtn'),
                langIt: document.getElementById('lang-it'),
                langEn: document.getElementById('lang-en'),
            };
            const ui = { 
                titoloCategoria: document.getElementById('titolo-categoria-punteggio'), 
                inputsContainer: document.getElementById('punteggio-inputs-container'), 
                appSubtitle: document.getElementById('app-subtitle'),
                credits: document.getElementById('credits')
            };
            
            const MERAVIGLIE_1ED = {
                base: ['Halikarnassos', 'Rh√≥dos', 'Olymp√≠a', 'Alexandria', 'Babylon', '√âphesos', 'Gizah'],
                leaders: ['Roma'],
                cities: ['Byzantium', 'Petra'],
                armada: [], 
                siracusa: ['Siracusa'],
                wonderpack: ['Abu Simbel', 'Grande Muraglia Cinese', 'Manneken Pis', 'Stonehenge'],
                catan: ['Catan']
            };

            const MERAVIGLIE_2ED = { 
                base: ['Halikarnassos', 'Rh√≥dos', 'Olymp√≠a', 'Alexandria', 'Babylon', '√âphesos', 'Gizah', 'Manneken Pis', 'Grande Muraglia Cinese'], 
                leaders: ['Roma', 'Abu Simbel'], 
                cities: ['Byzantium', 'Petra'], 
                armada: ['Siracusa'], 
                edifice: ['Ur', 'Carthage'] 
            };

            const MERAVIGLIE_ARCHITECTS = {
                base: ['Giza', 'Babilonia', 'Rodi', 'Efeso', 'Olimpia', 'Alicarnasso', 'Alessandria'],
                medals: ['Roma', 'Ur']
            };
            
            const MERAVIGLIE_DUEL = {
                base: ['Via Appia', 'Circo Massimo', 'Colosso', 'Grande Biblioteca', 'Grande Faro', 'Giardini Pensili', 'Mausoleo', 'Pireo', 'Piramidi', 'Sfinge', 'Statua di Zeus', 'Tempio di Artemide'],
                pantheon: ['Santuario', 'Teatro Divino'],
                agora: ['Cnosso', 'Curia Iulia'],
                messe: ['Messe'],
                statue: ['Statua della Libert√†'],
                stonehenge: ['Stonehenge'],
                sagrada: ['Sagrada Familia']
            };

            
            const CATEGORIE_1ED = [
                { key: 'meraviglia', label: 'üèõÔ∏è Meraviglia', type: 'number', color: '#7f8c8d', langKey: 'catWonder' },
                { key: 'tesoro', label: 'üí∞ Tesoro', type: 'number', color: '#f1c40f', langKey: 'catTreasury' },
                { key: 'debiti', label: 'üí∏ Debiti', type: 'number', expansion: 'cities', color: '#c0392b', langKey: 'catDebts' },
                { key: 'militari', label: '‚öîÔ∏è Conflitti Militari', type: 'number', color: '#c0392b', langKey: 'catMilitary' },
                { key: 'civili', label: 'üîµ Edifici Civili', type: 'number', color: '#2980b9', langKey: 'catCivilian' },
                { key: 'commerciali', label: 'üü° Edifici Commerciali', type: 'number', color: '#f1c40f', langKey: 'catCommercial' },
                { key: 'scienza', label: 'üü¢ Edifici Scientifici', type: 'science', color: '#27ae60', langKey: 'catScience' },
                { key: 'gilde', label: 'üü£ Gilde', type: 'number', color: '#8e44ad', langKey: 'catGuilds' },
                { key: 'cities', label: '‚ö´ Cities', type: 'number', expansion: 'cities', color: '#34495e', langKey: 'catCities' },
                { key: 'leaders', label: 'üëë Leader', type: 'number', expansion: 'leaders', color: '#bdc3c7', langKey: 'catLeaders' },
                { key: 'conflittiNavali', label: '‚öì Conflitti Navali', type: 'number', expansion: 'armada', color: '#3498db', langKey: 'catNaval' },
                { key: 'percorsoMarittimo', label: 'üó∫Ô∏è Percorso Navale Blu', type: 'number', expansion: 'armada', color: '#3498db', langKey: 'catNavalBlue' },
                { key: 'isole', label: 'üèùÔ∏è Isole', type: 'number', expansion: 'armada', color: '#16a085', langKey: 'catIslands' },
                { key: 'babel', label: 'üóº Babele', type: 'number', expansion: 'babel', color: '#a1887f', langKey: 'catBabel' },
                { key: 'grandiProgetti', label: 'üõ†Ô∏è Grandi Progetti', type: 'number', expansion: 'babel', color: '#ffab40', langKey: 'catGreatProjects' },
            ];

            const CATEGORIE_2ED = [
                { key: 'meraviglia', label: 'üèõÔ∏è Meraviglia', type: 'number', color: '#7f8c8d', langKey: 'catWonder' },
                { key: 'tesoro', label: 'üí∞ Tesoro', type: 'number', color: '#f1c40f', langKey: 'catTreasury' },
                { key: 'debiti', label: 'üí∏ Debiti', type: 'number', expansion: 'cities', color: '#c0392b', langKey: 'catDebts' },
                { key: 'militari', label: '‚öîÔ∏è Conflitti Militari', type: 'number', color: '#c0392b', langKey: 'catMilitary' },
                { key: 'civili', label: 'üîµ Edifici Civili', type: 'number', color: '#2980b9', langKey: 'catCivilian' },
                { key: 'commerciali', label: 'üü° Edifici Commerciali', type: 'number', color: '#f1c40f', langKey: 'catCommercial' },
                { key: 'scienza', label: 'üü¢ Edifici Scientifici', type: 'science', color: '#27ae60', langKey: 'catScience' },
                { key: 'gilde', label: 'üü£ Gilde', type: 'number', color: '#8e44ad', langKey: 'catGuilds' },
                { key: 'cities', label: '‚ö´ Cities', type: 'number', expansion: 'cities', color: '#34495e', langKey: 'catCities' },
                { key: 'leaders', label: 'üëë Leader', type: 'number', expansion: 'leaders', color: '#bdc3c7', langKey: 'catLeaders' },
                { key: 'conflittiNavali', label: '‚öì Conflitti Navali', type: 'number', expansion: 'armada', color: '#3498db', langKey: 'catNaval' },
                { key: 'percorsoMarittimo', label: 'üó∫Ô∏è Percorso Navale Blu', type: 'number', expansion: 'armada', color: '#3498db', langKey: 'catNavalBlue' },
                { key: 'isole', label: 'üèùÔ∏è Isole', type: 'number', expansion: 'armada', color: '#16a085', langKey: 'catIslands' },
                { key: 'edifice', label: 'üèóÔ∏è Edifici', type: 'number', expansion: 'edifice', color: '#d35400', langKey: 'catEdifice' },
            ];

            const CATEGORIE_ARCHITECTS = [
                { key: 'wonderStages', label: 'üèóÔ∏è Numero di Stadi', type: 'number', color: '#a9a9a9', langKey: 'catNumStages', descLangKey: 'catNumStages_desc' },
                { key: 'meraviglia', label: 'üèõÔ∏è Meraviglia', type: 'number', color: '#c0c0c0', langKey: 'catWonder' },
                { key: 'militari', label: '‚öîÔ∏è Vittorie Militari', type: 'number', color: '#c0392b', langKey: 'catMilitary' },
                { key: 'civili', label: 'üîµ Punti Civili', type: 'number', color: '#2980b9', langKey: 'catCivilian' },
                { key: 'scienza', label: 'üü¢ Segnalini Progresso', type: 'number', color: '#27ae60', langKey: 'catProgressTokens' },
                { key: 'gatto', label: 'üêà Pedina Gatto', type: 'checkbox', color: '#f39c12', langKey: 'catCatPawn' },
                { key: 'medaglie', label: 'üèÖ Medaglie', type: 'number', color: '#eab308', langKey: 'catMedals', expansion: 'medals'}
            ];

            const CATEGORIE_DUEL = [
                { key: 'civili', label: 'üîµ Strutture Civili', type: 'number', color: '#2980b9', langKey: 'catDuelCivilian' },
                { key: 'commerciali', label: 'üü° Strutture Commerciali', type: 'number', color: '#f1c40f', langKey: 'catDuelCommercial' },
                { key: 'gilde', label: 'üü£ Gilde', type: 'number', color: '#8e44ad', langKey: 'catGuilds' },
                { key: 'meraviglie', label: 'üèõÔ∏è Meraviglie', type: 'number', color: '#c0c0c0', langKey: 'catWonders' },
                { key: 'progresso', label: '‚öôÔ∏è Progresso', type: 'number', color: '#27ae60', langKey: 'catProgress' },
                { key: 'scienza', label: 'üî¨ Strutture Scientifiche', type: 'number', color: '#27ae60', langKey: 'catDuelScientific' },
                { key: 'tesoro', label: 'üí∞ Tesoro', type: 'number', color: '#f1c40f', langKey: 'catTreasury' },
                { key: 'militari', label: '‚öîÔ∏è Punti Militari', type: 'number', color: '#c0392b', langKey: 'catMilitary' },
                { key: 'divinita', label: 'üè∫ Divinit√†', type: 'number', color: '#D1C4E9', expansion: 'pantheon', langKey: 'catGods' },
                { key: 'grandiTempli', label: 'üõï Grandi Templi', type: 'number', color: '#FFD54F', expansion: 'pantheon', langKey: 'catGrandTemples' },
                { key: 'camere', label: 'üèõÔ∏è Camere del Senato', type: 'number', color: '#78909C', expansion: 'agora', langKey: 'catSenateChambers' },
            ];

            const CATEGORIE_NEGATIVE_PERMESSE = ['militari', 'debiti', 'conflittiNavali', 'babel', 'grandiProgetti'];
            
            const wonderTranslations = { 
                // Generic
                "Grande Muraglia Cinese": { it: "Grande Muraglia Cinese", en: "Great Wall of China" },
                // Architects
                "Alessandria": {it: "Alessandria", en: "Alexandria"},
                "Alicarnasso": {it: "Alicarnasso", en: "Halicarnassus"},
                "Babilonia": {it: "Babilonia", en: "Babylon"},
                "Efeso": {it: "Efeso", en: "Ephesos"},
                "Giza": {it: "Giza", en: "Giza"},
                "Olimpia": {it: "Olimpia", en: "Olympia"},
                "Rodi": {it: "Rodi", en: "Rhodes"},
                "Roma": {it: "Roma", en: "Rome"},
                "Ur": {it: "Ur", en: "Ur"},
                // Duel
                "Statua della Libert√†": {it: "Statua della Libert√†", en: "Statue of Liberty"},
                "Via Appia": { it: "Via Appia", en: "The Appian Way"},
                "Circo Massimo": { it: "Circo Massimo", en: "Circus Maximus"},
                "Colosso": { it: "Colosso", en: "The Colossus"},
                "Grande Biblioteca": { it: "Grande Biblioteca", en: "The Great Library"},
                "Grande Faro": { it: "Grande Faro", en: "The Great Lighthouse"},
                "Giardini Pensili": { it: "Giardini Pensili", en: "The Hanging Gardens"},
                "Mausoleo": { it: "Mausoleo", en: "The Mausoleum"},
                "Pireo": { it: "Pireo", en: "Piraeus"},
                "Piramidi": { it: "Piramidi", en: "The Pyramids"},
                "Sfinge": { it: "Sfinge", en: "The Sphinx"},
                "Statua di Zeus": { it: "Statua di Zeus", en: "The Statue of Zeus"},
                "Tempio di Artemide": { it: "Tempio di Artemide", en: "The Temple of Artemis"},
                "Santuario": { it: "Santuario", en: "The Sanctuary" },
                "Teatro Divino": { it: "Teatro Divino", en: "The Divine Theater" },
                "Cnosso": { it: "Cnosso", en: "Knossos" },
                "Curia Iulia": { it: "Curia Iulia", en: "Curia Julia" },
                "Messe": { it: "Messe", en: "Messe" },
                "Stonehenge": { it: "Stonehenge", en: "Stonehenge" },
                "Sagrada Familia": { it: "Sagrada Familia", en: "Sagrada Familia" }
            };
            
            let datiPartita;
            let currentLanguage = 'it';
            let translations = {};

            // ===============================================
            // B. TRANSLATION LOGIC
            // ===============================================

            function getWonderName(wonderKey) {
                if (!wonderKey) return '';
                if (wonderTranslations[wonderKey] && wonderTranslations[wonderKey][currentLanguage]) {
                    return wonderTranslations[wonderKey][currentLanguage];
                }
                return wonderKey;
            }

            function setLanguage(lang) {
                currentLanguage = lang;
                document.documentElement.lang = lang;

                document.getElementById('lang-it').classList.toggle('active', lang === 'it');
                document.getElementById('lang-en').classList.toggle('active', lang === 'en');
                
                document.title = translations.pageTitle[lang];

                document.querySelectorAll('[data-lang-key]').forEach(el => {
                    const key = el.dataset.langKey;
                    if(translations[key] && translations[key][lang]) {
                        el.innerHTML = translations[key][lang];
                    }
                });

                document.querySelectorAll('[data-lang-placeholder-key]').forEach(el => {
                    const key = el.dataset.langPlaceholderKey;
                    if(translations[key] && translations[key][lang]) {
                        el.placeholder = translations[key][lang];
                    }
                });
                
                document.querySelectorAll('[data-lang-group]').forEach(group => {
                    const groupKey = group.dataset.langGroup;
                    const list = group.querySelector('ul');
                    if (translations[groupKey] && list) {
                        list.innerHTML = translations[groupKey][lang].map(rule => `<li>${rule}</li>`).join('');
                    }
                });
                
                ui.credits.innerHTML = translations.creditsText[lang];

                if (datiPartita) {
                    if (datiPartita.gameVersion === '1ed') aggiornaListaGiocatoriUI_1ed();
                    else if (datiPartita.gameVersion === '2ed') aggiornaListaGiocatoriUI_2ed();
                    else if (datiPartita.gameVersion === 'architects') aggiornaListaGiocatoriUI_architects();
                    else if (datiPartita.gameVersion === 'duel') aggiornaListaGiocatoriUI_duel();
                }
            }

            function initializeTranslations() {
                translations = {
                    pageTitle: { it: 'Segnapunti 7 Wonders', en: '7 Wonders Score Sheet' },
                    startNewGame: { it: 'Inizia Nuova Partita', en: 'Start New Game' },
                    rulesClarifications: { it: 'Chiarimenti sul regolamento', en: 'Rules Clarifications' },
                    supportProject: { it: 'Supporta il Progetto', en: 'Support the Project' },
                    creditsText: { 
                        it: 'Sviluppato nel 2025 da Tommaso Ferrari. <br>Email: <a href="mailto:tommy.ferrari98@gmail.com">tommy.ferrari98@gmail.com</a> | Versione 1.9',
                        en: 'Developed in 2025 by Tommaso Ferrari. <br>Email: <a href="mailto:tommy.ferrari98@gmail.com">tommy.ferrari98@gmail.com</a> | Version 1.9'
                    },
                    // Game Selection
                    chooseGameVersion: { it: 'Scegli la Versione del Gioco', en: 'Choose Game Version' },
                    game1stEdition: { it: 'Prima Edizione', en: 'First Edition' },
                    game2ndEdition: { it: 'Seconda Edizione', en: 'Second Edition' },
                    backToGameSelect: { it: 'Torna alla Scelta', en: 'Back to Selection' },
                    comingSoon: { it: 'Disponibile a breve...', en: 'Coming soon...' },
                    setupGame1ed: { it: 'Imposta Partita', en: 'Set Up Game' },
                    setupGame2ed: { it: 'Imposta Partita', en: 'Set Up Game' },
                    setupGameArchitects: { it: 'Imposta Partita', en: 'Set Up Game' },
                    setupGameDuel: { it: 'Imposta Partita', en: 'Set Up Game' },

                    rulesDisclaimer: { 
                        it: 'Questi chiarimenti sono basati sulle risposte alle FAQ presenti sul sito ufficiale del gioco (https://www.rprod.com/it/7-wonders/faq) oppure sono stati richiesti direttamente a Repos Production via Facebook.',
                        en: 'These clarifications are based on the FAQ answers on the official game website (https://www.rprod.com/en/7-wonders/faq) or were requested directly from Repos Production via Facebook.'
                    },
                    backToHome: { it: 'Torna alla Home', en: 'Back to Home' },
                    playerNamePlaceholder: { it: 'Nome giocatore...', en: 'Player name...' },
                    add: { it: 'Aggiungi', en: 'Add' },
                    playersAndWonders: { it: 'Giocatori e Meraviglie', en: 'Players & Wonders' },
                    teamGame: { it: 'Partita a squadre', en: 'Team Game' },
                    randomWonders: { it: 'Meraviglie casuali üîÄ', en: 'Random Wonders üîÄ' },
                    expansions: { it: 'Espansioni', en: 'Expansions' },
                    location: { it: 'Luogo', en: 'Location' },
                    locationPlaceholder: { it: 'Luogo della partita...', en: 'Location of the game...' },
                    dateAndTime: { it: 'Data e ora', en: 'Date and Time' },
                    useManualDate: { it: 'Usa data e ora manuale', en: 'Use manual date and time' },
                    reset: { it: 'Reset', en: 'Reset' },
                    start: { it: 'Inizia', en: 'Start' },
                    backToSetup: { it: 'Torna al Setup', en: 'Back to Setup' },
                    back: { it: '‚Üê Indietro', en: '‚Üê Back' },
                    next: { it: 'Avanti', en: 'Next' },
                    notEnoughWonders: { it: 'Non ci sono abbastanza meraviglie uniche per tutti i giocatori.', en: 'Not enough unique wonders for all players.' },
                    chooseWonder: { it: 'Scegli Meraviglia', en: 'Choose Wonder' },
                    deletePlayer: { it: 'Elimina giocatore', en: 'Delete player' },
                    team: { it: 'Squadra', en: 'Team' },
                    guildsWarning: {
                        it: 'Attenzione: con l\'espansione Armada ogni Gilda pu√≤ valere un massimo di 10 punti vittoria.',
                        en: 'Warning: with the Armada expansion, each Guild can be worth a maximum of 10 victory points.'
                    },
                    instantVictory: { it: 'Vittoria Istantanea', en: 'Instant Victory' },
                    militarySupremacy: { it: 'Supremazia Militare', en: 'Military Supremacy' },
                    scientificSupremacy: { it: 'Supremazia Scientifica', en: 'Scientific Supremacy' },
                    politicalSupremacy: { it: 'Supremazia Politica', en: 'Political Supremacy' },
                    winsBy: { it: 'vince per', en: 'wins by' },
                    recalculateResults: { it: 'Ricalcola Risultati', en: 'Recalculate Results' },
                    seeResults: { it: 'Vedi Risultati', en: 'See Results' },
                    finalRanking: { it: 'Classifica Finale', en: 'Final Ranking' },
                    noWonder: { it: 'Nessuna', en: 'None' },
                    freeCity: { it: 'Citt√† Franca', en: 'Free City' },
                    shareResults: { it: 'Condividi Risultati', en: 'Share Results' },
                    newGame: { it: 'Nuova Partita', en: 'New Game' },
                    // Categories
                    catWonder: { it: 'Meraviglia', en: 'Wonder Board' },
                    catWonders: { it: 'Meraviglie', en: 'Wonders' },
                    catWonderStages: { it: 'Stadi Meraviglia', en: 'Wonder Stages' },
                    catNumStages: { it: 'Numero di Stadi', en: 'Number of Stages' },
                    catNumStages_desc: { it: 'Inserire il numero di stadi della meraviglia realizzati da ciascun giocatore ai fini del calcolo del vincitore in caso di spareggio.', en: 'Enter the number of wonder stages built by each player to determine the winner in case of a tie.' },
                    catTreasury: { it: 'Tesoro', en: 'Treasure' },
                    catDebts: { it: 'Debiti', en: 'Debts' },
                    catMilitary: { it: 'Conflitti Militari', en: 'Military Conflicts' },
                    catCivilian: { it: 'Edifici Civili', en: 'Civil Buildings' },
                    catDuelCivilian: { it: 'Strutture Civili', en: 'Civilian Structures' },
                    catCommercial: { it: 'Edifici Commerciali', en: 'Commercial Buildings' },
                    catDuelCommercial: { it: 'Strutture Commerciali', en: 'Commercial Buildings' },
                    catScience: { it: 'Edifici Scientifici', en: 'Scientific Buildings' },
                    catDuelScientific: { it: 'Strutture Scientifiche', en: 'Scientific Structures' },
                    catProgressTokens: { it: 'Segnalini Progresso', en: 'Progress Tokens' },
                    catProgress: { it: 'Progresso', en: 'Progress' },
                    catGuilds: { it: 'Gilde', en: 'Guilds' },
                    catCities: { it: 'Cities', en: 'Cities' },
                    catLeaders: { it: 'Leader', en: 'Leaders' },
                    catNaval: { it: 'Conflitti Navali', en: 'Naval Conflicts' },
                    catNavalBlue: { it: 'Percorso Navale Blu', en: 'Blue Naval Track' },
                    catIslands: { it: 'Isole', en: 'Islands' },
                    catEdifice: { it: 'Edifici', en: 'Edifices' },
                    catBabel: { it: 'Babele', en: 'Babel' },
                    catGreatProjects: { it: 'Grandi Progetti', en: 'Great Projects' },
                    catCatPawn: {it: 'Pedina Gatto', en: 'Cat Pawn'},
                    catMedals: {it: 'Medaglie', en: 'Medals'},
                    catGods: {it: 'Divinit√†', en: 'Gods'},
                    catGrandTemples: {it: 'Grandi Templi', en: 'Grand Temples'},
                    catSenateChambers: {it: 'Camere del Senato', en: 'Senate Chambers'},
                    // Rules Titles
                    rulesBaseGame_title: { it: '7 Wonders (Versione Base)', en: '7 Wonders (Base Game)' },
                    rulesLeaders_title: { it: 'Leaders', en: 'Leaders' },
                    rulesArmada_title: { it: 'Armada', en: 'Armada' },
                    rulesCities_title: { it: 'Cities', en: 'Cities' },
                    rulesEdifice_title: { it: 'Edifice', en: 'Edifice' },
                    rulesBabel_title: { it: 'Babel', en: 'Babel'},
                    rulesPromo_title: { it: 'Carte e Meraviglie Promo', en: 'Promo Cards & Wonders' },
                    // Rules Content (placeholders, can be filled later)
                    rulesBaseGame: { it: [], en: [] },
                    rulesLeaders: { it: [], en: [] },
                    rulesArmada: { it: [], en: [] },
                    rulesCities: { it: [], en: [] },
                    rulesEdifice: { it: [], en: [] },
                    rulesBabel: { it: [], en: []},
                    rulesPromo: { it: [], en: [] }
                };
            }
            
            // ===============================================
            // C. CORE APP LOGIC
            // ===============================================

            function mostraSezione(nomeSezione) { 
                for (const key in sezioni) { 
                    sezioni[key].classList.toggle('hidden', key !== nomeSezione); 
                }
                const isLanding = nomeSezione === 'landing';
                document.getElementById('language-switcher').classList.toggle('hidden', !isLanding);
                ui.appSubtitle.classList.toggle('hidden', !isLanding);
                ui.credits.classList.toggle('hidden', !isLanding);
            }

            function resetStato(gameVersion) { 
                datiPartita = { 
                    gameVersion: gameVersion,
                    giocatori: [], 
                    categoriaCorrenteIndex: 0, 
                    categoriePartita: [], 
                    espansioni: {}, 
                    idPartita: Date.now() 
                }; 
            }
            
            // ===================================================
            // D. 1ST EDITION LOGIC
            // ===================================================

            const setup1ed = {
                inputs: {
                    nomeGiocatore: document.getElementById('nomeGiocatoreInput-1ed'),
                    teamPlay: document.getElementById('team-play-checkbox-1ed'),
                    luogoPartita: document.getElementById('luogoPartitaInput-1ed'),
                    dateToggle: document.getElementById('date-toggle-1ed'), 
                    manualDateInput: document.getElementById('manual-date-input-1ed'),
                    esp: { 
                        cities: document.getElementById('esp-1ed-cities'), 
                        leaders: document.getElementById('esp-1ed-leaders'), 
                        armada: document.getElementById('esp-1ed-armada'), 
                        babel: document.getElementById('esp-1ed-babel'),
                        wonderpack: document.getElementById('esp-1ed-wonderpack'),
                        siracusa: document.getElementById('esp-1ed-siracusa'),
                        catan: document.getElementById('esp-1ed-catan')
                    }
                },
                bottoni: {
                    aggiungiGiocatore: document.getElementById('aggiungiGiocatoreBtn-1ed'),
                    iniziaPartita: document.getElementById('iniziaPartitaBtn-1ed'),
                    randomWonder: document.getElementById('randomWonderBtn-1ed'),
                },
                ui: {
                    listaGiocatori: document.getElementById('listaGiocatori-1ed'),
                    teamPlayContainer: document.getElementById('team-play-container-1ed'),
                    manualDateContainer: document.getElementById('manual-date-container-1ed')
                }
            };
            
            function getWondersDisponibili_1ed() { 
                let w = [...MERAVIGLIE_1ED.base];
                for(const key in datiPartita.espansioni){
                    if(datiPartita.espansioni[key] && MERAVIGLIE_1ED[key]){
                        w.push(...MERAVIGLIE_1ED[key]);
                    }
                }
                return w.sort(); 
            }
            
            function aggiornaListaGiocatoriUI_1ed() {
                updateExpansions_1ed(); 
                
                const freeCityName = translations.freeCity[currentLanguage];
                const realPlayerCount = datiPartita.giocatori.filter(g => !g.isFreeCity).length;
                const hasFreeCity = datiPartita.giocatori.some(g => g.nome === freeCityName);

                if (realPlayerCount === 2 && !hasFreeCity) {
                     datiPartita.giocatori.push({ nome: freeCityName, meraviglia: '', isFreeCity: true, team: 'A', punteggi: {}, totale: 0 });
                } else if (realPlayerCount !== 2 && hasFreeCity) {
                    datiPartita.giocatori = datiPartita.giocatori.filter(g => g.nome !== freeCityName);
                }

                setup1ed.ui.listaGiocatori.innerHTML = '';
                const wondersDisponibili = getWondersDisponibili_1ed();
                const teamPlayActive = setup1ed.inputs.teamPlay.checked;
                
                datiPartita.giocatori.forEach((g, index) => {
                    const li = document.createElement('li');
                    li.className = 'giocatore-setup-item';
                    
                    const nomeInput = document.createElement('input');
                    nomeInput.type = 'text';
                    nomeInput.className = 'nome-giocatore-input';
                    nomeInput.value = g.nome;
                    nomeInput.dataset.index = index;
                    if(g.isFreeCity) {
                        nomeInput.disabled = true;
                    } else {
                        nomeInput.addEventListener('input', (e) => {
                            datiPartita.giocatori[index].nome = e.target.value;
                        });
                    }
                    li.appendChild(nomeInput);

                     if(teamPlayActive) {
                        const teamSelect = document.createElement('select');
                        teamSelect.className = 'team-select';
                        let teamOptions = ['A', 'B'];
                        if (datiPartita.giocatori.length === 6) teamOptions = ['A', 'B', 'C'];
                        if (datiPartita.giocatori.length === 8) teamOptions = ['A', 'B', 'C', 'D'];
                        const teamLabel = translations.team[currentLanguage];
                        teamSelect.innerHTML = teamOptions.map(t => `<option value="${t}" ${g.team === t ? 'selected' : ''}>${teamLabel} ${t}</option>`).join('');
                        teamSelect.addEventListener('change', (e) => { g.team = e.target.value; });
                        li.appendChild(teamSelect);
                    }

                    const selectEl = document.createElement('select');
                    selectEl.className = 'wonder-select'; 
                    selectEl.innerHTML = `<option value="">${translations.chooseWonder[currentLanguage]}</option>`;
                    wondersDisponibili.forEach(w => { 
                        const o = document.createElement('option'); 
                        o.value = w; 
                        o.textContent = getWonderName(w); 
                        if (g.meraviglia === w) o.selected = true; 
                        selectEl.appendChild(o); 
                    });
                    selectEl.addEventListener('change', (e) => { g.meraviglia = e.target.value; });
                    li.appendChild(selectEl); 
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-player-btn';
                    deleteBtn.innerHTML = '&#10006;';
                    deleteBtn.title = translations.deletePlayer[currentLanguage];
                    if (g.isFreeCity) {
                        deleteBtn.disabled = true;
                    } else {
                         deleteBtn.addEventListener('click', () => {
                            datiPartita.giocatori.splice(index, 1);
                            aggiornaListaGiocatoriUI_1ed();
                        });
                    }
                    li.appendChild(deleteBtn);

                    setup1ed.ui.listaGiocatori.appendChild(li);
                });
                const num = datiPartita.giocatori.filter(g => !g.isFreeCity).length;
                setup1ed.bottoni.iniziaPartita.disabled = num < 2;

                const canPlayTeams = num === 4 || num === 6 || num === 8;
                setup1ed.ui.teamPlayContainer.classList.toggle('hidden', !canPlayTeams);
                if (!canPlayTeams) {
                    setup1ed.inputs.teamPlay.checked = false;
                }
                updateExpansions_1ed(true);
            }

            function aggiungiGiocatore_1ed() {
                const nome = setup1ed.inputs.nomeGiocatore.value.trim();
                const realPlayerCount = datiPartita.giocatori.filter(g => !g.isFreeCity).length;
                if (nome && realPlayerCount < 8) {
                    datiPartita.giocatori.push({ nome, meraviglia: '', team: 'A', punteggi: {}, totale: 0 });
                    setup1ed.inputs.nomeGiocatore.value = '';
                    aggiornaListaGiocatoriUI_1ed();
                    setup1ed.inputs.nomeGiocatore.focus();
                }
            }
            
            function assegnaMeraviglieCasuali_1ed() {
                const numGiocatori = datiPartita.giocatori.length;
                if (numGiocatori === 0) return;
                let wonders = getWondersDisponibili_1ed();
                if (wonders.length < numGiocatori) {
                    alert(translations.notEnoughWonders[currentLanguage]);
                    return;
                }
                for (let i = wonders.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [wonders[i], wonders[j]] = [wonders[j], wonders[i]];
                }
                datiPartita.giocatori.forEach((g, i) => {
                    g.meraviglia = wonders[i];
                });
                aggiornaListaGiocatoriUI_1ed();
            }

            function avviaPartita_1ed() {
                updateExpansions_1ed(true);
                datiPartita.categoriePartita = CATEGORIE_1ED.filter(cat => !cat.expansion || datiPartita.espansioni[cat.expansion]);
                avviaPartitaGenerale();
            }

            function updateExpansions_1ed(isStartingGame = false) {
                 for (const key in setup1ed.inputs.esp) {
                    datiPartita.espansioni[key] = setup1ed.inputs.esp[key].checked;
                }
                if(isStartingGame){
                     datiPartita.espansioni.giocoASquadre = setup1ed.inputs.teamPlay.checked;
                     datiPartita.luogo = setup1ed.inputs.luogoPartita.value.trim();
                     datiPartita.manualDate = setup1ed.inputs.dateToggle.checked ? setup1ed.inputs.manualDateInput.value : null;
                }
            }

            // ===================================================
            // E. 2ND EDITION LOGIC
            // ===================================================
            
            const setup2ed = {
                 inputs: { 
                    nomeGiocatore: document.getElementById('nomeGiocatoreInput-2ed'), 
                    luogoPartita: document.getElementById('luogoPartitaInput-2ed'), 
                    esp: { 
                        cities: document.getElementById('esp-2ed-cities'), 
                        leaders: document.getElementById('esp-2ed-leaders'), 
                        armada: document.getElementById('esp-2ed-armada'), 
                        edifice: document.getElementById('esp-2ed-edifice') 
                    }, 
                    teamPlay: document.getElementById('team-play-checkbox-2ed'), 
                    dateToggle: document.getElementById('date-toggle-2ed'), 
                    manualDateInput: document.getElementById('manual-date-input-2ed') 
                },
                bottoni: {
                    aggiungiGiocatore: document.getElementById('aggiungiGiocatoreBtn-2ed'),
                    iniziaPartita: document.getElementById('iniziaPartitaBtn-2ed'),
                    randomWonder: document.getElementById('randomWonderBtn-2ed'),
                    resetSettings: document.getElementById('resetSettingsBtn-2ed'),
                },
                ui: {
                    listaGiocatori: document.getElementById('listaGiocatori-2ed'),
                    teamPlayContainer: document.getElementById('team-play-container-2ed'),
                    manualDateContainer: document.getElementById('manual-date-container-2ed')
                }
            };

            function getWondersDisponibili_2ed() { 
                let w = [...MERAVIGLIE_2ED.base]; 
                for (const key in datiPartita.espansioni) {
                    if (datiPartita.espansioni[key] && MERAVIGLIE_2ED[key]) {
                        w.push(...MERAVIGLIE_2ED[key]);
                    }
                }
                return w.sort(); 
            }

            function aggiornaListaGiocatoriUI_2ed() {
                updateExpansions_2ed();
                setup2ed.ui.listaGiocatori.innerHTML = '';
                const wondersDisponibili = getWondersDisponibili_2ed();
                const teamPlayActive = setup2ed.inputs.teamPlay.checked;
                datiPartita.giocatori.forEach((g, index) => {
                    const li = document.createElement('li');
                    li.className = 'giocatore-setup-item';
                    
                    const nomeInput = document.createElement('input');
                    nomeInput.type = 'text';
                    nomeInput.className = 'nome-giocatore-input';
                    nomeInput.value = g.nome;
                    nomeInput.dataset.index = index;
                    nomeInput.addEventListener('input', (e) => {
                        datiPartita.giocatori[index].nome = e.target.value;
                    });
                    li.appendChild(nomeInput);

                    if(teamPlayActive) {
                        const teamSelect = document.createElement('select');
                        teamSelect.className = 'team-select';
                        const teamOptions = datiPartita.giocatori.length === 4 ? ['A', 'B'] : ['A', 'B', 'C'];
                        const teamLabel = translations.team[currentLanguage];
                        teamSelect.innerHTML = teamOptions.map(t => `<option value="${t}" ${g.team === t ? 'selected' : ''}>${teamLabel} ${t}</option>`).join('');
                        teamSelect.addEventListener('change', (e) => { g.team = e.target.value; });
                        li.appendChild(teamSelect);
                    }
                    
                    const selectEl = document.createElement('select');
                    selectEl.className = 'wonder-select'; 
                    selectEl.innerHTML = `<option value="">${translations.chooseWonder[currentLanguage]}</option>`;
                    wondersDisponibili.forEach(w => { 
                        const o = document.createElement('option'); 
                        o.value = w; 
                        o.textContent = getWonderName(w); 
                        if (g.meraviglia === w) o.selected = true; 
                        selectEl.appendChild(o); 
                    });
                    selectEl.addEventListener('change', (e) => { g.meraviglia = e.target.value; });
                    li.appendChild(selectEl); 
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-player-btn';
                    deleteBtn.innerHTML = '&#10006;';
                    deleteBtn.title = translations.deletePlayer[currentLanguage];
                    deleteBtn.addEventListener('click', () => {
                        datiPartita.giocatori.splice(index, 1);
                        aggiornaListaGiocatoriUI_2ed();
                    });
                    li.appendChild(deleteBtn);

                    setup2ed.ui.listaGiocatori.appendChild(li);
                });
                const num = datiPartita.giocatori.length;
                setup2ed.bottoni.iniziaPartita.disabled = num < 3;
                const canPlayTeams = num === 4 || num === 6;
                setup2ed.ui.teamPlayContainer.classList.toggle('hidden', !canPlayTeams);
                if (!canPlayTeams) {
                    setup2ed.inputs.teamPlay.checked = false;
                }
                 updateExpansions_2ed(true);
            }
            
            function aggiungiGiocatore_2ed() {
                const nome = setup2ed.inputs.nomeGiocatore.value.trim();
                if (nome && datiPartita.giocatori.length < 7) {
                    datiPartita.giocatori.push({ nome, meraviglia: '', team: 'A', punteggi: {}, totale: 0 });
                    setup2ed.inputs.nomeGiocatore.value = '';
                    aggiornaListaGiocatoriUI_2ed();
                    setup2ed.inputs.nomeGiocatore.focus();
                }
            }
            
            function assegnaMeraviglieCasuali_2ed() {
                const numGiocatori = datiPartita.giocatori.length;
                if (numGiocatori === 0) return;
                let wonders = getWondersDisponibili_2ed();
                if (wonders.length < numGiocatori) {
                    alert(translations.notEnoughWonders[currentLanguage]);
                    return;
                }
                for (let i = wonders.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [wonders[i], wonders[j]] = [wonders[j], wonders[i]];
                }
                datiPartita.giocatori.forEach((g, i) => {
                    g.meraviglia = wonders[i];
                });
                aggiornaListaGiocatoriUI_2ed();
            }
            
            function avviaPartita_2ed() {
                updateExpansions_2ed(true); // Final update before starting
                datiPartita.categoriePartita = CATEGORIE_2ED.filter(cat => !cat.expansion || datiPartita.espansioni[cat.expansion]);
                avviaPartitaGenerale();
            }
            
            function updateExpansions_2ed(isStartingGame = false) {
                 for (const key in setup2ed.inputs.esp) {
                    datiPartita.espansioni[key] = setup2ed.inputs.esp[key].checked;
                }
                if(isStartingGame){
                    datiPartita.espansioni.giocoASquadre = setup2ed.inputs.teamPlay.checked;
                    datiPartita.luogo = setup2ed.inputs.luogoPartita.value.trim();
                    datiPartita.manualDate = setup2ed.inputs.dateToggle.checked ? setup2ed.inputs.manualDateInput.value : null;
                }
            }

            // ===================================================
            // F. ARCHITECTS LOGIC
            // ===================================================

            const setupArchitects = {
                 inputs: { 
                    nomeGiocatore: document.getElementById('nomeGiocatoreInput-architects'), 
                    luogoPartita: document.getElementById('luogoPartitaInput-architects'),
                    dateToggle: document.getElementById('date-toggle-architects'), 
                    manualDateInput: document.getElementById('manual-date-input-architects'),
                    esp: {
                        medals: document.getElementById('esp-architects-medals')
                    }
                },
                bottoni: {
                    aggiungiGiocatore: document.getElementById('aggiungiGiocatoreBtn-architects'),
                    iniziaPartita: document.getElementById('iniziaPartitaBtn-architects'),
                    randomWonder: document.getElementById('randomWonderBtn-architects'),
                },
                ui: {
                    listaGiocatori: document.getElementById('listaGiocatori-architects'),
                    manualDateContainer: document.getElementById('manual-date-container-architects'),
                }
            };
            
            function getWondersDisponibili_architects() {
                let w = [...MERAVIGLIE_ARCHITECTS.base];
                if (datiPartita.espansioni.medals) {
                    w.push(...MERAVIGLIE_ARCHITECTS.medals);
                }
                return w.sort();
            }

            function aggiornaListaGiocatoriUI_architects() {
                updateExpansions_architects();
                setupArchitects.ui.listaGiocatori.innerHTML = '';
                const wondersDisponibili = getWondersDisponibili_architects();
                
                datiPartita.giocatori.forEach((g, index) => {
                    const li = document.createElement('li');
                    li.className = 'giocatore-setup-item';
                    
                    const nomeInput = document.createElement('input');
                    nomeInput.type = 'text';
                    nomeInput.className = 'nome-giocatore-input';
                    nomeInput.value = g.nome;
                    nomeInput.dataset.index = index;
                    nomeInput.addEventListener('input', (e) => {
                        datiPartita.giocatori[index].nome = e.target.value;
                    });
                    li.appendChild(nomeInput);

                    const selectEl = document.createElement('select');
                    selectEl.className = 'wonder-select'; 
                    selectEl.innerHTML = `<option value="">${translations.chooseWonder[currentLanguage]}</option>`;
                    wondersDisponibili.forEach(w => { 
                        const o = document.createElement('option'); 
                        o.value = w; 
                        o.textContent = getWonderName(w); 
                        if (g.meraviglia === w) o.selected = true; 
                        selectEl.appendChild(o); 
                    });
                    selectEl.addEventListener('change', (e) => { g.meraviglia = e.target.value; });
                    li.appendChild(selectEl); 
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-player-btn';
                    deleteBtn.innerHTML = '&#10006;';
                    deleteBtn.title = translations.deletePlayer[currentLanguage];
                    deleteBtn.addEventListener('click', () => {
                        datiPartita.giocatori.splice(index, 1);
                        aggiornaListaGiocatoriUI_architects();
                    });
                    li.appendChild(deleteBtn);

                    setupArchitects.ui.listaGiocatori.appendChild(li);
                });

                const num = datiPartita.giocatori.length;
                setupArchitects.bottoni.iniziaPartita.disabled = num < 2;
            }

            function aggiungiGiocatore_architects() {
                const nome = setupArchitects.inputs.nomeGiocatore.value.trim();
                if (nome && datiPartita.giocatori.length < 7) {
                    datiPartita.giocatori.push({ nome, meraviglia: '', punteggi: {}, totale: 0 });
                    setupArchitects.inputs.nomeGiocatore.value = '';
                    aggiornaListaGiocatoriUI_architects();
                    setupArchitects.inputs.nomeGiocatore.focus();
                }
            }

            function assegnaMeraviglieCasuali_architects() {
                const numGiocatori = datiPartita.giocatori.length;
                if (numGiocatori === 0) return;
                let wonders = getWondersDisponibili_architects();
                if (wonders.length < numGiocatori) {
                    alert(translations.notEnoughWonders[currentLanguage]);
                    return;
                }
                for (let i = wonders.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [wonders[i], wonders[j]] = [wonders[j], wonders[i]];
                }
                datiPartita.giocatori.forEach((g, i) => {
                    g.meraviglia = wonders[i];
                });
                aggiornaListaGiocatoriUI_architects();
            }


             function updateExpansions_architects() {
                 for (const key in setupArchitects.inputs.esp) {
                    datiPartita.espansioni[key] = setupArchitects.inputs.esp[key].checked;
                }
            }
            function avviaPartita_architects() {
                updateExpansions_architects();
                datiPartita.categoriePartita = CATEGORIE_ARCHITECTS.filter(cat => !cat.expansion || datiPartita.espansioni[cat.expansion]);
                datiPartita.luogo = setupArchitects.inputs.luogoPartita.value.trim();
                datiPartita.manualDate = setupArchitects.inputs.dateToggle.checked ? setupArchitects.inputs.manualDateInput.value : null;
                avviaPartitaGenerale();
            }

            // ===================================================
            // G. DUEL LOGIC
            // ===================================================

            const setupDuel = {
                 inputs: { 
                    nomeGiocatore: document.getElementById('nomeGiocatoreInput-duel'), 
                    luogoPartita: document.getElementById('luogoPartitaInput-duel'),
                    dateToggle: document.getElementById('date-toggle-duel'), 
                    manualDateInput: document.getElementById('manual-date-input-duel'),
                    esp: {
                        pantheon: document.getElementById('esp-duel-pantheon'),
                        agora: document.getElementById('esp-duel-agora'),
                        messe: document.getElementById('esp-duel-messe'),
                        statue: document.getElementById('esp-duel-statue'),
                        stonehenge: document.getElementById('esp-duel-stonehenge'),
                        sagrada: document.getElementById('esp-duel-sagrada')
                    }
                },
                bottoni: {
                    aggiungiGiocatore: document.getElementById('aggiungiGiocatoreBtn-duel'),
                    iniziaPartita: document.getElementById('iniziaPartitaBtn-duel'),
                    randomWonder: document.getElementById('randomWonderBtn-duel'),
                },
                ui: {
                    listaGiocatori: document.getElementById('listaGiocatori-duel'),
                    manualDateContainer: document.getElementById('manual-date-container-duel'),
                    instantVictoryContainer: document.getElementById('instant-victory-buttons-duel')
                }
            };
            
            function getWondersDisponibili_duel() {
                let w = [...MERAVIGLIE_DUEL.base];
                if (datiPartita.espansioni.pantheon) w.push(...MERAVIGLIE_DUEL.pantheon);
                if (datiPartita.espansioni.agora) w.push(...MERAVIGLIE_DUEL.agora);
                if (datiPartita.espansioni.messe) w.push(...MERAVIGLIE_DUEL.messe);
                if (datiPartita.espansioni.statue) w.push(...MERAVIGLIE_DUEL.statue);
                if (datiPartita.espansioni.stonehenge) w.push(...MERAVIGLIE_DUEL.stonehenge);
                if (datiPartita.espansioni.sagrada) w.push(...MERAVIGLIE_DUEL.sagrada);
                return w.sort();
            }
            
            function aggiornaListaGiocatoriUI_duel() {
                updateExpansions_duel();
                setupDuel.ui.listaGiocatori.innerHTML = '';
                
                datiPartita.giocatori.forEach((g, playerIndex) => {
                    const li = document.createElement('li');
                    li.className = 'giocatore-setup-item form-group-column';
                    li.style.alignItems = 'stretch';
                    
                    const header = document.createElement('div');
                    header.style.display = 'flex';
                    header.style.justifyContent = 'space-between';

                    const nomeInput = document.createElement('input');
                    nomeInput.type = 'text';
                    nomeInput.className = 'nome-giocatore-input';
                    nomeInput.value = g.nome;
                    nomeInput.dataset.index = playerIndex;
                    nomeInput.addEventListener('input', (e) => {
                        datiPartita.giocatori[playerIndex].nome = e.target.value;
                         aggiornaBottoniVittoriaIstantanea_duel();
                    });
                    header.appendChild(nomeInput);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-player-btn';
                    deleteBtn.innerHTML = '&#10006;';
                    deleteBtn.title = translations.deletePlayer[currentLanguage];
                    deleteBtn.addEventListener('click', () => {
                        datiPartita.giocatori.splice(playerIndex, 1);
                        aggiornaListaGiocatoriUI_duel();
                    });
                    header.appendChild(deleteBtn);
                    li.appendChild(header);

                    const wondersContainer = document.createElement('div');
                    wondersContainer.className = 'checkbox-container';
                    wondersContainer.style.marginTop = '10px';
                    
                    for (let i = 0; i < 4; i++) {
                         const selectEl = document.createElement('select');
                         selectEl.className = 'wonder-select'; 
                         selectEl.innerHTML = `<option value="">${translations.chooseWonder[currentLanguage]} #${i + 1}</option>`;
                         const wondersDisponibili = getWondersDisponibili_duel();
                         wondersDisponibili.forEach(w => { 
                             const o = document.createElement('option'); 
                             o.value = w; 
                             o.textContent = getWonderName(w); 
                             if (g.meraviglie && g.meraviglie[i] === w) o.selected = true; 
                             selectEl.appendChild(o); 
                         });
                         selectEl.addEventListener('change', (e) => { 
                             if (!g.meraviglie) g.meraviglie = [];
                             g.meraviglie[i] = e.target.value; 
                         });
                         wondersContainer.appendChild(selectEl);
                    }
                    li.appendChild(wondersContainer);

                    setupDuel.ui.listaGiocatori.appendChild(li);
                });

                const num = datiPartita.giocatori.length;
                setupDuel.bottoni.iniziaPartita.disabled = num !== 2;
                setupDuel.bottoni.aggiungiGiocatore.disabled = num >= 2;
                setupDuel.bottoni.randomWonder.disabled = num !== 2;
                aggiornaBottoniVittoriaIstantanea_duel();
            }
             function assegnaMeraviglieCasuali_duel() {
                const numGiocatori = datiPartita.giocatori.length;
                if (numGiocatori !== 2) return;

                let wonders = getWondersDisponibili_duel();
                if (wonders.length < 8) {
                    alert(translations.notEnoughWonders[currentLanguage]);
                    return;
                }
                
                for (let i = wonders.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [wonders[i], wonders[j]] = [wonders[j], wonders[i]];
                }
                
                datiPartita.giocatori[0].meraviglie = wonders.slice(0, 4);
                datiPartita.giocatori[1].meraviglie = wonders.slice(4, 8);
                
                aggiornaListaGiocatoriUI_duel();
            }

            function aggiungiGiocatore_duel() {
                const nome = setupDuel.inputs.nomeGiocatore.value.trim();
                if (nome && datiPartita.giocatori.length < 2) {
                    datiPartita.giocatori.push({ nome, punteggi: {}, totale: 0 });
                    setupDuel.inputs.nomeGiocatore.value = '';
                    aggiornaListaGiocatoriUI_duel();
                    setupDuel.inputs.nomeGiocatore.focus();
                }
            }
            
            function aggiornaBottoniVittoriaIstantanea_duel() {
                const container = setupDuel.ui.instantVictoryContainer;
                container.innerHTML = '';
                if(datiPartita.giocatori.length !== 2) return;

                const supremacyTypes = [
                    { key: 'militarySupremacy', label: translations.militarySupremacy[currentLanguage] },
                    { key: 'scientificSupremacy', label: translations.scientificSupremacy[currentLanguage] },
                ];
                if (datiPartita.espansioni.agora) {
                     supremacyTypes.push({ key: 'politicalSupremacy', label: translations.politicalSupremacy[currentLanguage] });
                }

                datiPartita.giocatori.forEach((player, index) => {
                    supremacyTypes.forEach(supremacy => {
                        const btn = document.createElement('button');
                        btn.className = 'bottone-grande';
                        btn.style.fontSize = '0.9em';
                        btn.textContent = `${player.nome || `Giocatore ${index+1}`} - ${supremacy.label}`;
                        btn.addEventListener('click', () => {
                            mostraVittoriaIstantanea(player.nome, supremacy.label);
                        });
                        container.appendChild(btn);
                    });
                });
            }

            function mostraVittoriaIstantanea(vincitore, motivo) {
                 const dataPartita = datiPartita.manualDate ? new Date(datiPartita.manualDate) : new Date();
                const locale = currentLanguage === 'it' ? 'it-IT' : 'en-US';
                datiPartita.data = datiPartita.data || dataPartita.toLocaleString(locale, { day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit' });
                datiPartita.luogo = setupDuel.inputs.luogoPartita.value.trim();

                sezioni.risultati.innerHTML = `
                    <div class="header-info">
                        <span>${datiPartita.data}${datiPartita.luogo ? `, ${datiPartita.luogo}` : ''}</span>
                    </div>
                    <h2 style="color: var(--colore-oro);">üèÜ ${vincitore} üèÜ</h2>
                    <p style="text-align: center; font-size: 1.2em;">${translations.winsBy[currentLanguage]} <strong>${motivo}</strong>!</p>
                `;
                 const btnGroupBottom = document.createElement('div');
                btnGroupBottom.className = 'gruppo-bottoni';
                const nuovaPartitaBtn = document.createElement('button');
                nuovaPartitaBtn.className = 'bottone-grande';
                nuovaPartitaBtn.textContent = translations.newGame[currentLanguage];
                nuovaPartitaBtn.addEventListener('click', () => {
                    mostraSezione(`setup-duel`);
                });
                btnGroupBottom.appendChild(nuovaPartitaBtn);
                sezioni.risultati.appendChild(btnGroupBottom);
                mostraSezione('risultati');
            }


            function updateExpansions_duel() {
                for (const key in setupDuel.inputs.esp) {
                    datiPartita.espansioni[key] = setupDuel.inputs.esp[key].checked;
                }
            }

            function avviaPartita_duel() {
                updateExpansions_duel();
                datiPartita.categoriePartita = CATEGORIE_DUEL.filter(cat => {
                    if (cat.key === 'gilde' && datiPartita.espansioni.pantheon) {
                        return false;
                    }
                    return !cat.expansion || datiPartita.espansioni[cat.expansion];
                });
                datiPartita.luogo = setupDuel.inputs.luogoPartita.value.trim();
                datiPartita.manualDate = setupDuel.inputs.dateToggle.checked ? setupDuel.inputs.manualDateInput.value : null;
                avviaPartitaGenerale();
            }


            // ===================================================
            // H. SCORING & RESULTS LOGIC (SHARED)
            // ===================================================

            function avviaPartitaGenerale() {
                if (!datiPartita.hasCalculatedResults) {
                    datiPartita.categoriaCorrenteIndex = 0;
                } else if (datiPartita.categoriaCorrenteIndex >= datiPartita.categoriePartita.length) {
                    datiPartita.categoriaCorrenteIndex = datiPartita.categoriePartita.length - 1;
                }
                mostraSezione('punteggio');
                mostraSchermataCategoria();
            }

            function mostraSchermataCategoria() {
                const index = datiPartita.categoriaCorrenteIndex;
                const categoria = datiPartita.categoriePartita[index];
                if (!categoria) return;

                ui.titoloCategoria.innerHTML = `${categoria.label.split(' ')[0]} ${translations[categoria.langKey][currentLanguage]}`;
                ui.titoloCategoria.style.backgroundColor = categoria.color || 'transparent';
                ui.inputsContainer.innerHTML = '';
                 if (categoria.descLangKey) {
                    const desc = document.createElement('p');
                    desc.id = 'avviso-categoria'; 
                    desc.textContent = translations[categoria.descLangKey][currentLanguage];
                    ui.inputsContainer.appendChild(desc);
                }


                if (categoria.key === 'gilde' && datiPartita.espansioni.armada) {
                    const avviso = document.createElement('div');
                    avviso.id = 'avviso-categoria';
                    avviso.textContent = translations.guildsWarning[currentLanguage];
                    ui.inputsContainer.appendChild(avviso);
                }

                if (categoria.type === 'science' && datiPartita.gameVersion !== 'architects') {
                    const iconHeader = document.createElement('div');
                    iconHeader.className = 'science-icon-grid';
                    iconHeader.innerHTML = `<div></div>
                                            <div><img src="https://i.postimg.cc/y6gd7hgg/compasso.png" class="science-icon" alt="Compasso"></div>
                                            <div><img src="https://i.postimg.cc/7b8j4rCV/tavoletta.png" class="science-icon" alt="Tavoletta"></div>
                                            <div><img src="https://i.postimg.cc/C12WvqS9/ingranaggio.png" class="science-icon" alt="Ingranaggio"></div>
                                            <div><img src="https://i.postimg.cc/43WC90Mf/serie.png" class="science-icon" alt="Serie"></div>`;
                    ui.inputsContainer.appendChild(iconHeader);

                    datiPartita.giocatori.forEach((giocatore, playerIndex) => {
                        const riga = document.createElement('div');
                        riga.className = 'punteggio-giocatore-riga science-row';
                        const puntiSalvati = giocatore.punteggi[categoria.key] || { compasso: 0, tavoletta: 0, ingranaggio: 0, serie: 0 };

                        const label = document.createElement('label');
                        label.innerHTML = `${giocatore.nome}<span id="anteprima-scienza-${playerIndex}" style="color: var(--colore-successo); font-weight: bold; display: block; font-size: 0.8em;">(${calcolaPuntiScienzaOttimizzati(puntiSalvati)}pt)</span>`;
                        riga.appendChild(label);

                        const scienceTypes = ['compasso', 'tavoletta', 'ingranaggio', 'serie'];
                        scienceTypes.forEach(type => {
                            const input = document.createElement('input');
                            input.type = 'number';
                            input.className = 'input-punteggio';
                            input.dataset.playerIndex = playerIndex;
                            input.dataset.scienceType = type;
                            input.value = puntiSalvati[type] || 0;
                            input.min = "0";
                            riga.appendChild(input);
                        });

                        ui.inputsContainer.appendChild(riga);
                    });

                } else if (categoria.type === 'checkbox') {
                     datiPartita.giocatori.forEach((giocatore, playerIndex) => {
                        const riga = document.createElement('div');
                        riga.className = 'punteggio-giocatore-riga checkbox-item';
                        riga.style.justifyContent = "space-between";
                        riga.innerHTML = `<label>${giocatore.nome}</label>
                                        <input type="checkbox" name="cat-check-${categoria.key}" value="${playerIndex}" ${datiPartita.giocatoreGattoIndex == playerIndex ? 'checked' : ''}>`;
                        ui.inputsContainer.appendChild(riga);
                    });
                     ui.inputsContainer.querySelectorAll(`input[name="cat-check-${categoria.key}"]`).forEach(check => {
                        check.addEventListener('change', (e) => {
                            if(e.target.checked) {
                                ui.inputsContainer.querySelectorAll(`input[name="cat-check-${categoria.key}"]`).forEach(otherCheck => {
                                    if(otherCheck !== e.target) otherCheck.checked = false;
                                });
                            }
                        });
                    });

                } else { // For type 'number' (includes architects science)
                    datiPartita.giocatori.forEach((giocatore, playerIndex) => {
                        const riga = document.createElement('div');
                        const minAttribute = CATEGORIE_NEGATIVE_PERMESSE.includes(categoria.key) ? '' : 'min="0"';
                        riga.className = 'punteggio-giocatore-riga';
                        riga.innerHTML = `<label for="p-cat-${playerIndex}">${giocatore.nome}</label>
                                        <div class="input-stepper">
                                            <button class="stepper-btn" data-player-index="${playerIndex}" data-step="-1">-</button>
                                            <input type="number" id="p-cat-${playerIndex}" class="input-punteggio" data-player-index="${playerIndex}" value="${giocatore.punteggi[categoria.key] || 0}" ${minAttribute}>
                                            <button class="stepper-btn" data-player-index="${playerIndex}" data-step="1">+</button>
                                        </div>`;
                        ui.inputsContainer.appendChild(riga);
                    });
                }

                ui.inputsContainer.querySelectorAll('.stepper-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const input = e.target.parentElement.querySelector('input');
                        const step = parseInt(e.target.dataset.step);
                        const min = parseInt(input.min);
                        const newValue = parseInt(input.value) + step;
                        if (!isNaN(min) && newValue < min) {
                            return;
                        }
                        input.value = newValue;
                        input.dispatchEvent(new Event('input')); 
                    });
                });

                ui.inputsContainer.querySelectorAll('input[type=number]').forEach(input => {
                     input.addEventListener('input', () => {
                         if (input.dataset.scienceType) {
                            const pIndex = input.dataset.playerIndex;
                            const simboli = { compasso: 0, tavoletta: 0, ingranaggio: 0, serie: 0 };
                            document.querySelectorAll(`input[data-player-index="${pIndex}"][data-science-type]`).forEach(i => {
                                simboli[i.dataset.scienceType] = parseInt(i.value) || 0;
                            });
                            document.getElementById(`anteprima-scienza-${pIndex}`).textContent = `(${calcolaPuntiScienzaOttimizzati(simboli)}pt)`;
                         }
                    });
                });

                bottoni.prevCat.disabled = index === 0;
                const isLastCategory = index === datiPartita.categoriePartita.length - 1;
                bottoni.nextCat.innerHTML = isLastCategory ? (datiPartita.hasCalculatedResults ? translations.recalculateResults[currentLanguage] : translations.seeResults[currentLanguage]) : `${translations.next[currentLanguage]} ‚Üí`;
            }

            function navigaCategorie(dir) {
                salvaPunteggiCategoriaCorrente();
                datiPartita.categoriaCorrenteIndex += dir;
                if (datiPartita.categoriaCorrenteIndex >= datiPartita.categoriePartita.length) {
                    datiPartita.categoriaCorrenteIndex = datiPartita.categoriePartita.length - 1;
                    mostraRisultati();
                } else {
                    mostraSchermataCategoria();
                }
            }

            function salvaPunteggiCategoriaCorrente() {
                const cat = datiPartita.categoriePartita[datiPartita.categoriaCorrenteIndex];
                if (!cat) return;
                
                if (cat.type === 'number') {
                    ui.inputsContainer.querySelectorAll('.punteggio-giocatore-riga input.input-punteggio').forEach(input => {
                        datiPartita.giocatori[parseInt(input.dataset.playerIndex)].punteggi[cat.key] = parseInt(input.value) || 0;
                    });
                } else if (cat.type === 'science') {
                     datiPartita.giocatori.forEach((g, pIndex) => {
                        const simboli = { compasso: 0, tavoletta: 0, ingranaggio: 0, serie: 0 };
                        document.querySelectorAll(`input[data-player-index="${pIndex}"][data-science-type]`).forEach(i => {
                            simboli[i.dataset.scienceType] = parseInt(i.value) || 0;
                        });
                        g.punteggi[cat.key] = simboli;
                    });
                } else if (cat.type === 'checkbox') {
                    const selectedCheck = ui.inputsContainer.querySelector(`input[name="cat-check-${cat.key}"]:checked`);
                    if (selectedCheck) {
                        datiPartita.giocatoreGattoIndex = parseInt(selectedCheck.value);
                    } else {
                        delete datiPartita.giocatoreGattoIndex;
                    }
                }
            }

            function calcolaPuntiScienza(simboli) {
                const t = simboli.tavoletta || 0;
                const i = simboli.ingranaggio || 0;
                const c = simboli.compasso || 0;
                return (t * t + i * i + c * c) + (Math.min(t, i, c) * 7);
            }

            function calcolaPuntiScienzaOttimizzati(simboli) {
                let { compasso, tavoletta, ingranaggio, serie } = simboli;
                if (!serie || serie === 0) return calcolaPuntiScienza(simboli);
                let c = compasso || 0,
                    t = tavoletta || 0,
                    i = ingranaggio || 0;
                for (let j = 0; j < serie; j++) {
                    const score_c = calcolaPuntiScienza({ compasso: c + 1, tavoletta: t, ingranaggio: i });
                    const score_t = calcolaPuntiScienza({ compasso: c, tavoletta: t + 1, ingranaggio: i });
                    const score_i = calcolaPuntiScienza({ compasso: c, tavoletta: t, ingranaggio: i + 1 });
                    if (score_c >= score_t && score_c >= score_i) {
                        c++;
                    } else if (score_t > score_c && score_t >= score_i) {
                        t++;
                    } else {
                        i++;
                    }
                }
                return calcolaPuntiScienza({ compasso: c, tavoletta: t, ingranaggio: i });
            }

            function mostraRisultati() {
                datiPartita.hasCalculatedResults = true;
                const dataPartita = datiPartita.manualDate ? new Date(datiPartita.manualDate) : new Date();
                const locale = currentLanguage === 'it' ? 'it-IT' : 'en-US';
                datiPartita.data = datiPartita.data || dataPartita.toLocaleString(locale, { day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit' });

                datiPartita.giocatori.forEach((g, index) => {
                    const p = g.punteggi;
                    let pTesoro = 0;
                    let pScienza = 0;
                    
                    if (datiPartita.gameVersion === 'architects') {
                        p.gatto = (datiPartita.giocatoreGattoIndex === index) ? 2 : 0;
                    }

                    if(datiPartita.gameVersion === '1ed' || datiPartita.gameVersion === '2ed'){
                        pTesoro = Math.floor(Math.max(0, p.tesoro || 0) / 3);
                        pScienza = p.scienza ? calcolaPuntiScienzaOttimizzati(p.scienza) : 0;
                        g.punteggi.puntiTesoro = pTesoro;
                        g.punteggi.puntiScienza = pScienza;
                    } else if (datiPartita.gameVersion === 'duel') {
                         pTesoro = Math.floor(Math.max(0, p.tesoro || 0) / 3);
                         g.punteggi.puntiTesoro = pTesoro;
                    }

                    let total = 0;
                    datiPartita.categoriePartita.forEach(cat => {
                        const key = cat.key;
                        if (key === 'tesoro' && (datiPartita.gameVersion === '1ed' || datiPartita.gameVersion === '2ed' || datiPartita.gameVersion === 'duel')) {
                            total += pTesoro;
                        } else if (key === 'scienza' && (datiPartita.gameVersion === '1ed' || datiPartita.gameVersion === '2ed')) {
                            // handled separately
                        } else if(key === 'wonderStages' && datiPartita.gameVersion === 'architects'){
                             // non-scoring, for tiebreak only
                        } else {
                            total += (p[key] || 0);
                        }
                    });

                    if(datiPartita.gameVersion === '1ed' || datiPartita.gameVersion === '2ed'){
                        total += pScienza;
                    }

                    g.totale = total;
                });

                const infoEl = document.createElement('div');
                infoEl.className = 'header-info';
                infoEl.innerHTML = `<span>${datiPartita.data}${datiPartita.luogo ? `, ${datiPartita.luogo}` : ''}</span>`;

                sezioni.risultati.innerHTML = '';
                sezioni.risultati.appendChild(infoEl);
                const titolo = document.createElement('h2');
                titolo.textContent = translations.finalRanking[currentLanguage];
                sezioni.risultati.appendChild(titolo);

                if (datiPartita.espansioni.giocoASquadre) {
                    mostraRisultatiSquadre();
                } else {
                    mostraRisultatiIndividuali();
                }

                const btnGroupTop = document.createElement('div');
                btnGroupTop.className = 'gruppo-bottoni';
                const backToScoreBtn = document.createElement('button');
                backToScoreBtn.textContent = translations.back[currentLanguage];
                backToScoreBtn.addEventListener('click', () => mostraSezione('punteggio'));
                const backToHomeBtn = document.createElement('button');
                backToHomeBtn.textContent = translations.backToHome[currentLanguage];
                backToHomeBtn.addEventListener('click', () => mostraSezione('landing'));
                btnGroupTop.appendChild(backToScoreBtn);
                btnGroupTop.appendChild(backToHomeBtn);
                sezioni.risultati.appendChild(btnGroupTop);

                const btnGroupBottom = document.createElement('div');
                btnGroupBottom.className = 'gruppo-bottoni';
                const shareBtn = document.createElement('button');
                shareBtn.textContent = translations.shareResults[currentLanguage];
                shareBtn.className = 'bottone-grande';
                shareBtn.addEventListener('click', condividiComeImmagine);
                const nuovaPartitaBtn = document.createElement('button');
                nuovaPartitaBtn.className = 'bottone-grande';
                nuovaPartitaBtn.textContent = translations.newGame[currentLanguage];
                nuovaPartitaBtn.addEventListener('click', () => {
                    const setupSection = `setup-${datiPartita.gameVersion}`;
                    mostraSezione(setupSection);
                });
                btnGroupBottom.appendChild(shareBtn);
                btnGroupBottom.appendChild(nuovaPartitaBtn);
                sezioni.risultati.appendChild(btnGroupBottom);

                mostraSezione('risultati');
            }

            function mostraRisultatiIndividuali() {
                let tieBreakerKey;
                if(datiPartita.gameVersion === 'architects') tieBreakerKey = 'wonderStages';
                else if (datiPartita.gameVersion === 'duel') tieBreakerKey = 'civili';
                else tieBreakerKey = 'tesoro';

                const giocatoriOrdinati = [...datiPartita.giocatori].sort((a, b) => {
                    if (b.totale !== a.totale) return b.totale - a.totale;
                    return (b.punteggi[tieBreakerKey] || 0) - (a.punteggi[tieBreakerKey] || 0);
                });
                
                const classificaUI = document.createElement('div');
                classificaUI.id = 'lista-classifica';
                const isWinner = giocatoriOrdinati.length < 2 || giocatoriOrdinati[0].totale > giocatoriOrdinati[1].totale || (giocatoriOrdinati[0].totale === giocatoriOrdinati[1].totale && (giocatoriOrdinati[0].punteggi[tieBreakerKey] || 0) > (giocatoriOrdinati[1].punteggi[tieBreakerKey] || 0));

                giocatoriOrdinati.forEach((g, index) => {
                    const li = document.createElement('div');
                    li.className = 'risultato-giocatore';
                    if (index === 0 && isWinner && !g.isFreeCity) li.classList.add('vincitore');
                    
                    const prevPlayer = giocatoriOrdinati[index - 1];
                    const nextPlayer = giocatoriOrdinati[index + 1];
                    const isTied = (prevPlayer && prevPlayer.totale === g.totale) || (nextPlayer && nextPlayer.totale === g.totale);
                    
                    let scoreDisplay = `<span class="punteggio-finale">${g.totale}</span>`;
                    if (isTied) {
                        let tieBreakerIcon;
                        if (tieBreakerKey === 'tesoro') tieBreakerIcon = 'üí∞';
                        else if (tieBreakerKey === 'wonderStages') tieBreakerIcon = 'üèóÔ∏è';
                        else if (tieBreakerKey === 'civili') tieBreakerIcon = 'üîµ';

                        scoreDisplay = `<span class="punteggio-finale">${g.totale}<span class="tie-breaker">(${(g.punteggi[tieBreakerKey] || 0)}${tieBreakerIcon})</span></span>`;
                    }
                    
                    let wonderDisplayHTML = '';
                    if (datiPartita.gameVersion === 'duel' && g.meraviglie && g.meraviglie.length > 0) {
                        wonderDisplayHTML = `<span class="wonder-display wonder-display-duel">${g.meraviglie.map(w => getWonderName(w) || '').join('<br>')}</span>`;
                    } else {
                        wonderDisplayHTML = `<span class="wonder-display">${getWonderName(g.meraviglia) || translations.noWonder[currentLanguage]}</span>`;
                    }
                    
                    li.innerHTML = `<div class="risultato-header"><div><span class="medaglia">${(index === 0 && isWinner && !g.isFreeCity) ? 'ü•á' : `${index + 1}.`}</span><div class="nome"><span>${g.nome}</span>${wonderDisplayHTML}</div></div>${scoreDisplay}</div>`;
                    li.appendChild(createBreakdownDiv(g));
                    classificaUI.appendChild(li);
                });
                sezioni.risultati.appendChild(classificaUI);
            }

            function mostraRisultatiSquadre() {
                const squadreMap = datiPartita.giocatori.reduce((acc, g) => {
                    if (!acc[g.team]) acc[g.team] = { nome: `${translations.team[currentLanguage]} ${g.team}`, giocatori: [], punteggi: {}, totale: 0 };
                    acc[g.team].giocatori.push(g);
                    return acc;
                }, {});
                const squadre = Object.values(squadreMap);
                squadre.forEach(s => {
                    s.totale = s.giocatori.reduce((acc, g) => acc + g.totale, 0);
                    datiPartita.categoriePartita.forEach(cat => {
                        const key = cat.key;
                        if (key === 'scienza') {
                            s.punteggi.puntiScienza = s.giocatori.reduce((acc, g) => acc + (g.punteggi.puntiScienza || 0), 0);
                        } else if (key === 'tesoro') {
                            s.punteggi.puntiTesoro = s.giocatori.reduce((acc, g) => acc + (g.punteggi.puntiTesoro || 0), 0);
                            s.punteggi[key] = s.giocatori.reduce((acc, g) => acc + (g.punteggi[key] || 0), 0);
                        } else {
                            s.punteggi[key] = s.giocatori.reduce((acc, g) => acc + (g.punteggi[key] || 0), 0);
                        }
                    });
                });
                squadre.sort((a, b) => b.totale !== a.totale ? b.totale - a.totale : (b.punteggi.tesoro || 0) - (a.punteggi.tesoro || 0));
                const classificaUI = document.createElement('div');
                classificaUI.id = 'lista-classifica';

                const isWinner = squadre.length < 2 || squadre[0].totale > squadre[1].totale || (squadre[0].totale === squadre[1].totale && squadre[0].punteggi.tesoro > squadre[1].punteggi.tesoro);

                squadre.forEach((s, index) => {
                    const teamEl = document.createElement('div');
                    teamEl.className = 'risultato-squadra';
                    if (index === 0 && isWinner) teamEl.classList.add('vincitore');

                    const teamBreakdown = createBreakdownDiv(s);
                    const teamPlayersDetails = document.createElement('div');
                    teamPlayersDetails.className = 'dettaglio-squadra';
                    s.giocatori.sort((a, b) => b.totale - a.totale).forEach(g => {
                        const playerDetailEl = document.createElement('div');
                        playerDetailEl.className = 'dettaglio-giocatore-individuale';
                        const playerBreakdown = createBreakdownDiv(g);
                        playerDetailEl.innerHTML = `<div class="risultato-header"><div class="nome"><span>${g.nome}</span><span class="wonder-display">${getWonderName(g.meraviglia) || translations.noWonder[currentLanguage]}</span></div><span class="punteggio-finale">${g.totale}</span></div>`;
                        playerDetailEl.appendChild(playerBreakdown);
                        teamPlayersDetails.appendChild(playerDetailEl);
                    });

                    const prevTeam = squadre[index - 1];
                    const nextTeam = squadre[index + 1];
                    const isTied = (prevTeam && prevTeam.totale === s.totale) || (nextTeam && nextTeam.totale === s.totale);
                    let scoreDisplay = `<span class="punteggio-finale">${s.totale}</span>`;
                    if (isTied) scoreDisplay = `<span class="punteggio-finale">${s.totale}<span class="tie-breaker">(${(s.punteggi.tesoro || 0)}üí∞)</span></span>`;

                    teamEl.innerHTML = `<div class="risultato-header"><div><span class="medaglia">${(index === 0 && isWinner) ? 'ü•á' : `${index + 1}.`}</span><span class="nome">${s.nome}</span></div>${scoreDisplay}</div>`;
                    teamEl.appendChild(teamBreakdown);
                    teamEl.appendChild(teamPlayersDetails);
                    classificaUI.appendChild(teamEl);
                });
                sezioni.risultati.appendChild(classificaUI);
            }

            function createBreakdownDiv(entity) {
                const div = document.createElement('div');
                div.className = 'risultato-breakdown';
                datiPartita.categoriePartita.forEach(cat => {
                    if (cat.key === 'wonderStages') return;
                    let pCat;
                    if (cat.key === 'scienza' && datiPartita.gameVersion !== 'architects') {
                        pCat = entity.punteggi.puntiScienza || 0;
                    } else if (cat.key === 'tesoro' && datiPartita.gameVersion !== 'duel') {
                        pCat = entity.punteggi.puntiTesoro || 0;
                    } else {
                        pCat = entity.punteggi[cat.key] || 0;
                    }

                    if (datiPartita.gameVersion === '2ed' && pCat === 0 && cat.key !== 'tesoro') {
                        return; 
                    }

                    const firstSpaceIndex = cat.label.indexOf(' ');
                    const icon = cat.label.substring(0, firstSpaceIndex);
                    const name = translations[cat.langKey][currentLanguage];
                    div.innerHTML += `<span class="breakdown-item" title="${name}">${icon} ${pCat}</span>`;
                });
                return div;
            }

            function condividiComeImmagine() {
                const shareableContent = document.createElement('div');
                shareableContent.style.width = '450px';
                shareableContent.style.padding = '30px';
                shareableContent.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--colore-sfondo');
                shareableContent.style.fontFamily = "'Roboto', sans-serif";
                shareableContent.style.color = getComputedStyle(document.documentElement).getPropertyValue('--colore-testo');
                shareableContent.style.boxSizing = 'border-box';

                let logoSrc;
                switch(datiPartita.gameVersion){
                    case '1ed': logoSrc = 'https://i.postimg.cc/8zKZnZ89/pngegg.png'; break;
                    case '2ed': logoSrc = 'https://i.imgur.com/p1PgYrh.png'; break;
                    case 'architects': logoSrc = 'https://i.postimg.cc/mgqzt9fK/arc-common-logo-1630334595b-VXy-Z-large.png'; break;
                    case 'duel': logoSrc = 'https://i.postimg.cc/vmV19mGT/7WDuel.png'; break;
                    default: logoSrc = 'https://i.imgur.com/p1PgYrh.png';
                }
                
                const logo = document.createElement('img');
                logo.src = logoSrc;
                logo.style.maxWidth = '60%';
                logo.style.margin = '0 auto 30px auto';
                logo.style.display = 'block';

                const results = document.getElementById('risultati-sezione').cloneNode(true);
                results.querySelectorAll('.gruppo-bottoni, button, .header-info ~ h2 + button').forEach(el => el.remove());
                results.querySelector('.header-info').style.fontSize = '1em';
                results.querySelector('.header-info').style.marginBottom = '15px';

                shareableContent.appendChild(logo);
                shareableContent.appendChild(results);

                document.body.appendChild(shareableContent);

                html2canvas(shareableContent, {
                    scale: 2.5,
                    backgroundColor: null,
                    useCORS: true
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `7wonders-results-${Date.now()}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    document.body.removeChild(shareableContent);
                }).catch(err => {
                    console.error("Error generating image:", err);
                    document.body.removeChild(shareableContent);
                });
            }

            function setupCollapsibleRules() {
                document.querySelectorAll('.collapsible-header').forEach(header => {
                    header.addEventListener('click', () => {
                        header.classList.toggle('active');
                        const icon = header.querySelector('.toggle-icon');
                        const content = header.nextElementSibling;

                        if (content.style.maxHeight) {
                            content.style.maxHeight = null;
                            content.style.marginBottom = "0";
                            icon.textContent = 'Ôºã';
                        } else {
                            content.style.maxHeight = content.scrollHeight + "px";
                            content.style.marginBottom = "10px";
                            icon.textContent = '‚àí';
                        }
                    });
                });
            }
            
            // ===============================================
            // H. INITIALIZATION
            // ===============================================
            
            function inizializzaApp() {
                initializeTranslations();
                mostraSezione('landing');
                setupCollapsibleRules();
                addEventListeners();
            }

            function addEventListeners() {
                bottoni.nuovaPartitaLanding.addEventListener('click', () => mostraSezione('selezioneGioco'));
                bottoni.regolamentoLanding.addEventListener('click', () => mostraSezione('regolamento'));
                bottoni.backToHomeFromRules.addEventListener('click', () => mostraSezione('landing'));
                bottoni.backToHomeFromGameSelect.addEventListener('click', () => mostraSezione('landing'));
                
                document.querySelectorAll('.back-to-game-select').forEach(btn => {
                    btn.addEventListener('click', () => mostraSezione('selezioneGioco'));
                });

                bottoni.selectGame1ed.addEventListener('click', () => { resetStato('1ed'); updateExpansions_1ed(); aggiornaListaGiocatoriUI_1ed(); mostraSezione('setup-1ed'); });
                bottoni.selectGame2ed.addEventListener('click', () => { resetStato('2ed'); updateExpansions_2ed(); aggiornaListaGiocatoriUI_2ed(); mostraSezione('setup-2ed'); });
                bottoni.selectGameArchitects.addEventListener('click', () => { resetStato('architects'); aggiornaListaGiocatoriUI_architects(); mostraSezione('setup-architects');});
                bottoni.selectGameDuel.addEventListener('click', () => { resetStato('duel'); aggiornaListaGiocatoriUI_duel(); mostraSezione('setup-duel');});
                
                // 1st Edition Setup Listeners
                setup1ed.bottoni.aggiungiGiocatore.addEventListener('click', aggiungiGiocatore_1ed);
                setup1ed.inputs.nomeGiocatore.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); aggiungiGiocatore_1ed(); } });
                setup1ed.bottoni.iniziaPartita.addEventListener('click', () => { if (!setup1ed.bottoni.iniziaPartita.disabled) avviaPartita_1ed(); });
                setup1ed.bottoni.randomWonder.addEventListener('click', assegnaMeraviglieCasuali_1ed);
                [...Object.values(setup1ed.inputs.esp), setup1ed.inputs.teamPlay].forEach(el => el.addEventListener('change', () => {
                    aggiornaListaGiocatoriUI_1ed();
                }));
                 setup1ed.inputs.dateToggle.addEventListener('change', () => {
                     setup1ed.ui.manualDateContainer.classList.toggle('hidden', !setup1ed.inputs.dateToggle.checked);
                });


                // 2nd Edition Setup Listeners
                setup2ed.bottoni.aggiungiGiocatore.addEventListener('click', aggiungiGiocatore_2ed);
                setup2ed.inputs.nomeGiocatore.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); aggiungiGiocatore_2ed(); } });
                setup2ed.bottoni.iniziaPartita.addEventListener('click', () => { if (!setup2ed.bottoni.iniziaPartita.disabled) avviaPartita_2ed(); });
                setup2ed.bottoni.randomWonder.addEventListener('click', assegnaMeraviglieCasuali_2ed);
                [...Object.values(setup2ed.inputs.esp), setup2ed.inputs.teamPlay, setup2ed.inputs.dateToggle].forEach(el => el.addEventListener('change', () => {
                    setup2ed.ui.manualDateContainer.classList.toggle('hidden', !setup2ed.inputs.dateToggle.checked);
                    aggiornaListaGiocatoriUI_2ed();
                }));
                
                // Architects Setup Listeners
                setupArchitects.bottoni.aggiungiGiocatore.addEventListener('click', aggiungiGiocatore_architects);
                setupArchitects.inputs.nomeGiocatore.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); aggiungiGiocatore_architects(); } });
                setupArchitects.bottoni.iniziaPartita.addEventListener('click', () => { if (!setupArchitects.bottoni.iniziaPartita.disabled) avviaPartita_architects(); });
                setupArchitects.bottoni.randomWonder.addEventListener('click', assegnaMeraviglieCasuali_architects);
                setupArchitects.inputs.esp.medals.addEventListener('change', () => aggiornaListaGiocatoriUI_architects());
                setupArchitects.inputs.dateToggle.addEventListener('change', () => {
                     setupArchitects.ui.manualDateContainer.classList.toggle('hidden', !setupArchitects.inputs.dateToggle.checked);
                });
                
                // Duel Setup Listeners
                setupDuel.bottoni.aggiungiGiocatore.addEventListener('click', aggiungiGiocatore_duel);
                setupDuel.inputs.nomeGiocatore.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); aggiungiGiocatore_duel(); } });
                setupDuel.bottoni.iniziaPartita.addEventListener('click', () => { if (!setupDuel.bottoni.iniziaPartita.disabled) avviaPartita_duel(); });
                setupDuel.bottoni.randomWonder.addEventListener('click', assegnaMeraviglieCasuali_duel);
                [...Object.values(setupDuel.inputs.esp)].forEach(el => el.addEventListener('change', () => {
                    updateExpansions_duel();
                    aggiornaBottoniVittoriaIstantanea_duel();
                    aggiornaListaGiocatoriUI_duel();
                }));
                 setupDuel.inputs.dateToggle.addEventListener('change', () => {
                     setupDuel.ui.manualDateContainer.classList.toggle('hidden', !setupDuel.inputs.dateToggle.checked);
                });


                // Scoring Navigation Listeners
                bottoni.nextCat.addEventListener('click', () => navigaCategorie(1));
                bottoni.prevCat.addEventListener('click', () => { salvaPunteggiCategoriaCorrente(); datiPartita.categoriaCorrenteIndex -= 1; mostraSchermataCategoria(); });
                bottoni.backToSetup.addEventListener('click', () => { 
                    salvaPunteggiCategoriaCorrente(); 
                    mostraSezione(`setup-${datiPartita.gameVersion}`);
                });
                
                // Language Listeners
                bottoni.langIt.addEventListener('click', () => setLanguage('it'));
                bottoni.langEn.addEventListener('click', () => setLanguage('en'));
            }

            inizializzaApp();
            setLanguage(currentLanguage);
        });
    </script>
</body>
</html>
