<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Segnapunti 7 Wonders</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

        :root {
            --colore-primario: #3a5a78; --colore-secondario: #d4ac6e; --colore-sfondo: #1e1e1e;
            --colore-superficie: #2d2d2d; --colore-testo: #f0f0f0; --colore-testo-fioco: #a0a0a0;
            --colore-successo: #6aab75; --colore-pericolo: #c86c6c; --colore-oro: #ffd700;
            --colore-argento: #c0c0c0; --colore-bronzo: #cd7f32;
        }

        body { font-family: 'Roboto', sans-serif; background-color: var(--colore-sfondo); color: var(--colore-testo); margin: 0; padding: 20px; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
        main { width: 100%; max-width: 550px; background-color: var(--colore-superficie); padding: 25px 30px; border-radius: 12px; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2); box-sizing: border-box; }
        #logo { display: block; margin: 0 auto 25px auto; max-width: 80%; height: auto; }
        h2, h3 { border-bottom: 2px solid var(--colore-primario); padding-bottom: 10px; margin-bottom: 20px; }
        
        section { transition: opacity 0.3s ease-in-out; }
        
        /* Landing Page */
        #landing-sezione .gruppo-bottoni { flex-direction: column; }

        /* Setup */
        #player-header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--colore-primario); margin-bottom: 20px; }
        #player-header h3 { border-bottom: none; margin-bottom: 0; padding-bottom: 10px; }
        #player-header .header-options { display: flex; align-items: center; gap: 15px; }
        #player-header .checkbox-item { margin-bottom: 10px; font-size: 0.8em; }
        .form-group { display: flex; gap: 10px; margin-bottom: 25px; }
        #aggiungi-giocatore-form { flex-direction: column; }
        #nomeGiocatoreInput, #luogoPartitaInput { width: 100%; padding: 12px; border: 1px solid #444; border-radius: 8px; background-color: #333; color: var(--colore-testo); font-size: 16px; box-sizing: border-box; }
        #listaGiocatori { list-style: none; padding: 0; }
        .giocatore-setup-item { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 10px; background-color: #383838; padding: 10px 15px; border-radius: 6px; margin-bottom: 8px; font-size: 18px; }
        .nome-giocatore-input { background: none; border: none; color: var(--colore-testo); font-weight: bold; font-size: 18px; font-family: 'Roboto', sans-serif; flex-grow: 1; padding: 5px; border-radius: 4px; }
        .nome-giocatore-input:focus { outline: none; background-color: rgba(255, 255, 255, 0.1); }
        .delete-player-btn { background: none; border: none; color: var(--colore-pericolo); font-size: 20px; cursor: pointer; padding: 0 5px; line-height: 1; }
        .wonder-select, .team-select { background-color: #444; color: var(--colore-testo); border: 1px solid #555; border-radius: 5px; padding: 8px; font-size: 14px; flex-shrink: 0; }
        .opzioni-partita { margin-top: 20px; padding: 15px; background-color: #383838; border-radius: 8px;}
        .opzioni-partita h4 { margin-top: 0; margin-bottom: 10px; }
        .checkbox-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .checkbox-item { display: flex; align-items: center; justify-content: space-between; }
        
        /* Toggle Switch Styles */
        .toggle-switch { position: relative; display: inline-block; width: 51px; height: 31px; flex-shrink: 0;}
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 31px; }
        .slider:before { position: absolute; content: ""; height: 23px; width: 23px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--colore-successo); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Punteggio */
        #punteggio-sezione h2 { text-align: center; color: white; border: none; padding: 10px 15px; border-radius: 8px; transition: background-color 0.4s ease; }
        #punteggio-inputs-container { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        .punteggio-giocatore-riga { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 15px; }
        .punteggio-giocatore-riga label { font-size: 18px; }
        .input-stepper { display: flex; align-items: center; justify-content: flex-end; gap: 8px; }
        .stepper-btn { font-size: 20px; width: 40px; height: 40px; text-align: center; padding: 0; line-height: 40px; flex-shrink: 0; }
        .input-punteggio { padding: 12px; border: 1px solid #444; border-radius: 8px; background-color: #333; color: var(--colore-testo); font-size: 18px; width: 60px; box-sizing: border-box; text-align: center; }
        .science-input-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .science-icon-grid { display: grid; grid-template-columns: 1fr repeat(4, 1fr); gap: 10px; align-items: end; margin-bottom: 8px; }
        .science-icon { max-height: 30px; margin: auto; display: block; }
        #avviso-categoria { font-size: 0.9em; text-align: center; color: var(--colore-testo-fioco); background: #222; padding: 8px; border-radius: 5px; margin-bottom: 15px; }
        #science-grid-container { display: grid; grid-template-columns: 1fr auto; gap: 15px; align-items: center;}
        #science-grid-container .science-input-grid { flex-grow: 1; }
        
        /* Risultati */
        .header-info { text-align: right; font-size: 0.8em; color: var(--colore-testo-fioco); margin-bottom: -10px; margin-top: -10px; }
        #lista-classifica { list-style: none; padding: 0; margin-bottom: 30px; }
        .risultato-giocatore, .risultato-squadra { padding: 15px; margin-bottom: 10px; background-color: #383838; border-radius: 8px; }
        .risultato-header { display: flex; justify-content: space-between; align-items: center; font-size: 20px; }
        .nome { font-weight: bold; display: flex; flex-direction: column; align-items: flex-start; }
        .wonder-display { font-style: italic; font-weight: normal; font-size: 0.7em; color: var(--colore-testo-fioco); margin-top: 2px; }
        .punteggio-finale { font-weight: bold; background-color: var(--colore-primario); padding: 5px 12px; border-radius: 6px; color: white; }
        .medaglia { margin-right: 15px; font-size: 24px; }
        .risultato-squadra.vincitore .nome, .risultato-giocatore.vincitore .nome { color: var(--colore-oro); }
        .tie-breaker { font-size: 0.7em; font-weight: normal; color: var(--colore-testo-fioco); margin-left: 5px; }
        .risultato-breakdown { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #444; }
        .breakdown-item { background-color: #2c2c2c; padding: 4px 8px; border-radius: 5px; font-size: 14px; cursor: help; }
        .dettaglio-squadra { margin-top: 15px; padding-top: 15px; border-top: 1px solid #444; font-size: 0.9em; display: flex; flex-direction: column; gap: 15px; }
        .dettaglio-giocatore-individuale { background-color: #2c2c2c; padding: 10px; border-radius: 6px; }
        .dettaglio-giocatore-individuale .risultato-header { font-size: 16px; }
        .dettaglio-giocatore-individuale .risultato-breakdown { font-size: 12px; margin-top: 10px; padding-top: 10px; gap: 8px; }

        /* Bottoni */
        button { padding: 12px 20px; border: none; border-radius: 8px; background-color: var(--colore-primario); color: white; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.2s, transform 0.1s; }
        button:hover { filter: brightness(1.15); }
        button:active { transform: scale(0.98); }
        button:disabled { background-color: #555; color: #999; cursor: not-allowed; filter: none; }
        .bottone-grande { width: 100%; padding: 15px; margin-top: 10px; }
        .gruppo-bottoni { display: flex; gap: 10px; margin-top: 20px; }
        .gruppo-bottoni .bottone-grande { flex: 1; width: auto; font-size: 14px; padding: 12px 5px; }
        #nav-punteggio { justify-content: space-between; }
        #iniziaPartitaBtn, #nuovaPartitaBtn { background-color: var(--colore-secondario); color: #111; }
        #nextCatBtn { background-color: var(--colore-successo); }
        #randomWonderBtn { padding: 8px 12px; font-size: 16px; flex-shrink: 0; }
        .hidden { display: none !important; }

        @media (max-width: 480px) {
            main { padding: 20px 15px; }
            .gruppo-bottoni { flex-wrap: wrap; }
            .punteggio-giocatore-riga { grid-template-columns: 1fr; gap: 5px; }
            .punteggio-giocatore-riga label { text-align: left; }
            .input-stepper { justify-content: flex-start; }
            .science-input-grid { grid-template-columns: 1fr 1fr; }
            .checkbox-container { gap: 10px; }
            .checkbox-item { flex-direction: column; align-items: flex-start; gap: 8px; }
            #player-header { flex-direction: column; align-items: flex-start; }
            #player-header .header-options { width: 100%; justify-content: space-between; }
            #player-header .checkbox-item { flex-direction: row; gap: 10px; }
        }
    </style>
</head>
<body>
    <main>
        <img id="logo" src="https://i.imgur.com/p1PgYrh.png" alt="Logo 7 Wonders">

        <section id="landing-sezione">
            <div class="gruppo-bottoni">
                <button id="landingNuovaPartitaBtn" class="bottone-grande">Inizia Nuova Partita</button>
            </div>
        </section>

        <section id="setup-sezione" class="hidden">
            <h2>Imposta Partita</h2>
            <div class="form-group" style="flex-direction: column;">
                <input type="text" id="nomeGiocatoreInput" placeholder="Nome giocatore...">
                <button id="aggiungiGiocatoreBtn">Aggiungi</button>
            </div>
            <div id="player-header">
                <h3>Giocatori e Meraviglie</h3>
                <div class="header-options">
                     <div class="checkbox-item hidden" id="team-play-container">
                        <label for="team-play-checkbox" style="font-size:1em;">Partita a squadre</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="team-play-checkbox">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <button id="randomWonderBtn">Meraviglie casuali 🔀</button>
                </div>
            </div>
            <ul id="listaGiocatori"></ul>
             <div class="opzioni-partita">
                <h4>Espansioni</h4>
                <div class="checkbox-container">
                    <div class="checkbox-item"><label for="esp-cities">Cities</label><label class="toggle-switch"><input type="checkbox" id="esp-cities"><span class="slider"></span></label></div>
                    <div class="checkbox-item"><label for="esp-leaders">Leaders</label><label class="toggle-switch"><input type="checkbox" id="esp-leaders"><span class="slider"></span></label></div>
                    <div class="checkbox-item"><label for="esp-armada">Armada</label><label class="toggle-switch"><input type="checkbox" id="esp-armada"><span class="slider"></span></label></div>
                    <div class="checkbox-item"><label for="esp-edifice">Edifice</label><label class="toggle-switch"><input type="checkbox" id="esp-edifice"><span class="slider"></span></label></div>
                </div>
            </div>
            <div class="opzioni-partita">
                <h4>Luogo</h4>
                <div class="form-group" style="margin-bottom: 0;">
                     <input type="text" id="luogoPartitaInput" placeholder="Luogo della partita...">
                </div>
            </div>
            <div class="opzioni-partita">
                <h4>Data e ora</h4>
                <div class="checkbox-item">
                    <label for="date-toggle">Usa data e ora manuale</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="date-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="form-group hidden" id="manual-date-container" style="margin-top: 15px; margin-bottom: 0;">
                    <input type="datetime-local" id="manual-date-input" class="input-punteggio">
                </div>
            </div>
            <div class="gruppo-bottoni">
                <button id="backToHomeFromSetupBtn">Torna alla Home</button>
                <button id="resetSettingsBtn">Reset</button>
                <button id="iniziaPartitaBtn" class="bottone-grande" disabled>Inizia</button>
            </div>
        </section>

        <section id="punteggio-sezione" class="hidden">
            <h2 id="titolo-categoria-punteggio"></h2>
            <div id="punteggio-inputs-container"></div>
            <div class="gruppo-bottoni" id="nav-punteggio">
                <button id="backToSetupBtn">Torna al Setup</button>
                <button id="prevCatBtn">← Indietro</button>
                <button id="nextCatBtn">Avanti →</button>
            </div>
        </section>

        <section id="risultati-sezione" class="hidden"></section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const MERAVIGLIE = { base: ['Halikarnassos', 'Rhódos', 'Olympía', 'Alexandria', 'Babylon', 'Éphesos', 'Gizah', 'Manneken Pis', 'Grande Muraglia Cinese'], leaders: ['Roma', 'Abu Simbel'], cities: ['Byzantium', 'Petra'], armada: ['Siracusa'], edifice: ['Ur', 'Carthage'] };
            const CATEGORIE = [
                { key: 'meraviglia', label: '🏛️ Meraviglia', type: 'number', color: '#7f8c8d' },
                { key: 'tesoro', label: '💰 Tesoro', type: 'number', color: '#f1c40f' },
                { key: 'debiti', label: '💸 Debiti', type: 'number', expansion: 'cities', color: '#c0392b' },
                { key: 'militari', label: '⚔️ Conflitti Militari', type: 'number', color: '#c0392b' },
                { key: 'civili', label: '🔵 Edifici Civili', type: 'number', color: '#2980b9' },
                { key: 'commerciali', label: '🟡 Edifici Commerciali', type: 'number', color: '#f1c40f' },
                { key: 'scienza', label: '🟢 Edifici Scientifici', type: 'science', color: '#27ae60' },
                { key: 'gilde', label: '🟣 Gilde', type: 'number', color: '#8e44ad' },
                { key: 'cities', label: '⚫ Cities', type: 'number', expansion: 'cities', color: '#34495e' },
                { key: 'leaders', label: '👑 Leader', type: 'number', expansion: 'leaders', color: '#bdc3c7' },
                { key: 'conflittiNavali', label: '⚓ Conflitti Navali', type: 'number', expansion: 'armada', color: '#3498db' },
                { key: 'percorsoMarittimo', label: '🗺️ Percorso Navale Blu', type: 'number', expansion: 'armada', color: '#3498db' },
                { key: 'isole', label: '🏝️ Isole', type: 'number', expansion: 'armada', color: '#16a085' },
                { key: 'edifice', label: '🏗️ Edifici', type: 'number', expansion: 'edifice', color: '#d35400' },
            ];
            const CATEGORIE_NEGATIVE_PERMESSE = ['militari', 'debiti', 'conflittiNavali'];
            
            const sezioni = { landing: document.getElementById('landing-sezione'), setup: document.getElementById('setup-sezione'), punteggio: document.getElementById('punteggio-sezione'), risultati: document.getElementById('risultati-sezione')};
            const inputs = { nomeGiocatore: document.getElementById('nomeGiocatoreInput'), luogoPartita: document.getElementById('luogoPartitaInput'), esp: { cities: document.getElementById('esp-cities'), leaders: document.getElementById('esp-leaders'), armada: document.getElementById('esp-armada'), edifice: document.getElementById('esp-edifice') }, teamPlay: document.getElementById('team-play-checkbox'), dateToggle: document.getElementById('date-toggle'), manualDateInput: document.getElementById('manual-date-input') };
            const bottoni = {
                aggiungiGiocatore: document.getElementById('aggiungiGiocatoreBtn'), iniziaPartita: document.getElementById('iniziaPartitaBtn'),
                nuovaPartitaLanding: document.getElementById('landingNuovaPartitaBtn'),
                prevCat: document.getElementById('prevCatBtn'), nextCat: document.getElementById('nextCatBtn'),
                randomWonder: document.getElementById('randomWonderBtn'), backToSetup: document.getElementById('backToSetupBtn'),
                resetSettings: document.getElementById('resetSettingsBtn'),
                backToHomeFromSetup: document.getElementById('backToHomeFromSetupBtn'),
            };
            const ui = { listaGiocatori: document.getElementById('listaGiocatori'), titoloCategoria: document.getElementById('titolo-categoria-punteggio'), inputsContainer: document.getElementById('punteggio-inputs-container'), teamPlayContainer: document.getElementById('team-play-container') };
            let datiPartita;

            function mostraSezione(nomeSezione) { for (const key in sezioni) { sezioni[key].classList.toggle('hidden', key !== nomeSezione); } }
            function resetStato() { datiPartita = { giocatori: [], categoriaCorrenteIndex: 0, categoriePartita: [], espansioni: {}, idPartita: Date.now() }; }
            function getWondersDisponibili() { let w = [...MERAVIGLIE.base]; if (inputs.esp.leaders.checked) w.push(...MERAVIGLIE.leaders); if (inputs.esp.cities.checked) w.push(...MERAVIGLIE.cities); if (inputs.esp.armada.checked) w.push(...MERAVIGLIE.armada); if (inputs.esp.edifice.checked) w.push(...MERAVIGLIE.edifice); return w.sort(); }

            function aggiornaListaGiocatoriUI() {
                ui.listaGiocatori.innerHTML = '';
                const wondersDisponibili = getWondersDisponibili();
                const teamPlayActive = inputs.teamPlay.checked;
                datiPartita.giocatori.forEach((g, index) => {
                    const li = document.createElement('li'); li.className = 'giocatore-setup-item';
                    
                    const nomeInput = document.createElement('input');
                    nomeInput.type = 'text'; nomeInput.className = 'nome-giocatore-input';
                    nomeInput.value = g.nome; nomeInput.dataset.index = index;
                    nomeInput.addEventListener('input', (e) => { datiPartita.giocatori[index].nome = e.target.value; });
                    li.appendChild(nomeInput);

                    if(teamPlayActive) {
                        const teamSelect = document.createElement('select'); teamSelect.className = 'team-select';
                        const teamOptions = datiPartita.giocatori.length === 4 ? ['A', 'B'] : ['A', 'B', 'C'];
                        teamSelect.innerHTML = teamOptions.map(t => `<option value="${t}" ${g.team === t ? 'selected' : ''}>Squadra ${t}</option>`).join('');
                        teamSelect.addEventListener('change', (e) => { g.team = e.target.value; });
                        li.appendChild(teamSelect);
                    }
                    const selectEl = document.createElement('select'); selectEl.className = 'wonder-select'; selectEl.innerHTML = `<option value="">Scegli Meraviglia</option>`;
                    wondersDisponibili.forEach(w => { const o = document.createElement('option'); o.value = w; o.textContent = w; if (g.meraviglia === w) o.selected = true; selectEl.appendChild(o); });
                    selectEl.addEventListener('change', (e) => { g.meraviglia = e.target.value; });
                    li.appendChild(selectEl); 
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-player-btn'; deleteBtn.innerHTML = '&#10006;';
                    deleteBtn.title = 'Elimina giocatore';
                    deleteBtn.addEventListener('click', () => {
                        datiPartita.giocatori.splice(index, 1);
                        aggiornaListaGiocatoriUI();
                    });
                    li.appendChild(deleteBtn);

                    ui.listaGiocatori.appendChild(li);
                });
                const num = datiPartita.giocatori.length;
                bottoni.iniziaPartita.disabled = num < 3;
                const canPlayTeams = num === 4 || num === 6;
                ui.teamPlayContainer.classList.toggle('hidden', !canPlayTeams);
                if (!canPlayTeams) inputs.teamPlay.checked = false;
            }

            function aggiungiGiocatore() {
                const nome = inputs.nomeGiocatore.value.trim();
                if (nome && datiPartita.giocatori.length < 7) {
                    datiPartita.giocatori.push({ nome, meraviglia: '', team: 'A', punteggi: {}, totale: 0 });
                    inputs.nomeGiocatore.value = '';
                    aggiornaListaGiocatoriUI();
                    inputs.nomeGiocatore.focus();
                }
            }

            function assegnaMeraviglieCasuali() {
                const numGiocatori = datiPartita.giocatori.length; if (numGiocatori === 0) return;
                let wonders = getWondersDisponibili();
                if (wonders.length < numGiocatori) { alert("Non ci sono abbastanza meraviglie uniche per tutti i giocatori."); return; }
                for (let i = wonders.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [wonders[i], wonders[j]] = [wonders[j], wonders[i]]; }
                datiPartita.giocatori.forEach((g, i) => { g.meraviglia = wonders[i]; });
                aggiornaListaGiocatoriUI();
            }

            function avviaPartita() {
                for (const key in inputs.esp) datiPartita.espansioni[key] = inputs.esp[key].checked;
                datiPartita.espansioni.giocoASquadre = inputs.teamPlay.checked;
                datiPartita.luogo = inputs.luogoPartita.value.trim();
                datiPartita.manualDate = inputs.dateToggle.checked ? inputs.manualDateInput.value : null;
                datiPartita.categoriePartita = CATEGORIE.filter(cat => !cat.expansion || datiPartita.espansioni[cat.expansion]);
                if (!datiPartita.hasCalculatedResults) {
                    datiPartita.categoriaCorrenteIndex = 0;
                } else if (datiPartita.categoriaCorrenteIndex >= datiPartita.categoriePartita.length) {
                    datiPartita.categoriaCorrenteIndex = datiPartita.categoriePartita.length -1;
                }
                mostraSezione('punteggio');
                mostraSchermataCategoria();
            }

            function mostraSchermataCategoria() {
                const index = datiPartita.categoriaCorrenteIndex; const categoria = datiPartita.categoriePartita[index];
                if (!categoria) return; 
                ui.titoloCategoria.innerHTML = categoria.label;
                ui.titoloCategoria.style.backgroundColor = categoria.color || 'transparent';
                ui.inputsContainer.innerHTML = '';
                if (categoria.key === 'gilde' && datiPartita.espansioni.armada) {
                    const avviso = document.createElement('div'); avviso.id = 'avviso-categoria';
                    avviso.textContent = 'Attenzione: con l\'espansione Armada ogni Gilda può valere un massimo di 10 punti vittoria.';
                    ui.inputsContainer.appendChild(avviso);
                }
                if (categoria.type === 'science') {
                    const iconHeader = document.createElement('div');
                    iconHeader.className = 'science-icon-grid';
                    iconHeader.innerHTML = `<div></div>
                                            <div><img src="https://i.postimg.cc/y6gd7hgg/compasso.png" class="science-icon" alt="Compasso"></div>
                                            <div><img src="https://i.postimg.cc/7b8j4rCV/tavoletta.png" class="science-icon" alt="Tavoletta"></div>
                                            <div><img src="https://i.postimg.cc/C12WvqS9/ingranaggio.png" class="science-icon" alt="Ingranaggio"></div>
                                            <div><img src="https://i.postimg.cc/43WC90Mf/serie.png" class="science-icon" alt="Serie"></div>`;
                     ui.inputsContainer.appendChild(iconHeader);
                }

                datiPartita.giocatori.forEach((giocatore, playerIndex) => {
                    const riga = document.createElement('div');
                    const minAttribute = CATEGORIE_NEGATIVE_PERMESSE.includes(categoria.key) ? '' : 'min="0"';

                    if (categoria.type === 'number') {
                        riga.className = 'punteggio-giocatore-riga';
                        riga.innerHTML = `<label for="p-cat-${playerIndex}">${giocatore.nome}</label>
                                        <div class="input-stepper">
                                            <button class="stepper-btn" data-player-index="${playerIndex}" data-step="-1">-</button>
                                            <input type="number" id="p-cat-${playerIndex}" class="input-punteggio" data-player-index="${playerIndex}" value="${giocatore.punteggi[categoria.key] || 0}" ${minAttribute}>
                                            <button class="stepper-btn" data-player-index="${playerIndex}" data-step="1">+</button>
                                        </div>`;
                    } else if (categoria.type === 'science') {
                        riga.className = 'punteggio-giocatore-riga';
                        const puntiSalvati = giocatore.punteggi[categoria.key] || { compasso: 0, tavoletta: 0, ingranaggio: 0, serie: 0 };
                        riga.innerHTML = `<label>${giocatore.nome}<span id="anteprima-scienza-${playerIndex}" style="color: var(--colore-successo); font-weight: bold; display: block; font-size: 0.8em;">(${calcolaPuntiScienzaOttimizzati(puntiSalvati)}pt)</span></label>
                                        <div class="science-input-grid">
                                            <input type="number" class="input-punteggio" data-player-index="${playerIndex}" data-science-type="compasso" value="${puntiSalvati.compasso || 0}" min="0">
                                            <input type="number" class="input-punteggio" data-player-index="${playerIndex}" data-science-type="tavoletta" value="${puntiSalvati.tavoletta || 0}" min="0">
                                            <input type="number" class="input-punteggio" data-player-index="${playerIndex}" data-science-type="ingranaggio" value="${puntiSalvati.ingranaggio || 0}" min="0">
                                            <input type="number" class="input-punteggio" data-player-index="${playerIndex}" data-science-type="serie" value="${puntiSalvati.serie || 0}" min="0">
                                        </div>`;
                    }
                    ui.inputsContainer.appendChild(riga);
                });
                
                ui.inputsContainer.querySelectorAll('.stepper-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const input = e.target.parentElement.querySelector('input');
                        const step = parseInt(e.target.dataset.step);
                        const min = parseInt(input.min);
                        const newValue = parseInt(input.value) + step;
                        if (!isNaN(min) && newValue < min) {
                           return;
                        }
                        input.value = newValue;
                    });
                });

                document.querySelectorAll('.science-input-grid input').forEach(input => {
                    input.addEventListener('input', () => {
                        const pIndex = input.dataset.playerIndex; const simboli = { compasso: 0, tavoletta: 0, ingranaggio: 0, serie: 0 };
                        document.querySelectorAll(`input[data-player-index="${pIndex}"][data-science-type]`).forEach(i => { simboli[i.dataset.scienceType] = parseInt(i.value) || 0; });
                        document.getElementById(`anteprima-scienza-${pIndex}`).textContent = `(${calcolaPuntiScienzaOttimizzati(simboli)}pt)`;
                    });
                });
                bottoni.prevCat.disabled = index === 0;
                const isLastCategory = index === datiPartita.categoriePartita.length - 1;
                bottoni.nextCat.textContent = isLastCategory ? (datiPartita.hasCalculatedResults ? 'Ricalcola Risultati' : 'Vedi Risultati') : 'Avanti →';
            }

            function navigaCategorie(dir) {
                salvaPunteggiCategoriaCorrente();
                datiPartita.categoriaCorrenteIndex += dir;
                if (datiPartita.categoriaCorrenteIndex >= datiPartita.categoriePartita.length) {
                    datiPartita.categoriaCorrenteIndex = datiPartita.categoriePartita.length - 1; // Cap to last index
                    mostraRisultati();
                } else {
                    mostraSchermataCategoria();
                }
            }
            
            function salvaPunteggiCategoriaCorrente() {
                const cat = datiPartita.categoriePartita[datiPartita.categoriaCorrenteIndex];
                if (cat && cat.type === 'number') {
                    ui.inputsContainer.querySelectorAll('.punteggio-giocatore-riga input').forEach(input => { datiPartita.giocatori[parseInt(input.dataset.playerIndex)].punteggi[cat.key] = parseInt(input.value) || 0; });
                } else if (cat && cat.type === 'science') {
                    datiPartita.giocatori.forEach((g, pIndex) => {
                        const simboli = { compasso: 0, tavoletta: 0, ingranaggio: 0, serie: 0 };
                        document.querySelectorAll(`input[data-player-index="${pIndex}"][data-science-type]`).forEach(i => { simboli[i.dataset.scienceType] = parseInt(i.value) || 0; });
                        g.punteggi[cat.key] = simboli;
                    });
                }
            }
            
            function calcolaPuntiScienza(simboli) { const t = simboli.tavoletta || 0; const i = simboli.ingranaggio || 0; const c = simboli.compasso || 0; return (t*t + i*i + c*c) + (Math.min(t, i, c) * 7); }
            function calcolaPuntiScienzaOttimizzati(simboli) {
                let { compasso, tavoletta, ingranaggio, serie } = simboli;
                if (!serie || serie === 0) return calcolaPuntiScienza(simboli);
                let c = compasso || 0, t = tavoletta || 0, i = ingranaggio || 0;
                for (let j = 0; j < serie; j++) {
                    const score_c = calcolaPuntiScienza({compasso: c + 1, tavoletta: t, ingranaggio: i});
                    const score_t = calcolaPuntiScienza({compasso: c, tavoletta: t + 1, ingranaggio: i});
                    const score_i = calcolaPuntiScienza({compasso: c, tavoletta: t, ingranaggio: i + 1});
                    if (score_c >= score_t && score_c >= score_i) { c++; } 
                    else if (score_t > score_c && score_t >= score_i) { t++; } 
                    else { i++; }
                }
                return calcolaPuntiScienza({compasso: c, tavoletta: t, ingranaggio: i});
            }

            function mostraRisultati(partitaSalvata = null) {
                datiPartita.hasCalculatedResults = true;
                const dataPartita = datiPartita.manualDate ? new Date(datiPartita.manualDate) : new Date();
                datiPartita.data = datiPartita.data || dataPartita.toLocaleString('it-IT', { day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit' });
                
                datiPartita.giocatori.forEach(g => {
                    const p = g.punteggi;
                    const pTesoro = Math.floor(Math.max(0, p.tesoro || 0) / 3);
                    const pScienza = p.scienza ? calcolaPuntiScienzaOttimizzati(p.scienza) : 0;
                    
                    g.punteggi.puntiTesoro = pTesoro;
                    g.punteggi.puntiScienza = pScienza;

                    let total = 0;
                    datiPartita.categoriePartita.forEach(cat => {
                        const key = cat.key;
                        if (key === 'tesoro') {
                            total += pTesoro;
                        } else if (key === 'scienza' || key === 'scienzaSimboli') {
                            // handled separately
                        } else {
                            total += (p[key] || 0);
                        }
                    });
                    total += pScienza;
                    g.totale = total;
                });
                
                const infoEl = document.createElement('div');
                infoEl.className = 'header-info';
                infoEl.innerHTML = `<span>${datiPartita.data}${datiPartita.luogo ? `, ${datiPartita.luogo}` : ''}</span>`;

                sezioni.risultati.innerHTML = '';
                sezioni.risultati.appendChild(infoEl);
                const titolo = document.createElement('h2');
                titolo.textContent = 'Classifica Finale';
                sezioni.risultati.appendChild(titolo);

                if (datiPartita.espansioni.giocoASquadre) { mostraRisultatiSquadre(); } else { mostraRisultatiIndividuali(); }
                
                const btnGroupTop = document.createElement('div');
                btnGroupTop.className = 'gruppo-bottoni';
                const backToScoreBtn = document.createElement('button');
                backToScoreBtn.textContent = 'Indietro';
                backToScoreBtn.addEventListener('click', () => mostraSezione('punteggio'));
                const backToHomeBtn = document.createElement('button');
                backToHomeBtn.textContent = 'Torna alla Home';
                backToHomeBtn.addEventListener('click', () => mostraSezione('landing'));
                btnGroupTop.appendChild(backToScoreBtn);
                btnGroupTop.appendChild(backToHomeBtn);
                sezioni.risultati.appendChild(btnGroupTop);

                const btnGroupBottom = document.createElement('div');
                btnGroupBottom.className = 'gruppo-bottoni';
                const shareBtn = document.createElement('button');
                shareBtn.textContent = 'Condividi Risultati';
                shareBtn.className = 'bottone-grande';
                shareBtn.addEventListener('click', condividiComeImmagine);
                const nuovaPartitaBtn = document.createElement('button');
                nuovaPartitaBtn.className = 'bottone-grande';
                nuovaPartitaBtn.textContent = 'Nuova Partita';
                nuovaPartitaBtn.addEventListener('click', nuovaPartita);
                btnGroupBottom.appendChild(shareBtn);
                btnGroupBottom.appendChild(nuovaPartitaBtn);
                sezioni.risultati.appendChild(btnGroupBottom);
                
                mostraSezione('risultati');
            }

            function mostraRisultatiIndividuali() {
                const giocatoriOrdinati = [...datiPartita.giocatori].sort((a, b) => b.totale !== a.totale ? b.totale - a.totale : (b.punteggi.tesoro || 0) - (a.punteggi.tesoro || 0));
                const classificaUI = document.createElement('div'); classificaUI.id = 'lista-classifica';
                const isWinner = giocatoriOrdinati.length < 2 || giocatoriOrdinati[0].totale > giocatoriOrdinati[1].totale || (giocatoriOrdinati[0].totale === giocatoriOrdinati[1].totale && giocatoriOrdinati[0].punteggi.tesoro > giocatoriOrdinati[1].punteggi.tesoro);

                giocatoriOrdinati.forEach((g, index) => {
                    const li = document.createElement('div'); li.className = 'risultato-giocatore';
                    if (index === 0 && isWinner) li.classList.add('vincitore');
                    const prevPlayer = giocatoriOrdinati[index - 1]; 
                    const nextPlayer = giocatoriOrdinati[index + 1];
                    const isTied = (prevPlayer && prevPlayer.totale === g.totale) || (nextPlayer && nextPlayer.totale === g.totale);
                    let scoreDisplay = `<span class="punteggio-finale">${g.totale}</span>`;
                    if (isTied) scoreDisplay = `<span class="punteggio-finale">${g.totale}<span class="tie-breaker">(${(g.punteggi.tesoro || 0)}💰)</span></span>`;
                    li.innerHTML = `<div class="risultato-header"><div><span class="medaglia">${(index === 0 && isWinner) ? '🥇' : `${index + 1}.`}</span><div class="nome"><span>${g.nome}</span><span class="wonder-display">${g.meraviglia || 'Nessuna'}</span></div></div>${scoreDisplay}</div>`;
                    li.appendChild(createBreakdownDiv(g)); classificaUI.appendChild(li);
                });
                sezioni.risultati.appendChild(classificaUI);
            }

            function mostraRisultatiSquadre() {
                const squadreMap = datiPartita.giocatori.reduce((acc, g) => {
                    if (!acc[g.team]) acc[g.team] = { nome: `Squadra ${g.team}`, giocatori: [], punteggi: {}, totale: 0 };
                    acc[g.team].giocatori.push(g);
                    return acc;
                }, {});
                const squadre = Object.values(squadreMap);
                squadre.forEach(s => {
                    s.totale = s.giocatori.reduce((acc, g) => acc + g.totale, 0);
                    datiPartita.categoriePartita.forEach(cat => {
                        const key = cat.key;
                        if (key === 'scienza') { s.punteggi.puntiScienza = s.giocatori.reduce((acc, g) => acc + (g.punteggi.puntiScienza || 0), 0); } 
                        else if (key === 'tesoro') { s.punteggi.puntiTesoro = s.giocatori.reduce((acc, g) => acc + (g.punteggi.puntiTesoro || 0), 0); s.punteggi[key] = s.giocatori.reduce((acc, g) => acc + (g.punteggi[key] || 0), 0); } 
                        else { s.punteggi[key] = s.giocatori.reduce((acc, g) => acc + (g.punteggi[key] || 0), 0); }
                    });
                });
                squadre.sort((a, b) => b.totale !== a.totale ? b.totale - a.totale : (b.punteggi.tesoro || 0) - (a.punteggi.tesoro || 0));
                const classificaUI = document.createElement('div'); classificaUI.id = 'lista-classifica';
                
                const isWinner = squadre.length < 2 || squadre[0].totale > squadre[1].totale || (squadre[0].totale === squadre[1].totale && squadre[0].punteggi.tesoro > squadre[1].punteggi.tesoro);

                squadre.forEach((s, index) => {
                    const teamEl = document.createElement('div'); teamEl.className = 'risultato-squadra';
                    if(index === 0 && isWinner) teamEl.classList.add('vincitore');

                    const teamBreakdown = createBreakdownDiv(s);
                    const teamPlayersDetails = document.createElement('div'); teamPlayersDetails.className = 'dettaglio-squadra';
                    s.giocatori.sort((a, b) => b.totale - a.totale).forEach(g => {
                        const playerDetailEl = document.createElement('div'); playerDetailEl.className = 'dettaglio-giocatore-individuale';
                        const playerBreakdown = createBreakdownDiv(g);
                        playerDetailEl.innerHTML = `<div class="risultato-header"><div class="nome"><span>${g.nome}</span><span class="wonder-display">${g.meraviglia || 'Nessuna'}</span></div><span class="punteggio-finale">${g.totale}</span></div>`;
                        playerDetailEl.appendChild(playerBreakdown);
                        teamPlayersDetails.appendChild(playerDetailEl);
                    });

                    const prevTeam = squadre[index - 1]; const nextTeam = squadre[index + 1];
                    const isTied = (prevTeam && prevTeam.totale === s.totale) || (nextTeam && nextTeam.totale === s.totale);
                    let scoreDisplay = `<span class="punteggio-finale">${s.totale}</span>`;
                    if(isTied) scoreDisplay = `<span class="punteggio-finale">${s.totale}<span class="tie-breaker">(${(s.punteggi.tesoro || 0)}💰)</span></span>`;
                    
                    teamEl.innerHTML = `<div class="risultato-header"><div><span class="medaglia">${(index === 0 && isWinner) ? '🥇' : `${index + 1}.`}</span><span class="nome">${s.nome}</span></div>${scoreDisplay}</div>`;
                    teamEl.appendChild(teamBreakdown); teamEl.appendChild(teamPlayersDetails);
                    classificaUI.appendChild(teamEl);
                });
                sezioni.risultati.appendChild(classificaUI);
            }

            function createBreakdownDiv(entity) {
                const div = document.createElement('div'); div.className = 'risultato-breakdown';
                datiPartita.categoriePartita.forEach(cat => {
                    let pCat = cat.key === 'scienza' ? entity.punteggi.puntiScienza : (cat.key === 'tesoro' ? entity.punteggi.puntiTesoro : (entity.punteggi[cat.key] || 0));
                    const icon = cat.label.split(' ')[0];
                    const name = cat.label.split(' ').slice(1).join(' ');
                    div.innerHTML += `<span class="breakdown-item" title="${name}">${icon} ${pCat}</span>`;
                });
                return div;
            }

            function condividiComeImmagine() {
                const shareableContent = document.createElement('div');
                shareableContent.style.width = '1280px';
                shareableContent.style.padding = '50px';
                shareableContent.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--colore-sfondo');
                shareableContent.style.fontFamily = "'Roboto', sans-serif";
                shareableContent.style.color = getComputedStyle(document.documentElement).getPropertyValue('--colore-testo');
                
                const logo = document.getElementById('logo').cloneNode(true);
                logo.style.maxWidth = '50%';
                logo.style.margin = '0 auto 40px auto';
                
                const results = document.getElementById('risultati-sezione').cloneNode(true);
                results.querySelectorAll('.gruppo-bottoni, button, .header-info ~ h2 + button').forEach(el => el.remove());
                results.querySelector('.header-info').style.fontSize = '1.2em';
                results.querySelector('.header-info').style.marginBottom = '20px';

                shareableContent.appendChild(logo);
                shareableContent.appendChild(results);
                
                document.body.appendChild(shareableContent);

                html2canvas(shareableContent, {
                    width: 1280,
                    height: Math.max(720, shareableContent.scrollHeight),
                    scale: 1,
                    backgroundColor: null,
                    useCORS: true
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `risultati-7wonders-${Date.now()}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    document.body.removeChild(shareableContent);
                });
            }
            
            function nuovaPartita() {
                datiPartita.giocatori.forEach(g => {
                    g.punteggi = {};
                    g.totale = 0;
                });
                datiPartita.categoriaCorrenteIndex = 0;
                datiPartita.hasCalculatedResults = false;
                mostraSezione('setup');
            }

            function inizializzaApp() {
                resetStato();
                aggiornaListaGiocatoriUI();
                mostraSezione('landing');
                inputs.nomeGiocatore.focus();
            }

            function resetSettings() {
                Object.values(inputs.esp).forEach(checkbox => checkbox.checked = false);
                inputs.teamPlay.checked = false;
                inputs.luogoPartita.value = '';
                datiPartita.giocatori = [];
                aggiornaListaGiocatoriUI();
            }
            
            bottoni.aggiungiGiocatore.addEventListener('click', aggiungiGiocatore);
            inputs.nomeGiocatore.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); aggiungiGiocatore(); }});
            bottoni.iniziaPartita.addEventListener('click', () => { if (!bottoni.iniziaPartita.disabled) avviaPartita(); });
            bottoni.nuovaPartitaLanding.addEventListener('click', () => mostraSezione('setup'));
            bottoni.randomWonder.addEventListener('click', assegnaMeraviglieCasuali);
            bottoni.nextCat.addEventListener('click', () => navigaCategorie(1));
            bottoni.prevCat.addEventListener('click', () => { salvaPunteggiCategoriaCorrente(); datiPartita.categoriaCorrenteIndex -= 1; mostraSchermataCategoria(); });
            bottoni.backToSetup.addEventListener('click', () => { salvaPunteggiCategoriaCorrente(); mostraSezione('setup'); });
            bottoni.resetSettings.addEventListener('click', resetSettings);
            bottoni.backToHomeFromSetup.addEventListener('click', () => mostraSezione('landing'));
            [...Object.values(inputs.esp), inputs.teamPlay, inputs.dateToggle].forEach(el => el.addEventListener('change', () => {
                document.getElementById('manual-date-container').classList.toggle('hidden', !inputs.dateToggle.checked);
                aggiornaListaGiocatoriUI();
            }));
            
            inizializzaApp();
        });
    </script>
</body>
</html>
