<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>7 Wonders Score Sheet</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icona-app.png">
    <link rel="icon" href="favicon.png" type="image/png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&display=swap');

        :root {
            --colore-primario: #3a5a78; --colore-secondario: #d4ac6e; --colore-sfondo: #1e1e1e;
            --colore-superficie: #2d2d2d; --colore-testo: #f0f0f0; --colore-testo-fioco: #a0a0a0;
            --colore-successo: #6aab75; --colore-pericolo: #c86c6c; --colore-oro: #ffd700;
            --colore-argento: #c0c0c0; --colore-bronzo: #cd7f32;
        }

        body { font-family: 'Roboto', sans-serif; background-color: var(--colore-sfondo); color: var(--colore-testo); margin: 0; padding: 20px; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
        main { width: 100%; max-width: 550px; background-color: var(--colore-superficie); padding: 25px 30px; border-radius: 12px; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2); box-sizing: border-box; }
        .logo { display: block; margin: 0 auto 20px auto; max-width: 80%; height: auto; text-align: center; }
        .logo-container { text-align: center; margin-bottom: 20px; }
        .logo-container img { max-width: 80%; height: auto; }
        #app-subtitle { font-family: 'Cinzel', serif; text-align: center; font-size: 1.8em; color: var(--colore-secondario); margin-top: -15px; margin-bottom: 25px; text-shadow: 1px 1px 3px rgba(0,0,0,0.4); }
        h2, h3, h4 { border-bottom: 2px solid var(--colore-primario); padding-bottom: 10px; margin-bottom: 20px; }
        
        section { transition: opacity 0.3s ease-in-out; }
        
        /* Language Switcher */
        #language-switcher { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .lang-btn { background-color: #444; padding: 8px 15px; font-size: 14px; border-radius: 20px; }
        .lang-btn.active { background-color: var(--colore-secondario); color: #111; }

        /* Landing Page */
        #landing-sezione .gruppo-bottoni { flex-direction: column; gap: 15px; }
        #support-section { margin-top: 40px; text-align: center; }
        .paypal-logo { width: 40px; height: auto; }
        #paypal-btn { background: #ffffff; display: inline-flex; align-items: center; justify-content: center; gap: 12px; width: auto; max-width: 320px; padding: 12px 25px; border: 1px solid #dddddd; border-radius: 25px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); transition: all 0.3s ease; font-weight: bold; color: #1c1c1c; text-decoration: none; }
        #paypal-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12); filter: none; background-color: #f7f7f7; }
        #credits { margin-top: 30px; text-align: center; font-size: 0.8em; color: var(--colore-testo-fioco); }
        #credits a { color: var(--colore-secondario); text-decoration: none; }
        #credits a:hover { text-decoration: underline; }

        /* Rules Section */
        #regolamento-sezione p, #regolamento-sezione .rule-clarification-note { text-align: left; line-height: 1.6; margin-bottom: 20px; }
        .rule-clarification-note { font-style: italic; background-color: rgba(212, 172, 110, 0.1); padding: 10px; border-radius: 5px; border-left: 3px solid var(--colore-secondario); }
        .collapsible-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 10px 0; color: var(--colore-secondario); margin-top: 10px; margin-bottom: 0; border-bottom: 1px solid var(--colore-primario); }
        .collapsible-header:hover { filter: brightness(1.2); }
        .toggle-icon { font-size: 1.5em; font-weight: bold; transition: transform 0.3s ease; }
        .collapsible-header.active .toggle-icon { transform: rotate(45deg); }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out, padding 0.4s ease-out, margin-bottom 0.4s ease-out; padding: 0 15px; margin-bottom: 0; }
        .collapsible-content ul { text-align: left; line-height: 1.6; padding-left: 20px; margin-top: 15px; margin-bottom: 15px; }
        .collapsible-content li { margin-bottom: 10px; }
        
        /* Game Selection Screen */
        #selezione-gioco-sezione .gruppo-bottoni { flex-direction: column; gap: 15px; }
        .game-selection-btn { text-align: left; padding: 20px; font-size: 1.1em; display: flex; justify-content: space-between; align-items: center; }
        .game-selection-btn .game-title { font-weight: bold; }
        .game-selection-btn .game-subtitle { font-size: 0.8em; color: var(--colore-testo-fioco); font-weight: normal; }

        /* Setup */
        .player-header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--colore-primario); margin-bottom: 20px; }
        .player-header h3 { border-bottom: none; margin-bottom: 0; padding-bottom: 10px; }
        .player-header .header-options { display: flex; align-items: center; gap: 15px; }
        .player-header .checkbox-item { margin-bottom: 10px; font-size: 0.8em; }
        .form-group { display: flex; gap: 10px; margin-bottom: 25px; }
        .form-group-column { flex-direction: column; }
        .player-input, .location-input, select { width: 100%; padding: 12px; border: 1px solid #444; border-radius: 8px; background-color: #333; color: var(--colore-testo); font-size: 16px; box-sizing: border-box; }
        .players-list { list-style: none; padding: 0; }
        .giocatore-setup-item { display: flex; flex-wrap: nowrap; align-items: center; justify-content: space-between; gap: 10px; background-color: #383838; padding: 10px 15px; border-radius: 6px; margin-bottom: 8px; font-size: 18px; }
        .nome-giocatore-input { background: none; border: none; color: var(--colore-testo); font-weight: bold; font-size: 18px; font-family: 'Roboto', sans-serif; flex-grow: 1; padding: 5px; border-radius: 4px; }
        .nome-giocatore-input:focus { outline: none; background-color: rgba(255, 255, 255, 0.1); }
        .nome-giocatore-input:disabled { color: var(--colore-testo-fioco); cursor: not-allowed; }
        .action-buttons-container { display: flex; gap: 5px; }
        .delete-player-btn, .edit-player-btn { background: none; border: none; font-size: 20px; cursor: pointer; padding: 0 5px; line-height: 1; }
        .delete-player-btn { color: var(--colore-pericolo); }
        .edit-player-btn { color: var(--colore-secondario); font-size: 18px; }
        .delete-player-btn:disabled { color: #555; cursor: not-allowed; }
        .wonder-select, .team-select { background-color: #444; color: var(--colore-testo); border: 1px solid #555; border-radius: 5px; padding: 8px; font-size: 14px; }
        .opzioni-partita { margin-top: 20px; padding: 15px; background-color: #383838; border-radius: 8px;}
        .opzioni-partita h4 { margin-top: 0; margin-bottom: 10px; }
        .checkbox-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .checkbox-item { display: flex; align-items: center; justify-content: space-between; }
        
        /* Toggle Switch Styles */
        .toggle-switch { position: relative; display: inline-block; width: 51px; height: 31px; flex-shrink: 0;}
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 31px; }
        .slider:before { position: absolute; content: ""; height: 23px; width: 23px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--colore-successo); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Punteggio */
        #punteggio-sezione h2 { text-align: center; color: white; border: none; padding: 10px 15px; border-radius: 8px; transition: background-color 0.4s ease; }
        #punteggio-inputs-container { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        .punteggio-giocatore-riga { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 15px; }
        .punteggio-giocatore-riga label { font-size: 18px; }
        .input-stepper { display: flex; align-items: center; justify-content: flex-end; gap: 8px; }
        .stepper-btn { font-size: 20px; width: 40px; height: 40px; text-align: center; padding: 0; line-height: 40px; flex-shrink: 0; }
        .input-punteggio { padding: 12px; border: 1px solid #444; border-radius: 8px; background-color: #333; color: var(--colore-testo); font-size: 18px; width: 60px; box-sizing: border-box; text-align: center; }
        .manual-date-input { width: 100%; }
        
        /* Stili per la sezione Scienza */
        .science-icon-grid, .punteggio-giocatore-riga.science-row { display: grid; grid-template-columns: 1fr repeat(4, 1fr); align-items: center; gap: 10px 15px; }
        .science-icon-grid { margin-bottom: 8px; align-items: end; }
        .punteggio-giocatore-riga.science-row .input-punteggio { width: 100%; }
        .science-icon { max-height: 30px; margin: auto; display: block; }
        #avviso-categoria { font-size: 0.9em; text-align: center; color: var(--colore-testo-fioco); background: #222; padding: 8px; border-radius: 5px; margin-bottom: 15px; }
        
        /* Risultati */
        .header-info { text-align: right; font-size: 0.8em; color: var(--colore-testo-fioco); margin-bottom: -10px; margin-top: -10px; }
        #lista-classifica { list-style: none; padding: 0; margin-bottom: 30px; }
        .risultato-giocatore, .risultato-squadra { padding: 15px; margin-bottom: 10px; background-color: #383838; border-radius: 8px; }
        .risultato-header { display: flex; justify-content: space-between; align-items: center; font-size: 20px; }
        .nome { font-weight: bold; display: flex; flex-direction: column; align-items: flex-start; }
        .wonder-display { font-style: italic; font-weight: normal; font-size: 0.7em; color: var(--colore-testo-fioco); margin-top: 2px; }
        .wonder-display-duel span { display: block; line-height: 1.3; }
        .punteggio-finale { font-weight: bold; background-color: var(--colore-primario); padding: 5px 12px; border-radius: 6px; color: white; }
        .medaglia { margin-right: 15px; font-size: 24px; }
        .risultato-squadra.vincitore .nome, .risultato-giocatore.vincitore .nome { color: var(--colore-oro); }
        .tie-breaker { font-size: 0.7em; font-weight: normal; color: var(--colore-testo-fioco); margin-left: 5px; }
        .risultato-breakdown { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #444; }
        .breakdown-item { background-color: #2c2c2c; padding: 4px 8px; border-radius: 5px; font-size: 14px; cursor: help; }
        .dettaglio-squadra { margin-top: 15px; padding-top: 15px; border-top: 1px solid #444; font-size: 0.9em; display: flex; flex-direction: column; gap: 15px; }
        .dettaglio-giocatore-individuale { background-color: #2c2c2c; padding: 10px; border-radius: 6px; }
        .dettaglio-giocatore-individuale .risultato-header { font-size: 16px; }
        .dettaglio-giocatore-individuale .risultato-breakdown { font-size: 12px; margin-top: 10px; padding-top: 10px; gap: 8px; }
        
        /* History & Stats Section */
        #cronologia-sezione ul, #statistiche-sezione ul { list-style: none; padding: 0; }
        .history-item { 
            background-color: #383838; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 10px; 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-item-content { flex-grow: 1; cursor: pointer; transition: background-color 0.2s; border-radius: 6px; padding: 5px;}
        .history-item-content:hover { background-color: #4a4a4a; }
        .history-item-header { display: flex; justify-content: space-between; font-weight: bold; }
        .history-item-details { font-size: 0.8em; color: var(--colore-testo-fioco); margin-top: 5px; line-height: 1.4; }
        .stat-card { background-color: #383838; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .stat-card h3 { border: none; padding: 0; margin: 0 0 10px 0; font-size: 1.1em; color: var(--colore-secondario); }
        .stat-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #444; }
        .stat-item:last-child { border-bottom: none; }
        .stat-label { color: var(--colore-testo-fioco); }
        .stat-value { font-weight: bold; }
        #stats-filter-container { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        #stats-filter-container select { flex-grow: 1; }

        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background: var(--colore-superficie); padding: 30px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center; max-width: 90%; width: 350px; transform: scale(0.9); transition: transform 0.3s; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-content p { margin-top: 0; margin-bottom: 25px; line-height: 1.6; }
        .modal-buttons { display: flex; justify-content: center; gap: 15px; }

        /* Bottoni */
        button { padding: 12px 20px; border: none; border-radius: 8px; background-color: var(--colore-primario); color: white; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.2s, transform 0.1s; }
        button:hover { filter: brightness(1.15); }
        button:active { transform: scale(0.98); }
        button:disabled { background-color: #555; color: #999; cursor: not-allowed; filter: none; }
        .bottone-grande { width: 100%; padding: 15px; margin-top: 10px; }
        .gruppo-bottoni { display: flex; gap: 10px; margin-top: 20px; }
        .gruppo-bottoni .bottone-grande { flex: 1; width: auto; font-size: 14px; padding: 12px 5px; }
        #nav-punteggio { justify-content: space-between; }
        .start-game-btn, #nuovaPartitaBtn { background-color: var(--colore-secondario); color: #111; }
        #nextCatBtn { background-color: var(--colore-successo); }
        .random-wonder-btn { padding: 8px 12px; font-size: 16px; flex-shrink: 0; }
        .bottone-pericolo { background-color: var(--colore-pericolo); }
        .hidden { display: none !important; }

        @media (max-width: 480px) {
            main { padding: 20px 15px; }
            .giocatore-setup-item { flex-wrap: wrap; }
            .nome-giocatore-input { flex-basis: 100%; }
            .wonder-select, .team-select { flex-grow: 1; }
            .gruppo-bottoni { flex-wrap: wrap; }
            .punteggio-giocatore-riga { grid-template-columns: 1fr; gap: 5px; }
            .punteggio-giocatore-riga label { text-align: left; }
            .input-stepper { justify-content: flex-start; }
            .checkbox-container { gap: 10px; }
            .checkbox-item { flex-direction: column; align-items: flex-start; gap: 8px; }
            .player-header { flex-direction: column; align-items: flex-start; }
            .player-header .header-options { width: 100%; justify-content: space-between; }
            .player-header .checkbox-item { flex-direction: row; gap: 10px; }
            #stats-filter-container { flex-direction: column; }
        }
    </style>
</head>
<body>
    <main>
        <div id="language-switcher">
            <button id="lang-it" class="lang-btn">IT</button>
            <button id="lang-en" class="lang-btn active">EN</button>
        </div>

        <section id="landing-sezione">
            <div class="logo-container">
                <img src="https://i.imgur.com/p1PgYrh.png" alt="Logo di 7 Wonders Seconda Edizione" onerror="this.onerror=null; this.src='https://placehold.co/400x150/1e1e1e/f0f0f0?text=7+Wonders+Logo';">
            </div>
            <div id="app-subtitle">Companion App</div>
            <div class="gruppo-bottoni">
                <button id="landingNuovaPartitaBtn" class="bottone-grande" data-lang-key="startNewGame"></button>
                <button id="landingCronologiaBtn" class="bottone-grande" data-lang-key="gameHistory"></button>
                <button id="landingStatisticheBtn" class="bottone-grande" data-lang-key="statistics"></button>
                <button id="landingRegolamentoBtn" class="bottone-grande" data-lang-key="rulesClarifications"></button>
            </div>
            <div id="support-section">
                <a href="https://paypal.me/TFerrari308" target="_blank" id="paypal-btn">
                    <img src="https://i.postimg.cc/hj0x6wFB/pngimg-com-paypal-PNG7.png" alt="Logo di PayPal" class="paypal-logo" onerror="this.onerror=null; this.src='https://placehold.co/22x22/0079C1/ffffff?text=P';">
                    <span data-lang-key="supportProject"></span>
                </a>
            </div>
            <div id="credits"></div>
        </section>
        
        <section id="selezione-gioco-sezione" class="hidden">
            <h2 data-lang-key="chooseGameVersion"></h2>
            <div class="gruppo-bottoni">
                <button id="select-game-1ed" class="bottone-grande game-selection-btn">
                    <div>
                        <div class="game-title">7 Wonders</div>
                        <div class="game-subtitle" data-lang-key="game1stEdition"></div>
                    </div>
                    <span>&rarr;</span>
                </button>
                <button id="select-game-2ed" class="bottone-grande game-selection-btn">
                     <div>
                        <div class="game-title">7 Wonders</div>
                        <div class="game-subtitle" data-lang-key="game2ndEdition"></div>
                    </div>
                    <span>&rarr;</span>
                </button>
                <button id="select-game-architects" class="bottone-grande game-selection-btn">
                     <div>
                        <div class="game-title">7 Wonders: Architects</div>
                    </div>
                    <span>&rarr;</span>
                </button>
                <button id="select-game-duel" class="bottone-grande game-selection-btn">
                     <div>
                        <div class="game-title">7 Wonders: Duel</div>
                    </div>
                    <span>&rarr;</span>
                </button>
            </div>
            <div class="gruppo-bottoni">
                <button id="backToHomeFromGameSelectBtn" class="bottone-grande" data-lang-key="backToHome"></button>
            </div>
        </section>

        <section id="regolamento-sezione" class="hidden">
            <h2 data-lang-key="rulesClarifications"></h2>
            <div class="rule-clarification-note" data-lang-key="rulesEditionNote"></div>
            <p data-lang-key="rulesDisclaimer"></p>
            
            <div data-lang-group="rulesBaseGame">
                <h4 class="collapsible-header"><span data-lang-key="rulesBaseGame_title"></span><span class="toggle-icon">Ôºã</span></h4>
                <div class="collapsible-content"><ul></ul></div>
            </div>
            <div data-lang-group="rulesLeaders">
                <h4 class="collapsible-header"><span data-lang-key="rulesLeaders_title"></span><span class="toggle-icon">Ôºã</span></h4>
                <div class="collapsible-content"><ul></ul></div>
            </div>
            <div data-lang-group="rulesArmada">
                <h4 class="collapsible-header"><span data-lang-key="rulesArmada_title"></span><span class="toggle-icon">Ôºã</span></h4>
                <div class="collapsible-content"><ul></ul></div>
            </div>
            <div data-lang-group="rulesCities">
                <h4 class="collapsible-header"><span data-lang-key="rulesCities_title"></span><span class="toggle-icon">Ôºã</span></h4>
                <div class="collapsible-content"><ul></ul></div>
            </div>
            <div data-lang-group="rulesEdifice">
                <h4 class="collapsible-header"><span data-lang-key="rulesEdifice_title"></span><span class="toggle-icon">Ôºã</span></h4>
                <div class="collapsible-content"><ul></ul></div>
            </div>
            <div data-lang-group="rulesPromo">
                <h4 class="collapsible-header"><span data-lang-key="rulesPromo_title"></span><span class="toggle-icon">Ôºã</span></h4>
                <div class="collapsible-content"><ul></ul></div>
            </div>

            <div class="gruppo-bottoni">
                <button id="backToHomeFromRulesBtn" class="bottone-grande" data-lang-key="backToHome"></button>
            </div>
        </section>
        
        <section id="cronologia-sezione" class="hidden">
            <h2 data-lang-key="gameHistory"></h2>
            <div id="history-filter-container" class="form-group" style="margin-bottom: 20px; gap: 15px;">
                <select id="history-game-filter" class="player-input"></select>
                <select id="history-sort-filter" class="player-input">
                    <option value="newest" data-lang-key="newestFirst"></option>
                    <option value="oldest" data-lang-key="oldestFirst"></option>
                </select>
            </div>
            <ul id="history-list"></ul>
            <div id="history-pagination" class="gruppo-bottoni" style="justify-content: center; align-items: center; margin-top: 15px;">
            </div>
            <div class="gruppo-bottoni">
                <button id="backToHomeFromHistoryBtn" class="bottone-grande" data-lang-key="backToHome"></button>
            </div>
        </section>
        
        <section id="statistiche-sezione" class="hidden">
            <h2 data-lang-key="statistics"></h2>
            
            <div class="stat-card">
                <h3 data-lang-key="overallStats"></h3>
                <div id="overall-stats-filter-container" class="form-group" style="margin-bottom: 20px;">
                    <select id="overall-stats-game-filter" class="player-input"></select>
                </div>
                <div id="overall-stats-container"></div>
            </div>

            <div class="stat-card">
                <h3 data-lang-key="playerStats"></h3>
                <div id="stats-filter-container" class="form-group hidden">
                    <select id="stats-player-filter" class="player-input"></select>
                    <select id="stats-game-version-filter" class="player-input"></select>
                </div>
                <div id="player-stats-container"></div>
            </div>
            
            <div class="gruppo-bottoni">
                <button id="backToHomeFromStatsBtn" class="bottone-grande" data-lang-key="backToHome"></button>
            </div>
        </section>
        
        <!-- SETUP 1ST EDITION -->
        <section id="setup-1ed-sezione" class="hidden">
            <div class="logo-container">
                <img src="https://i.postimg.cc/8zKZnZ89/pngegg.png" alt="Logo di 7 Wonders Prima Edizione" style="max-width: 60%;" onerror="this.onerror=null; this.src='https://placehold.co/300x100/1e1e1e/f0f0f0?text=7+Wonders';">
            </div>
            <h2 data-lang-key="setupGame1ed"></h2>
            <div class="form-group form-group-column">
                <input type="text" id="nomeGiocatoreInput-1ed" class="player-input" data-lang-placeholder-key="playerNamePlaceholder">
                <button id="aggiungiGiocatoreBtn-1ed" data-lang-key="add"></button>
            </div>
            <div class="player-header">
                <h3 data-lang-key="playersAndWonders"></h3>
                <div class="header-options">
                    <div class="checkbox-item hidden" id="team-play-container-1ed">
                        <label for="team-play-checkbox-1ed" style="font-size:1em;" data-lang-key="teamGame"></label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="team-play-checkbox-1ed">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <button id="randomWonderBtn-1ed" class="random-wonder-btn" data-lang-key="randomWonders"></button>
                </div>
            </div>
            <ul id="listaGiocatori-1ed" class="players-list"></ul>
            <div class="opzioni-partita">
                <h4 data-lang-key="expansions"></h4>
                <div class="checkbox-container">
                    <div class="checkbox-item"><label for="esp-1ed-cities">Cities</label><label class="toggle-switch"><input type="checkbox" id="esp-1ed-cities"><span class="slider"></span></label></div>
                    <div class="checkbox-item"><label for="esp-1ed-leaders">Leaders</label><label class="toggle-switch"><input type="checkbox" id="esp-1ed-leaders"><span class="slider"></span></label></div>
                    <div class="checkbox-item"><label for="esp-1ed-armada">Armada</label><label class="toggle-switch"><input type="checkbox" id="esp-1ed-armada"><span class="slider"></span></label></div>
                    <div class="checkbox-item"><label for="esp-1ed-babel">Babel</label><label class="toggle-switch"><input type="checkbox" id="esp-1ed-babel"><span class="slider"></span></label></div>
                    <div class="checkbox-item"><label for="esp-1ed-wonderpack">Wonder Pack</label><label class="toggle-switch"><input type="checkbox" id="esp-1ed-wonderpack"><span class="slider"></span></label></div>
                    <div class="checkbox-item"><label for="esp-1ed-siracusa">Siracusa</label><label class="toggle-switch"><input type="checkbox" id="esp-1ed-siracusa"><span class="slider"></span></label></div>
                    <div class="checkbox-item"><label for="esp-1ed-catan">Catan</label><label class="toggle-switch"><input type="checkbox" id="esp-1ed-catan"><span class="slider"></span></label></div>
                </div>
            </div>
             <div class="opzioni-partita">
                <h4 data-lang-key="location"></h4>
                <div class="form-group" style="margin-bottom: 0;">
                     <input type="text" id="luogoPartitaInput-1ed" class="location-input" data-lang-placeholder-key="locationPlaceholder">
                </div>
            </div>
            <div class="opzioni-partita">
                <h4 data-lang-key="dateAndTime"></h4>
                <div class="checkbox-item">
                    <label for="date-toggle-1ed" data-lang-key="useManualDate"></label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="date-toggle-1ed">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="form-group hidden" id="manual-date-container-1ed" style="margin-top: 15px; margin-bottom: 0;">
                    <input type="datetime-local" id="manual-date-input-1ed" class="input-punteggio manual-date-input">
                </div>
            </div>
            <div class="gruppo-bottoni">
                <button class="back-to-game-select bottone-grande" data-lang-key="backToGameSelect"></button>
                <button id="iniziaPartitaBtn-1ed" class="bottone-grande start-game-btn" disabled data-lang-key="start"></button>
            </div>
        </section>

        <!-- SETUP 2ND EDITION -->
        <section id="setup-2ed-sezione" class="hidden">
            <div class="logo-container">
                <img src="https://i.imgur.com/p1PgYrh.png" alt="Logo di 7 Wonders Seconda Edizione" onerror="this.onerror=null; this.src='https://placehold.co/400x150/1e1e1e/f0f0f0?text=7+Wonders+Logo';">
            </div>
            <h2 data-lang-key="setupGame2ed"></h2>
            <div class="form-group form-group-column">
                <input type="text" id="nomeGiocatoreInput-2ed" class="player-input" data-lang-placeholder-key="playerNamePlaceholder">
                <button id="aggiungiGiocatoreBtn-2ed" data-lang-key="add"></button>
            </div>
            <div class="player-header">
                <h3 data-lang-key="playersAndWonders"></h3>
                <div class="header-options">
                     <div class="checkbox-item hidden" id="team-play-container-2ed">
                        <label for="team-play-checkbox-2ed" style="font-size:1em;" data-lang-key="teamGame"></label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="team-play-checkbox-2ed">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <button id="randomWonderBtn-2ed" class="random-wonder-btn" data-lang-key="randomWonders"></button>
                </div>
            </div>
            <ul id="listaGiocatori-2ed" class="players-list"></ul>
             <div class="opzioni-partita">
                <h4 data-lang-key="expansions"></h4>
                <div class="checkbox-container">
                    <div class="checkbox-item"><label for="esp-2ed-cities">Cities</label><label class="toggle-switch"><input type="checkbox" id="esp-2ed-cities"><span class="slider"></span></label></div>
                    <div class="checkbox-item"><label for="esp-2ed-leaders">Leaders</label><label class="toggle-switch"><input type="checkbox" id="esp-2ed-leaders"><span class="slider"></span></label></div>
                    <div class="checkbox-item"><label for="esp-2ed-armada">Armada</label><label class="toggle-switch"><input type="checkbox" id="esp-2ed-armada"><span class="slider"></span></label></div>
                    <div class="checkbox-item"><label for="esp-2ed-edifice">Edifice</label><label class="toggle-switch"><input type="checkbox" id="esp-2ed-edifice"><span class="slider"></span></label></div>
                    <div class="checkbox-item"><label for="esp-2ed-greatwall" data-lang-key="expGreatWall"></label><label class="toggle-switch"><input type="checkbox" id="esp-2ed-greatwall"><span class="slider"></span></label></div>
                    <div class="checkbox-item"><label for="esp-2ed-mannekenpis">Manneken Pis</label><label class="toggle-switch"><input type="checkbox" id="esp-2ed-mannekenpis"><span class="slider"></span></label></div>
                </div>
            </div>
            <div class="opzioni-partita">
                <h4 data-lang-key="location"></h4>
                <div class="form-group" style="margin-bottom: 0;">
                     <input type="text" id="luogoPartitaInput-2ed" class="location-input" data-lang-placeholder-key="locationPlaceholder">
                </div>
            </div>
            <div class="opzioni-partita">
                <h4 data-lang-key="dateAndTime"></h4>
                <div class="checkbox-item">
                    <label for="date-toggle-2ed" data-lang-key="useManualDate"></label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="date-toggle-2ed">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="form-group hidden" id="manual-date-container-2ed" style="margin-top: 15px; margin-bottom: 0;">
                    <input type="datetime-local" id="manual-date-input-2ed" class="input-punteggio manual-date-input">
                </div>
            </div>
            <div class="gruppo-bottoni">
                <button class="back-to-game-select bottone-grande" data-lang-key="backToGameSelect"></button>
                <button id="resetSettingsBtn-2ed" data-lang-key="reset"></button>
                <button id="iniziaPartitaBtn-2ed" class="bottone-grande start-game-btn" disabled data-lang-key="start"></button>
            </div>
        </section>

        <!-- SETUP ARCHITECTS -->
        <section id="setup-architects-sezione" class="hidden">
            <div class="logo-container">
                <img src="https://i.postimg.cc/mgqzt9fK/arc-common-logo-1630334595b-VXy-Z-large.png" alt="Logo di 7 Wonders Architects" onerror="this.onerror=null; this.src='https://placehold.co/400x100/1e1e1e/f0f0f0?text=Architects';">
            </div>
            <h2 data-lang-key="setupGameArchitects"></h2>
             <div class="form-group form-group-column">
                <input type="text" id="nomeGiocatoreInput-architects" class="player-input" data-lang-placeholder-key="playerNamePlaceholder">
                <button id="aggiungiGiocatoreBtn-architects" data-lang-key="add"></button>
            </div>
             <div class="player-header">
                <h3 data-lang-key="playersAndWonders"></h3>
                <div class="header-options">
                    <button id="randomWonderBtn-architects" class="random-wonder-btn" data-lang-key="randomWonders"></button>
                </div>
            </div>
            <ul id="listaGiocatori-architects" class="players-list"></ul>
             <div class="opzioni-partita">
                <h4 data-lang-key="expansions"></h4>
                <div class="checkbox-container" style="grid-template-columns: 1fr;">
                    <div class="checkbox-item">
                        <label for="esp-architects-medals">Medals</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="esp-architects-medals">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>
             <div class="opzioni-partita">
                <h4 data-lang-key="location"></h4>
                <div class="form-group" style="margin-bottom: 0;">
                     <input type="text" id="luogoPartitaInput-architects" class="location-input" data-lang-placeholder-key="locationPlaceholder">
                </div>
            </div>
            <div class="opzioni-partita">
                <h4 data-lang-key="dateAndTime"></h4>
                <div class="checkbox-item">
                    <label for="date-toggle-architects" data-lang-key="useManualDate"></label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="date-toggle-architects">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="form-group hidden" id="manual-date-container-architects" style="margin-top: 15px; margin-bottom: 0;">
                    <input type="datetime-local" id="manual-date-input-architects" class="input-punteggio manual-date-input">
                </div>
            </div>
             <div class="gruppo-bottoni">
                 <button class="back-to-game-select bottone-grande" data-lang-key="backToGameSelect"></button>
                 <button id="iniziaPartitaBtn-architects" class="bottone-grande start-game-btn" disabled data-lang-key="start"></button>
             </div>
        </section>

        <!-- SETUP DUEL -->
        <section id="setup-duel-sezione" class="hidden">
            <div class="logo-container">
                <img src="https://i.postimg.cc/vmV19mGT/7WDuel.png" alt="Logo di 7 Wonders Duel" onerror="this.onerror=null; this.src='https://placehold.co/350x150/1e1e1e/f0f0f0?text=Duel';">
            </div>
            <h2 data-lang-key="setupGameDuel"></h2>
            <div class="form-group form-group-column">
                <input type="text" id="nomeGiocatoreInput-duel" class="player-input" data-lang-placeholder-key="playerNamePlaceholder">
                <button id="aggiungiGiocatoreBtn-duel" data-lang-key="add"></button>
            </div>
             <div class="player-header">
                <h3 data-lang-key="playersAndWonders"></h3>
                 <div class="header-options">
                    <button id="randomWonderBtn-duel" class="random-wonder-btn" data-lang-key="randomWonders" disabled></button>
                </div>
            </div>
            <ul id="listaGiocatori-duel" class="players-list"></ul>
              <div class="opzioni-partita">
                <h4 data-lang-key="expansions"></h4>
                <div class="checkbox-container">
                    <div class="checkbox-item"><label for="esp-duel-pantheon" data-lang-key="expDuelPantheon">Pantheon</label><label class="toggle-switch"><input type="checkbox" id="esp-duel-pantheon"><span class="slider"></span></label></div>
                    <div class="checkbox-item"><label for="esp-duel-agora" data-lang-key="expDuelAgora">Agora</label><label class="toggle-switch"><input type="checkbox" id="esp-duel-agora"><span class="slider"></span></label></div>
                    <div class="checkbox-item"><label for="esp-duel-messe" data-lang-key="expDuelMesse">Messe</label><label class="toggle-switch"><input type="checkbox" id="esp-duel-messe"><span class="slider"></span></label></div>
                    <div class="checkbox-item"><label for="esp-duel-statue" data-lang-key="expDuelStatue">Statua della Libert√†</label><label class="toggle-switch"><input type="checkbox" id="esp-duel-statue"><span class="slider"></span></label></div>
                    <div class="checkbox-item"><label for="esp-duel-stonehenge" data-lang-key="expDuelStonehenge">Stonehenge</label><label class="toggle-switch"><input type="checkbox" id="esp-duel-stonehenge"><span class="slider"></span></label></div>
                    <div class="checkbox-item"><label for="esp-duel-sagrada" data-lang-key="expDuelSagrada">Sagrada Familia</label><label class="toggle-switch"><input type="checkbox" id="esp-duel-sagrada"><span class="slider"></span></label></div>
                </div>
            </div>
            <div class="opzioni-partita">
                 <h4 data-lang-key="instantVictory"></h4>
                 <div id="instant-victory-buttons-duel" class="gruppo-bottoni" style="flex-direction: column; gap: 8px; margin-top: 10px;">
                    <!-- I bottoni verranno generati dal JS -->
                 </div>
            </div>
             <div class="opzioni-partita">
                <h4 data-lang-key="location"></h4>
                <div class="form-group" style="margin-bottom: 0;">
                     <input type="text" id="luogoPartitaInput-duel" class="location-input" data-lang-placeholder-key="locationPlaceholder">
                </div>
            </div>
            <div class="opzioni-partita">
                <h4 data-lang-key="dateAndTime"></h4>
                <div class="checkbox-item">
                    <label for="date-toggle-duel" data-lang-key="useManualDate"></label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="date-toggle-duel">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="form-group hidden" id="manual-date-container-duel" style="margin-top: 15px; margin-bottom: 0;">
                    <input type="datetime-local" id="manual-date-input-duel" class="input-punteggio manual-date-input">
                </div>
            </div>
             <div class="gruppo-bottoni">
                 <button class="back-to-game-select bottone-grande" data-lang-key="backToGameSelect"></button>
                 <button id="iniziaPartitaBtn-duel" class="bottone-grande start-game-btn" disabled data-lang-key="start"></button>
             </div>
        </section>

        <section id="punteggio-sezione" class="hidden">
            <h2 id="titolo-categoria-punteggio"></h2>
            <div id="punteggio-inputs-container"></div>
            <div class="gruppo-bottoni" id="nav-punteggio">
                <button id="backToSetupBtn" data-lang-key="backToSetup"></button>
                <button id="prevCatBtn" data-lang-key="back">‚Üê </button>
                <button id="nextCatBtn" data-lang-key="next"> ‚Üí</button>
            </div>
        </section>

        <section id="risultati-sezione" class="hidden"></section>

        <!-- MODAL -->
        <div id="confirmModal" class="modal-overlay">
            <div class="modal-content">
                <p id="modal-text"></p>
                <div class="modal-buttons">
                    <button id="modal-cancel-btn" data-lang-key="cancel"></button>
                    <button id="modal-confirm-btn" class="bottone-pericolo" data-lang-key="confirm"></button>
                </div>
            </div>
        </div>

    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ===============================================
            // A. TUTTE LE VARIABILI E COSTANTI
            // ===============================================

            const sezioni = { 
                landing: document.getElementById('landing-sezione'), 
                selezioneGioco: document.getElementById('selezione-gioco-sezione'),
                regolamento: document.getElementById('regolamento-sezione'),
                cronologia: document.getElementById('cronologia-sezione'),
                statistiche: document.getElementById('statistiche-sezione'),
                'setup-1ed': document.getElementById('setup-1ed-sezione'),
                'setup-2ed': document.getElementById('setup-2ed-sezione'), 
                'setup-architects': document.getElementById('setup-architects-sezione'),
                'setup-duel': document.getElementById('setup-duel-sezione'),
                punteggio: document.getElementById('punteggio-sezione'), 
                risultati: document.getElementById('risultati-sezione')
            };

            const bottoni = {
                nuovaPartitaLanding: document.getElementById('landingNuovaPartitaBtn'),
                regolamentoLanding: document.getElementById('landingRegolamentoBtn'),
                cronologiaLanding: document.getElementById('landingCronologiaBtn'),
                statisticheLanding: document.getElementById('landingStatisticheBtn'),
                backToHomeFromRules: document.getElementById('backToHomeFromRulesBtn'),
                backToHomeFromHistory: document.getElementById('backToHomeFromHistoryBtn'),
                backToHomeFromStats: document.getElementById('backToHomeFromStatsBtn'),
                backToHomeFromGameSelect: document.getElementById('backToHomeFromGameSelectBtn'),
                selectGame1ed: document.getElementById('select-game-1ed'),
                selectGame2ed: document.getElementById('select-game-2ed'),
                selectGameArchitects: document.getElementById('select-game-architects'),
                selectGameDuel: document.getElementById('select-game-duel'),
                prevCat: document.getElementById('prevCatBtn'), nextCat: document.getElementById('nextCatBtn'),
                backToSetup: document.getElementById('backToSetupBtn'),
                langIt: document.getElementById('lang-it'),
                langEn: document.getElementById('lang-en'),
            };
            const ui = { 
                titoloCategoria: document.getElementById('titolo-categoria-punteggio'), 
                inputsContainer: document.getElementById('punteggio-inputs-container'), 
                appSubtitle: document.getElementById('app-subtitle'),
                credits: document.getElementById('credits'),
                historyList: document.getElementById('history-list'),
                historyGameFilter: document.getElementById('history-game-filter'),
                historySortFilter: document.getElementById('history-sort-filter'),
                overallStatsContainer: document.getElementById('overall-stats-container'),
                overallStatsGameFilter: document.getElementById('overall-stats-game-filter'),
                playerStatsContainer: document.getElementById('player-stats-container'),
                statsPlayerFilter: document.getElementById('stats-player-filter'),
                statsGameVersionFilter: document.getElementById('stats-game-version-filter'),
                modal: {
                    overlay: document.getElementById('confirmModal'),
                    text: document.getElementById('modal-text'),
                    confirmBtn: document.getElementById('modal-confirm-btn'),
                    cancelBtn: document.getElementById('modal-cancel-btn')
                }
            };
            
            const MERAVIGLIE_1ED = {
                base: ['Halikarnassos', 'Rh√≥dos', 'Olymp√≠a', 'Alexandria', 'Babylon', '√âphesos', 'Gizah'],
                leaders: ['Roma'],
                cities: ['Byzantium', 'Petra'],
                armada: [], 
                siracusa: ['Siracusa'],
                wonderpack: ['Abu Simbel', 'Grande Muraglia Cinese', 'Manneken Pis', 'Stonehenge'],
                catan: ['Catan']
            };

            const MERAVIGLIE_2ED = { 
                base: ['Halikarnassos', 'Rh√≥dos', 'Olymp√≠a', 'Alexandria', 'Babylon', '√âphesos', 'Gizah'], 
                leaders: ['Roma', 'Abu Simbel'], 
                cities: ['Byzantium', 'Petra'], 
                armada: ['Siracusa'], 
                edifice: ['Ur', 'Carthage'], 
                greatwall: ['Grande Muraglia Cinese'], 
                mannekenpis: ['Manneken Pis'] 
            };

            const MERAVIGLIE_ARCHITECTS = {
                base: ['Giza', 'Babilonia', 'Rodi', 'Efeso', 'Olimpia', 'Alicarnasso', 'Alessandria'],
                medals: ['Roma', 'Ur']
            };
            
            const MERAVIGLIE_DUEL = {
                base: ['Via Appia', 'Circo Massimo', 'Colosso', 'Grande Biblioteca', 'Grande Faro', 'Giardini Pensili', 'Mausoleo', 'Pireo', 'Piramidi', 'Sfinge', 'Statua di Zeus', 'Tempio di Artemide'],
                pantheon: ['Santuario', 'Teatro Divino'],
                agora: ['Cnosso', 'Curia Iulia'],
                messe: ['Messe'],
                statue: ['Statue of Liberty'],
                stonehenge: ['Stonehenge'],
                sagrada: ['Sagrada Familia']
            };

            
            const CATEGORIE_1ED = [
                { key: 'meraviglia', label: 'üèõÔ∏è Meraviglia', type: 'number', color: '#7f8c8d', langKey: 'catWonder' },
                { key: 'tesoro', label: 'üí∞ Tesoro', type: 'number', color: '#f1c40f', langKey: 'catTreasury' },
                { key: 'debiti', label: 'üí∏ Debiti', type: 'number', expansion: 'cities', color: '#c0392b', langKey: 'catDebts' },
                { key: 'militari', label: '‚öîÔ∏è Conflitti Militari', type: 'number', color: '#c0392b', langKey: 'catMilitary' },
                { key: 'civili', label: 'üîµ Edifici Civili', type: 'number', color: '#2980b9', langKey: 'catCivilian' },
                { key: 'commerciali', label: 'üü° Edifici Commerciali', type: 'number', color: '#f1c40f', langKey: 'catCommercial' },
                { key: 'scienza', label: 'üü¢ Edifici Scientifici', type: 'science', color: '#27ae60', langKey: 'catScience' },
                { key: 'gilde', label: 'üü£ Gilde', type: 'number', color: '#8e44ad', langKey: 'catGuilds' },
                { key: 'cities', label: '‚ö´ Cities', type: 'number', expansion: 'cities', color: '#34495e', langKey: 'catCities' },
                { key: 'leaders', label: 'üëë Leader', type: 'number', expansion: 'leaders', color: '#bdc3c7', langKey: 'catLeaders' },
                { key: 'conflittiNavali', label: '‚öì Conflitti Navali', type: 'number', expansion: 'armada', color: '#3498db', langKey: 'catNaval' },
                { key: 'percorsoMarittimo', label: 'üó∫Ô∏è Percorso Navale Blu', type: 'number', expansion: 'armada', color: '#3498db', langKey: 'catNavalBlue' },
                { key: 'isole', label: 'üèùÔ∏è Isole', type: 'number', expansion: 'armada', color: '#16a085', langKey: 'catIslands' },
                { key: 'babel', label: 'üóº Babele', type: 'number', expansion: 'babel', color: '#a1887f', langKey: 'catBabel' },
                { key: 'grandiProgetti', label: 'üõ†Ô∏è Grandi Progetti', type: 'number', expansion: 'babel', color: '#ffab40', langKey: 'catGreatProjects' },
            ];

            const CATEGORIE_2ED = [
                { key: 'meraviglia', label: 'üèõÔ∏è Meraviglia', type: 'number', color: '#7f8c8d', langKey: 'catWonder' },
                { key: 'tesoro', label: 'üí∞ Tesoro', type: 'number', color: '#f1c40f', langKey: 'catTreasury' },
                { key: 'debiti', label: 'üí∏ Debiti', type: 'number', expansion: 'cities', color: '#c0392b', langKey: 'catDebts' },
                { key: 'militari', label: '‚öîÔ∏è Conflitti Militari', type: 'number', color: '#c0392b', langKey: 'catMilitary' },
                { key: 'civili', label: 'üîµ Edifici Civili', type: 'number', color: '#2980b9', langKey: 'catCivilian' },
                { key: 'commerciali', label: 'üü° Edifici Commerciali', type: 'number', color: '#f1c40f', langKey: 'catCommercial' },
                { key: 'scienza', label: 'üü¢ Edifici Scientifici', type: 'science', color: '#27ae60', langKey: 'catScience' },
                { key: 'gilde', label: 'üü£ Gilde', type: 'number', color: '#8e44ad', langKey: 'catGuilds' },
                { key: 'cities', label: '‚ö´ Cities', type: 'number', expansion: 'cities', color: '#34495e', langKey: 'catCities' },
                { key: 'leaders', label: 'üëë Leader', type: 'number', expansion: 'leaders', color: '#bdc3c7', langKey: 'catLeaders' },
                { key: 'conflittiNavali', label: '‚öì Conflitti Navali', type: 'number', expansion: 'armada', color: '#3498db', langKey: 'catNaval' },
                { key: 'percorsoMarittimo', label: 'üó∫Ô∏è Percorso Navale Blu', type: 'number', expansion: 'armada', color: '#3498db', langKey: 'catNavalBlue' },
                { key: 'isole', label: 'üèùÔ∏è Isole', type: 'number', expansion: 'armada', color: '#16a085', langKey: 'catIslands' },
                { key: 'edifice', label: 'üèóÔ∏è Edifici', type: 'number', expansion: 'edifice', color: '#d35400', langKey: 'catEdifice' },
            ];

            const CATEGORIE_ARCHITECTS = [
                { key: 'wonderStages', label: 'üèóÔ∏è Numero di Stadi', type: 'number', color: '#a9a9a9', langKey: 'catNumStages', descLangKey: 'catNumStages_desc' },
                { key: 'meraviglia', label: 'üèõÔ∏è Meraviglia', type: 'number', color: '#c0c0c0', langKey: 'catWonder' },
                { key: 'militari', label: '‚öîÔ∏è Vittorie Militari', type: 'number', color: '#c0392b', langKey: 'catMilitary' },
                { key: 'civili', label: 'üîµ Punti Civili', type: 'number', color: '#2980b9', langKey: 'catCivilian' },
                { key: 'scienza', label: 'üü¢ Segnalini Progresso', type: 'number', color: '#27ae60', langKey: 'catProgressTokens' },
                { key: 'gatto', label: 'üêà Pedina Gatto', type: 'checkbox', color: '#f39c12', langKey: 'catCatPawn' },
                { key: 'medaglie', label: 'üèÖ Medaglie', type: 'number', color: '#eab308', langKey: 'catMedals', expansion: 'medals'}
            ];

            const CATEGORIE_DUEL = [
                { key: 'civili', label: 'üîµ Strutture Civili', type: 'number', color: '#2980b9', langKey: 'catDuelCivilian' },
                { key: 'commerciali', label: 'üü° Strutture Commerciali', type: 'number', color: '#f1c40f', langKey: 'catDuelCommercial' },
                { key: 'gilde', label: 'üü£ Gilde', type: 'number', color: '#8e44ad', langKey: 'catGuilds' },
                { key: 'meraviglie', label: 'üèõÔ∏è Meraviglie', type: 'number', color: '#c0c0c0', langKey: 'catWonders' },
                { key: 'progresso', label: '‚öôÔ∏è Progresso', type: 'number', color: '#27ae60', langKey: 'catProgress' },
                { key: 'scienza', label: 'üî¨ Strutture Scientifiche', type: 'number', color: '#27ae60', langKey: 'catDuelScientific' },
                { key: 'tesoro', label: 'üí∞ Tesoro', type: 'number', color: '#f1c40f', langKey: 'catTreasury' },
                { key: 'militari', label: '‚öîÔ∏è Punti Militari', type: 'number', color: '#c0392b', langKey: 'catMilitary' },
                { key: 'divinita', label: 'üè∫ Divinit√†', type: 'number', color: '#D1C4E9', expansion: 'pantheon', langKey: 'catGods' },
                { key: 'grandiTempli', label: 'üõï Grandi Templi', type: 'number', color: '#FFD54F', expansion: 'pantheon', langKey: 'catGrandTemples' },
                { key: 'camere', label: 'üèõÔ∏è Camere del Senato', type: 'number', color: '#78909C', expansion: 'agora', langKey: 'catSenateChambers' },
            ];

            const CATEGORIE_NEGATIVE_PERMESSE = ['militari', 'debiti', 'conflittiNavali', 'babel', 'grandiProgetti'];
            
            const wonderTranslations = { 
                "Grande Muraglia Cinese": { it: "Grande Muraglia Cinese", en: "Great Wall of China" },
                "Alessandria": {it: "Alessandria", en: "Alexandria"},
                "Alicarnasso": {it: "Alicarnasso", en: "Halicarnassus"},
                "Babilonia": {it: "Babilonia", en: "Babylon"},
                "Efeso": {it: "Efeso", en: "Ephesos"},
                "Giza": {it: "Giza", en: "Giza"},
                "Olimpia": {it: "Olimpia", en: "Olympia"},
                "Rodi": {it: "Rodi", en: "Rhodes"},
                "Roma": {it: "Roma", en: "Rome"},
                "Ur": {it: "Ur", en: "Ur"},
                "Statue of Liberty": {it: "Statua della Libert√†", en: "Statue of Liberty"},
                "Via Appia": { it: "Via Appia", en: "The Appian Way"},
                "Circo Massimo": { it: "Circo Massimo", en: "Circus Maximus"},
                "Colosso": { it: "Colosso", en: "The Colossus"},
                "Grande Biblioteca": { it: "Grande Biblioteca", en: "The Great Library"},
                "Grande Faro": { it: "Grande Faro", en: "The Great Lighthouse"},
                "Giardini Pensili": { it: "Giardini Pensili", en: "The Hanging Gardens"},
                "Mausoleo": { it: "Mausoleo", en: "The Mausoleum"},
                "Pireo": { it: "Pireo", en: "Piraeus"},
                "Piramidi": { it: "Piramidi", en: "The Pyramids"},
                "Sfinge": { it: "Sfinge", en: "The Sphinx"},
                "Statua di Zeus": { it: "Statua di Zeus", en: "The Statue of Zeus"},
                "Tempio di Artemide": { it: "Tempio di Artemide", en: "The Temple of Artemis"},
                "Santuario": { it: "Santuario", en: "The Sanctuary" },
                "Teatro Divino": { it: "Teatro Divino", en: "The Divine Theater" },
                "Cnosso": { it: "Cnosso", en: "Knossos" },
                "Curia Iulia": { it: "Curia Iulia", en: "Curia Julia" },
                "Messe": { it: "Messe", en: "Messe" },
                "Stonehenge": { it: "Stonehenge", en: "Stonehenge" },
                "Sagrada Familia": { it: "Sagrada Familia", en: "Sagrada Familia" }
            };

            let datiPartita;
            let currentLanguage = 'it';
            let translations = {};
            let onConfirmCallback = null;
            let currentPage = 1;
            const ITEMS_PER_PAGE = 10;

            // ===============================================
            // B. LOGICA DI TRADUZIONE E MODALE
            // ===============================================

            function getWonderName(wonderKey) {
                if (!wonderKey) return '';
                if (wonderTranslations[wonderKey] && wonderTranslations[wonderKey][currentLanguage]) {
                    return wonderTranslations[wonderKey][currentLanguage];
                }
                return wonderKey;
            }

            function setLanguage(lang) {
                currentLanguage = lang;
                document.documentElement.lang = lang;

                document.getElementById('lang-it').classList.toggle('active', lang === 'it');
                document.getElementById('lang-en').classList.toggle('active', lang === 'en');
                
                document.title = translations.pageTitle[lang];

                document.querySelectorAll('[data-lang-key]').forEach(el => {
                    const key = el.dataset.langKey;
                    if(translations[key] && translations[key][lang]) {
                        el.innerHTML = translations[key][lang];
                    }
                });

                document.querySelectorAll('[data-lang-placeholder-key]').forEach(el => {
                    const key = el.dataset.langPlaceholderKey;
                    if(translations[key] && translations[key][lang]) {
                        el.placeholder = translations[key][lang];
                    }
                });
                
                document.querySelectorAll('[data-lang-group]').forEach(group => {
                    const groupKey = group.dataset.langGroup;
                    const list = group.querySelector('ul');
                    if (translations[groupKey] && list) {
                        list.innerHTML = translations[groupKey][lang].map(rule => `<li>${rule}</li>`).join('');
                    }
                });
                
                ui.credits.innerHTML = translations.creditsText[lang];

                if (datiPartita && sezioni.punteggio.classList.contains('hidden') && sezioni.risultati.classList.contains('hidden')) {
                     if (datiPartita.gameVersion === '1ed') aggiornaListaGiocatoriUI_1ed();
                    else if (datiPartita.gameVersion === '2ed') aggiornaListaGiocatoriUI_2ed();
                    else if (datiPartita.gameVersion === 'architects') aggiornaListaGiocatoriUI_architects();
                    else if (datiPartita.gameVersion === 'duel') aggiornaListaGiocatoriUI_duel();
                }
            }
            
            function showConfirmationModal(text, onConfirm) {
                ui.modal.text.textContent = text;
                onConfirmCallback = onConfirm;
                ui.modal.overlay.classList.add('visible');
            }

            function hideConfirmationModal() {
                ui.modal.overlay.classList.remove('visible');
                onConfirmCallback = null;
            }

            function initializeTranslations() {
                translations = {
                    newestFirst: { it: 'Dal pi√π recente', en: 'Newest First' },
                    oldestFirst: { it: 'Dal meno recente', en: 'Oldest First' },
                    mostUsedWonderInVersion: { it: 'Meraviglia pi√π usata', en: 'Most Used Wonder' },
                    highestScoreInVersion: { it: 'Punteggio pi√π alto', en: 'Highest Score' },
                    wins: { it: 'vittorie', en: 'wins'},
                    pageTitle: { it: 'Segnapunti 7 Wonders', en: '7 Wonders Score Sheet' },
                    startNewGame: { it: 'Inizia Nuova Partita', en: 'Start New Game' },
                    rulesClarifications: { it: 'Chiarimenti sul regolamento', en: 'Rules Clarifications' },
                    gameHistory: { it: 'Cronologia Partite', en: 'Game History' },
                    statistics: { it: 'Statistiche', en: 'Statistics' },
                    supportProject: { it: 'Supporta il Progetto', en: 'Support the Project' },
                    creditsText: { 
                        it: 'Sviluppato nel 2025 da Tommaso Ferrari. <br>Email: <a href="mailto:tommy.ferrari98@gmail.com">tommy.ferrari98@gmail.com</a> | Versione 1.0',
                        en: 'Developed in 2025 by Tommaso Ferrari. <br>Email: <a href="mailto:tommy.ferrari98@gmail.com">tommy.ferrari98@gmail.com</a> | Version 1.0'
                    },
                    chooseGameVersion: { it: 'Scegli la Versione del Gioco', en: 'Choose Game Version' },
                    game1stEdition: { it: 'Prima Edizione', en: 'First Edition' },
                    game2ndEdition: { it: 'Seconda Edizione', en: 'Second Edition' },
                    backToGameSelect: { it: 'Torna alla Scelta', en: 'Back to Selection' },
                    setupGame1ed: { it: 'Imposta Partita', en: 'Set Up Game' },
                    setupGame2ed: { it: 'Imposta Partita', en: 'Set Up Game' },
                    setupGameArchitects: { it: 'Imposta Partita', en: 'Set Up Game' },
                    setupGameDuel: { it: 'Imposta Partita', en: 'Set Up Game' },
                    rulesEditionNote: {
                        it: '<b>Nota:</b> I seguenti chiarimenti si riferiscono specificamente a <b>7 Wonders (Seconda Edizione)</b> e le sue espansioni.',
                        en: '<b>Note:</b> The following clarifications refer specifically to <b>7 Wonders (Second Edition)</b> and its expansions.'
                    },
                    rulesDisclaimer: { 
                        it: 'Questi chiarimenti sono basati sulle risposte alle FAQ presenti sul sito ufficiale del gioco o sono stati richiesti direttamente a Repos Production.',
                        en: 'These clarifications are based on the FAQ answers on the official game website or were requested directly from Repos Production.'
                    },
                    backToHome: { it: 'Torna alla Home', en: 'Back to Home' },
                    playerNamePlaceholder: { it: 'Nome giocatore...', en: 'Player name...' },
                    add: { it: 'Aggiungi', en: 'Add' },
                    playersAndWonders: { it: 'Giocatori e Meraviglie', en: 'Players & Wonders' },
                    teamGame: { it: 'Partita a squadre', en: 'Team Game' },
                    randomWonders: { it: 'Meraviglie casuali üîÄ', en: 'Random Wonders üîÄ' },
                    expansions: { it: 'Espansioni', en: 'Expansions' },
                    expGreatWall: { it: 'Grande Muraglia Cinese', en: 'Great Wall of China' },
                    location: { it: 'Luogo', en: 'Location' },
                    locationPlaceholder: { it: 'Luogo della partita...', en: 'Location of the game...' },
                    dateAndTime: { it: 'Data e ora', en: 'Date and Time' },
                    useManualDate: { it: 'Usa data e ora manuale', en: 'Use manual date and time' },
                    reset: { it: 'Reset', en: 'Reset' },
                    start: { it: 'Inizia', en: 'Start' },
                    backToSetup: { it: 'Torna al Setup', en: 'Back to Setup' },
                    back: { it: '‚Üê Indietro', en: '‚Üê Back' },
                    next: { it: 'Avanti', en: 'Next' },
                    notEnoughWonders: { it: 'Non ci sono abbastanza meraviglie uniche per tutti i giocatori.', en: 'Not enough unique wonders for all players.' },
                    chooseWonder: { it: 'Scegli Meraviglia', en: 'Choose Wonder' },
                    deletePlayer: { it: 'Elimina giocatore', en: 'Delete player' },
                    editGame: { it: 'Modifica partita', en: 'Edit game' },
                    deleteGame: { it: 'Elimina partita', en: 'Delete game' },
                    deleteGameConfirm: { it: 'Sei sicuro di voler eliminare questa partita? L\'azione √® irreversibile.', en: 'Are you sure you want to delete this game? This action is irreversible.' },
                    confirm: { it: 'Conferma', en: 'Confirm' },
                    cancel: { it: 'Annulla', en: 'Cancel' },
                    team: { it: 'Squadra', en: 'Team' },
                    guildsWarning: {
                        it: 'Attenzione: con l\'espansione Armada ogni Gilda pu√≤ valere un massimo di 10 punti vittoria.',
                        en: 'Warning: with the Armada expansion, each Guild can be worth a maximum of 10 victory points.'
                    },
                    treasuryCoinInfo: {
                        it: 'Inserire il numero di monete. Il punteggio finale sar√† calcolato dividendo per 3.',
                        en: 'Enter the number of coins. The final score will be calculated by dividing by 3.'
                    },
                    instantVictory: { it: 'Vittoria Istantanea', en: 'Instant Victory' },
                    militarySupremacy: { it: 'Supremazia Militare', en: 'Military Supremacy' },
                    scientificSupremacy: { it: 'Supremazia Scientifica', en: 'Scientific Supremacy' },
                    politicalSupremacy: { it: 'Supremazia Politica', en: 'Political Supremacy' },
                    winsBy: { it: 'vince per', en: 'wins by' },
                    recalculateResults: { it: 'Ricalcola Risultati', en: 'Recalculate Results' },
                    seeResults: { it: 'Vedi Risultati', en: 'See Results' },
                    finalRanking: { it: 'Classifica Finale', en: 'Final Ranking' },
                    noWonder: { it: 'Nessuna', en: 'None' },
                    freeCity: { it: 'Citt√† Franca', en: 'Free City' },
                    shareResults: { it: 'Condividi Risultati', en: 'Share Results' },
                    newGame: { it: 'Nuova Partita', en: 'New Game' },
                    winner: { it: 'Vincitore', en: 'Winner' },
                    winners: { it: 'Vincitori', en: 'Winners' },
                    teamWinner: { it: 'Squadra Vincitrice', en: 'Winning Team' },
                    tie: { it: 'Pareggio', en: 'Tie' },
                    noHistory: { it: 'Nessuna partita trovata nella cronologia.', en: 'No games found in history.' },
                    overallStats: { it: 'Statistiche generali', en: 'Overall Stats' },
                    playerStats: { it: 'Statistiche giocatore', en: 'Player Stats' },
                    totalGames: { it: 'Partite totali', en: 'Total Games' },
                    mostPlayedWonder: { it: 'Meraviglia pi√π giocata', en: 'Most Played Wonder' },
                    mostWinningPlayer: { it: 'Giocatore pi√π vincente', en: 'Most Winning Player' },
                    highestScore: { it: 'Punteggio pi√π alto', en: 'Highest Score' },
                    selectPlayer: { it: 'Seleziona un giocatore', en: 'Select a player' },
                    selectGame: { it: 'Filtra per versione', en: 'Filter by version' },
                    allGames: { it: 'Tutti le versioni', en: 'All games' },
                    gamesPlayed: { it: 'Partite giocate', en: 'Games Played' },
                    winRate: { it: 'Tasso di vittoria', en: 'Win Rate' },
                    wonLost: { it: 'Vinte/Perse', en: 'Won/Lost' },
                    avgScore: { it: 'Punteggio medio', en: 'Average Score' },
                    noStats: { it: 'Nessuna statistica disponibile. Gioca qualche partita!', en: 'No stats available. Play some games!' },
                    catWonder: { it: 'Meraviglia', en: 'Wonder Board' },
                    catWonders: { it: 'Meraviglie', en: 'Wonders' },
                    catWonderStages: { it: 'Stadi Meraviglia', en: 'Wonder Stages' },
                    catNumStages: { it: 'Numero di Stadi', en: 'Number of Stages' },
                    catNumStages_desc: { it: 'Inserire il numero di stadi della meraviglia realizzati da ciascun giocatore ai fini del calcolo del vincitore in caso di spareggio.', en: 'Enter the number of wonder stages built by each player to determine the winner in case of a tie.' },
                    catTreasury: { it: 'Tesoro', en: 'Treasure' },
                    catDebts: { it: 'Debiti', en: 'Debts' },
                    catMilitary: { it: 'Conflitti Militari', en: 'Military Conflicts' },
                    catCivilian: { it: 'Edifici Civili', en: 'Civil Buildings' },
                    catDuelCivilian: { it: 'Strutture Civili', en: 'Civilian Structures' },
                    catCommercial: { it: 'Edifici Commerciali', en: 'Commercial Buildings' },
                    catDuelCommercial: { it: 'Strutture Commerciali', en: 'Commercial Buildings' },
                    catScience: { it: 'Edifici Scientifici', en: 'Scientific Buildings' },
                    catDuelScientific: { it: 'Strutture Scientifiche', en: 'Scientific Structures' },
                    catProgressTokens: { it: 'Segnalini Progresso', en: 'Progress Tokens' },
                    catProgress: { it: 'Progresso', en: 'Progress' },
                    catGuilds: { it: 'Gilde', en: 'Guilds' },
                    catCities: { it: 'Cities', en: 'Cities' },
                    catLeaders: { it: 'Leader', en: 'Leaders' },
                    catNaval: { it: 'Conflitti Navali', en: 'Naval Conflicts' },
                    catNavalBlue: { it: 'Percorso Navale Blu', en: 'Blue Naval Track' },
                    catIslands: { it: 'Isole', en: 'Islands' },
                    catEdifice: { it: 'Edifici', en: 'Edifices' },
                    catCatPawn: {it: 'Pedina Gatto', en: 'Cat Pawn'},
                    catMedals: {it: 'Medaglie', en: 'Medals'},
                    catGods: {it: 'Divinit√†', en: 'Gods'},
                    catGrandTemples: {it: 'Grandi Templi', en: 'Grand Temples'},
                    catSenateChambers: {it: 'Camere del Senato', en: 'Senate Chambers'},
                    expDuelPantheon: { it: 'Pantheon', en: 'Pantheon' },
                    expDuelAgora: { it: 'Agora', en: 'Agora' },
                    expDuelMesse: { it: 'Messe', en: 'Messe' },
                    expDuelStatue: { it: 'Statua della Libert√†', en: 'Statue of Liberty' },
                    expDuelStonehenge: { it: 'Stonehenge', en: 'Stonehenge' },
                    expDuelSagrada: { it: 'Sagrada Familia', en: 'Sagrada Familia' },
                    gameVersionMap: {
                        '1ed': { it: '7 Wonders (Prima Edizione)', en: '7 Wonders (First Edition)' },
                        '2ed': { it: '7 Wonders (Seconda Edizione)', en: '7 Wonders (Second Edition)' },
                        'architects': { it: '7 Wonders: Architects', en: '7 Wonders: Architects' },
                        'duel': { it: '7 Wonders: Duel', en: '7 Wonders: Duel' }
                    },
                    rulesBaseGame_title: { it: '7 Wonders (Versione Base)', en: '7 Wonders (Base Game)' },
                    rulesLeaders_title: { it: 'Leaders', en: 'Leaders' },
                    rulesArmada_title: { it: 'Armada', en: 'Armada' },
                    rulesCities_title: { it: 'Cities', en: 'Cities' },
                    rulesEdifice_title: { it: 'Edifice', en: 'Edifice' },
                    rulesPromo_title: { it: 'Carte e Meraviglie Promo', en: 'Promo Cards & Wonders' },
                    rulesBaseGame: {
                        it: [
                            "Con il secondo stadio di Olymp√≠a (Giorno), puoi costruire gratuitamente solo la prima carta Epoca di un colore non ancora presente nella tua citt√†, indipendentemente dall'Epoca. Se, ad esempio, hai gi√† costruito una carta Blu in precedenza, non puoi costruirne una gratuitamente tramite questo effetto.",
                            "Non puoi utilizzare l'effetto di Halikarnassos per costruire gratuitamente uno stadio della Meraviglia con una carta dalla pila degli scarti.",
                            "Non puoi costruire stadi della Meraviglia o carte Leader gratuitamente con l'effetto degli stadi 1 e 2 di Olymp√≠a (Notte).",
                            "Con il primo stadio di Olympia (Notte), puoi costruire gratuitamente la prima carta che scegli all'inizio di ogni Epoca, non puoi invece reclutare una carta Leader.",
                            "Solo in un caso estremamente raro √® di fatto possibile utilizzare l'effetto del primo stadio di Olympia (Notte) all'inizio dell'Epoca I, quello in cui si sta utilizzando l'espansione Leaders, entrambi i tuoi vicini producono Minerale come risorsa di partenza e tu hai costruito il primo stadio di Olimp√≠a con il tuo primo Leader.",
                            "Se un giocatore rivela la propria carta Epoca per costruirla ma si accorge di non avere le risorse sufficienti e di non poterle acquistare in alcun modo, deve scartare quella carta e guadagnare 3 monete.",
                            "Se pi√π giocatori devono pescare dalla pila degli scarti nello stesso turno, questo √® l'ordine di risoluzione degli effetti: Salomone, Halikarnassos, Carthage, Grande Muraglia Cinese, Manneken Pis, Societ√† dei Falsari."
                        ],
                        en: [
                            "With the second stage of Olympia (Day side), you can only build the first Age card of a color not yet present in your city for free, regardless of the Age. For example, if you have already built a Blue card previously, you cannot build one for free using this effect.",
                            "You cannot use the effect of Halikarnassos to build a Wonder stage for free with a card from the discard pile.",
                            "You cannot build Wonder stages or Leader cards for free with the effect of stages 1 and 2 of Olymp√≠a (Night side).",
                            "With the first stage of Olymp√≠a (Night side), you can build the first card you choose at the beginning of each Age for free; you cannot recruit a Leader card instead.",
                            "Only in an extremely rare case is it actually possible to use the effect of the first stage of Olympia (Night side) at the beginning of Age I: when using the Leaders expansion, both your neighbors produce Ore as a starting resource, and you have built the first stage of Olympia with your first Leader.",
                            "If a player reveals their Age card to build it but realizes they do not have enough resources and cannot purchase them in any way, they must discard that card and gain 3 coins.",
                            "If multiple players need to draw from the discard pile in the same turn, this is the order of effect resolution: Solomon, Halikarnassos, Carthage, Great Wall of China, Manneken Pis, Forging Agency."
                        ]
                    },
                    rulesLeaders: {
                        it: [
                            "Le carte Leader devono essere scartate separatamente dalle carte Epoca. Gli effetti di Halikarnassos, Salomone, Societ√† dei Falsari, Manneken Pis e Grande Muraglia Cinese permettono di costruire gratuitamente solo una carta Epoca dalla pila degli scarti corrispondente.",
                            "Non puoi reclutare Leader gratuitamente con l'effetto del primo stadio di Olymp√≠a (Notte).",
                            "Quando costruisci il secondo e terzo stadio di Roma (Notte), puoi usare le monete ottenute all'inizio del turno per pagare il costo di reclutamento del Leader.",
                            "Con Hatshepsut, guadagni 1 moneta dalla riserva anche quando acquisti una risorsa al costo di O monete, ad esempio combinando gli effetti di Stazione Commerciale Est e Molo Clandestino Est.",
                            "Puoi combinare gli effetti di Hatshepsut e Berenice, ma solo con uno dei tuoi vicini per turno.",
                            "Se Telesilla e Nitocris vengono reclutati nello stesso turno, il segnalino Vittoria Militare guadagnato con Nitocris pu√≤ essere distrutto dall'effetto di Telesilla, dal momento che in 7 Wonders la perdita di segnalini e il pagamento di tributi avvengono sempre alla fine di un turno.",
                            "L'effetto di Berenice √® valido anche quando si guadagnano monete per effetto di un Edificio (se si sta utilizzando l'espansione Edifice)."
                        ],
                        en: [
                            "Leader cards must be discarded separately from Age cards. The effects of Halikarnassos, Solomon, Forging Agency, Manneken Pis, and Great Wall of China only allow building an Age card for free from the corresponding discard pile.",
                            "You cannot recruit Leaders for free with the effect of the first stage of Olympia (Night side).",
                            "When you build the second and third stages of Rome (Night side), you can use the coins obtained at the beginning of the turn to pay the recruitment cost of the Leader.",
                            "With Hatshepsut, you gain 1 coin from the bank even when you purchase a resource at the cost of O coins, for example by combining the effects of East Trading Post and East Clandestine Wharf.",
                            "You can combine the effects of Hatshepsut and Berenice, but only with one of your neighbors per turn.",
                            "If Telesilla and Nitocris are recruited in the same turn, the Military Victory token gained with Nitocris can be destroyed by Telesilla's effect, since in 7 Wonders the loss of tokens and payment of tributes always occur at the end of a turn.",
                            "Berenice's effect is also valid when gaining coins from an Edifice's effect (if using the Edifice expansion)."
                        ]
                    },
                    rulesArmada: {
                        it: [
                            "L'icona della Piramide completa sulla meraviglia Siracusa indica che puoi costruire gli stadi di Siracusa nell'ordine che preferisci.",
                            "Non puoi copiare un simbolo scientifico Maggioranza con un simbolo scientifico Maschera (Cities), poich√© il simbolo Maggioranza non √® considerato un simbolo scientifico vero e proprio.",
                            "Con il Leader Tomiri, se vieni sconfitto in un'Incursione, devi dare il segnalino Sconfitta Militare al giocatore che ha vinto l'Incursione, non a uno dei tuoi due vicini.",
                            "Se pi√π giocatori attivano due tributi dello stesso tipo e importo nello stesso turno, ciascuno paga anch'egli (una volta) il tributo innescato dagli altri.",
                            "Se vengono innescati tributi di tipo diverso (es. uno tramite una carta Epoca gialla e uno tramite il Percorso Navale giallo), vanno applicati entrambi."
                        ],
                        en: [
                            "The complete Pyramid icon on the Siracusa wonder indicates that you can build the stages of Siracusa in any order you prefer.",
                            "You cannot copy a Majority scientific symbol with a Mask scientific symbol (Cities), as the Majority symbol is not considered a true scientific symbol.",
                            "With the Leader Tomyris, if you are defeated in a Boarding, you must give the Military Defeat token to the player who won the Boarding, not to one of your two neighbors.",
                            "If multiple players trigger two tributes of the same type and amount in the same turn, each one also pays (once) the tribute triggered by the others.",
                            "If tributes of different types are triggered (e.g., one via a yellow Age card and one via the yellow Naval Track), both must be applied."
                        ]
                    },
                    rulesCities: {
                        it: [
                            "Non si possono prendere segnalini Debito volontariamente.",
                            "In una partita a 3 giocatori, se durante una Risoluzione dei Conflitti Militari 2 giocatori hanno un segnalino Diplomazia, il terzo giocatore non svolge alcun Conflitto Militare.",
                            "In una partita a squadre, se due avversari hanno entrambi un segnalino Diplomazia, nessuno dei due svolge alcun Conflitto Militare in quell'Epoca.",
                            "Se in un turno decidi di produrre una specifica risorsa tramite una carta Marrone che permette di scegliere tra due risorse possibili a ogni turno, non puoi produrre comunque l'altra tramite l'effetto del Mercato Nero."
                        ],
                        en: [
                            "You cannot voluntarily take Debt tokens.",
                            "In a 3-player game, if during a Military Conflict resolution 2 players have a Diplomacy token, the third player does not engage in any Military Conflict.",
                            "In a team game, if two opponents both have a Diplomacy token, neither of them engages in any Military Conflict in that Age.",
                            "If in a turn you decide to produce a specific resource through a Brown card that allows choosing between two possible resources each turn, you cannot also produce the other one through the effect of the Black Market."
                        ]
                    },
                    rulesEdifice: {
                        it: [
                            "Non puoi acquistare risorse che un vicino produce perch√© ha partecipato alla costruzione di un Edificio.",
                            "L'effetto del Mercato Nero e del Magazzino Segreto non si applicano alle risorse ottenute dagli Edifici."
                        ],
                        en: [
                            "You cannot purchase resources that a neighbor produces because they participated in the construction of an Edifice.",
                            "The effects of the Black Market and the Secret Warehouse do not apply to resources obtained from Edifices."
                        ]
                    },
                    rulesPromo: {
                        it: [
                            "Con C√©drick & Thomas, se scegli l'aquila, tutti i giocatori risolvono due volte anche le Incursioni. Non si risolvono invece due volte i Conflitti Navali.",
                            "Con la Gilda degli Architetti, il punteggio √® limitato a un massimo di 10 Punti Vittoria se giochi con l'espansione Armada (es: se i due vicini hanno in totale 4 gilde, guadagni 10 PV, non 12).",
                            "Con la Gilda dei Giocatori, i punti devono essere calcolati per ogni vicino separatamente (es: 4 monete a sinistra = 1 PV, 2 monete a destra = 0 PV. Totale = 1 PV. Non si calcolano i punti sul totale delle monete, quindi in questo caso non si ottengono 2 PV).",
                            "Manneken Pis non pu√≤ copiare il 3¬∞ stadio di una meraviglia che ha 4 stadi (es. Gizah).",
                            "Ai fini degli effetti del Manneken Pis, il 2¬∞ stadio di una meraviglia a 2 stadi (es. Rhodos) √® considerato sia il secondo che l'ultimo. Il Manneken Pis pu√≤ copiarlo tramite il proprio 2¬∞ o 3¬∞ stadio, a seconda della posizione.",
                            "Come Roma (Notte), con il Manneken Pis si pu√≤ conservare la quarta carta Leader per giocarla in seguito copiando l'effetto di Roma.",
                            "Il Manneken Pis pu√≤ copiare l'effetto di Abu Simbel ma deve sacrificare uno dei propri Leader per ottenere punti, anche se non c'√® lo slot Sarcofago. Non copia i punti che l'avversario totalizzer√† a fine partita con i Leader sacrificati da quest'ultimo.",
                            "Il simbolo Torre che compare sugli stadi della Grande Muraglia indica che puoi costruire gli stadi di questa meraviglia nell'ordine che preferisci.",
                            "Se il giocatore che possiede il Manneken Pis confina con Siracusa o con la Grande Muraglia Cinese, pu√≤ scegliere quale stadio copiare. Pu√≤ anche copiare lo stesso stadio due volte."
                        ],
                        en: [
                            "With C√©drick & Thomas, if you choose the eagle, all players also resolve Boardings twice. Naval Conflicts are not resolved twice.",
                            "With the Architects Guild, the score is limited to a maximum of 10 Victory Points if you play with the Armada expansion (e.g., if the two neighbors have a total of 4 guilds, you gain 10 VP, not 12).",
                            "With the Gamers Guild, points must be calculated for each neighbor separately (e.g., 4 coins on the left = 1 VP, 2 coins on the right = 0 VP. Total = 1 VP. Points are not calculated on the total number of coins, so in this case, you do not get 2 VP).",
                            "Manneken Pis cannot copy the 3rd stage of a 4-stage wonder (e.g., Giza).",
                            "For the purposes of Manneken Pis's effects, the 2nd stage of a 2-stage wonder (e.g., Rhodos) is considered both the second and the last. Manneken Pis can copy it with its own 2nd or 3rd stage, depending on its position.",
                            "Like Rome (Night side), with Manneken Pis you can keep the fourth Leader card to play it later by copying Rome's effect.",
                            "Manneken Pis can copy the effect of Abu Simbel but must sacrifice one of its own Leaders to get points, even if there is no Sarcophagus slot. It does not copy the points that the opponent will score at the end of the game with the Leaders sacrificed by them.",
                            "The Tower symbol that appears on the stages of the Great Wall of China indicates that you can build the stages of this wonder in any order you prefer.",
                            "If the player who owns Manneken Pis is adjacent to Siracusa or the Great Wall of China, they can choose which stage to copy. They can also copy the same stage twice."
                        ]
                    }
                };
            }
            
            // ===============================================
            // C. LOGICA CORE DELL'APP E ARCHIVIAZIONE
            // ===============================================
            
            function getGameHistory() {
                try {
                    const history = localStorage.getItem('7wondersGameHistory');
                    return history ? JSON.parse(history) : [];
                } catch (e) {
                    console.error("Failed to load game history:", e);
                    return [];
                }
            }

            function saveGameToHistory(gameData) {
                try {
                    const history = getGameHistory();
                    const gameToSave = JSON.parse(JSON.stringify(gameData)); // Deep copy
                    delete gameToSave.isEditing; // Rimuove lo stato di modifica
                    
                    const existingGameIndex = history.findIndex(g => g.idPartita === gameToSave.idPartita);
                    if (existingGameIndex > -1) {
                        history[existingGameIndex] = gameToSave; 
                    } else {
                        history.push(gameToSave);
                    }
                    localStorage.setItem('7wondersGameHistory', JSON.stringify(history));
                } catch (e) {
                    console.error("Failed to save game history:", e);
                }
            }

            function deleteGameFromHistory(gameId) {
                let history = getGameHistory();
                history = history.filter(g => g.idPartita !== gameId);
                localStorage.setItem('7wondersGameHistory', JSON.stringify(history));
                displayGameHistory();
                calculateAndDisplayStats();
            }

            function mostraSezione(nomeSezione) { 
                for (const key in sezioni) { 
                    sezioni[key].classList.toggle('hidden', key !== nomeSezione); 
                }
                const isLanding = nomeSezione === 'landing';
                document.getElementById('language-switcher').classList.toggle('hidden', !isLanding);
                ui.appSubtitle.classList.toggle('hidden', !isLanding);
                ui.credits.classList.toggle('hidden', !isLanding);
            }

            function resetStato(gameVersion) { 
                datiPartita = { 
                    gameVersion: gameVersion,
                    giocatori: [], 
                    categoriaCorrenteIndex: 0, 
                    categoriePartita: [], 
                    espansioni: {}, 
                    idPartita: `game_${Date.now()}`
                }; 
            }
            
            // ===================================================
            // D. LOGICA 1A EDIZIONE
            // ===================================================

            const setup1ed = {
                inputs: {
                    nomeGiocatore: document.getElementById('nomeGiocatoreInput-1ed'),
                    teamPlay: document.getElementById('team-play-checkbox-1ed'),
                    luogoPartita: document.getElementById('luogoPartitaInput-1ed'),
                    dateToggle: document.getElementById('date-toggle-1ed'), 
                    manualDateInput: document.getElementById('manual-date-input-1ed'),
                    esp: { 
                        cities: document.getElementById('esp-1ed-cities'), 
                        leaders: document.getElementById('esp-1ed-leaders'), 
                        armada: document.getElementById('esp-1ed-armada'), 
                        babel: document.getElementById('esp-1ed-babel'),
                        wonderpack: document.getElementById('esp-1ed-wonderpack'),
                        siracusa: document.getElementById('esp-1ed-siracusa'),
                        catan: document.getElementById('esp-1ed-catan')
                    }
                },
                bottoni: {
                    aggiungiGiocatore: document.getElementById('aggiungiGiocatoreBtn-1ed'),
                    iniziaPartita: document.getElementById('iniziaPartitaBtn-1ed'),
                    randomWonder: document.getElementById('randomWonderBtn-1ed'),
                },
                ui: {
                    listaGiocatori: document.getElementById('listaGiocatori-1ed'),
                    teamPlayContainer: document.getElementById('team-play-container-1ed'),
                    manualDateContainer: document.getElementById('manual-date-container-1ed')
                }
            };
            
            function getWondersDisponibili_1ed() { 
                let w = [...MERAVIGLIE_1ED.base];
                for(const key in datiPartita.espansioni){
                    if(datiPartita.espansioni[key] && MERAVIGLIE_1ED[key]){
                        w.push(...MERAVIGLIE_1ED[key]);
                    }
                }
                return w.sort(); 
            }
            
            function aggiornaListaGiocatoriUI_1ed() {
                updateExpansions_1ed(); 
                
                const freeCityName = translations.freeCity[currentLanguage];
                const realPlayerCount = datiPartita.giocatori.filter(g => !g.isFreeCity).length;
                const hasFreeCity = datiPartita.giocatori.some(g => g.nome === freeCityName);

                if (realPlayerCount === 2 && !hasFreeCity) {
                     datiPartita.giocatori.push({ nome: freeCityName, meraviglia: '', isFreeCity: true, team: 'A', punteggi: {}, totale: 0 });
                } else if (realPlayerCount !== 2 && hasFreeCity) {
                    datiPartita.giocatori = datiPartita.giocatori.filter(g => g.nome !== freeCityName);
                }

                setup1ed.ui.listaGiocatori.innerHTML = '';
                const wondersDisponibili = getWondersDisponibili_1ed();
                const teamPlayActive = setup1ed.inputs.teamPlay.checked;
                
                datiPartita.giocatori.forEach((g, index) => {
                    const li = document.createElement('li');
                    li.className = 'giocatore-setup-item';
                    
                    const nomeInput = document.createElement('input');
                    nomeInput.type = 'text';
                    nomeInput.className = 'nome-giocatore-input';
                    nomeInput.value = g.nome;
                    nomeInput.dataset.index = index;
                    if(g.isFreeCity) {
                        nomeInput.disabled = true;
                    } else {
                        nomeInput.addEventListener('input', (e) => {
                            datiPartita.giocatori[index].nome = e.target.value;
                        });
                    }
                    li.appendChild(nomeInput);

                     if(teamPlayActive) {
                        const teamSelect = document.createElement('select');
                        teamSelect.className = 'team-select';
                        let teamOptions = ['A', 'B'];
                        if (datiPartita.giocatori.length === 6) teamOptions = ['A', 'B', 'C'];
                        if (datiPartita.giocatori.length === 8) teamOptions = ['A', 'B', 'C', 'D'];
                        const teamLabel = translations.team[currentLanguage];
                        teamSelect.innerHTML = teamOptions.map(t => `<option value="${t}" ${g.team === t ? 'selected' : ''}>${teamLabel} ${t}</option>`).join('');
                        teamSelect.addEventListener('change', (e) => { g.team = e.target.value; });
                        li.appendChild(teamSelect);
                    }

                    const selectEl = document.createElement('select');
                    selectEl.className = 'wonder-select'; 
                    selectEl.innerHTML = `<option value="">${translations.chooseWonder[currentLanguage]}</option>`;
                    wondersDisponibili.forEach(w => { 
                        const o = document.createElement('option'); 
                        o.value = w; 
                        o.textContent = getWonderName(w); 
                        if (g.meraviglia === w) o.selected = true; 
                        selectEl.appendChild(o); 
                    });
                    selectEl.addEventListener('change', (e) => { g.meraviglia = e.target.value; });
                    li.appendChild(selectEl); 
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-player-btn';
                    deleteBtn.innerHTML = '&#10006;';
                    deleteBtn.title = translations.deletePlayer[currentLanguage];
                    if (g.isFreeCity) {
                        deleteBtn.disabled = true;
                    } else {
                         deleteBtn.addEventListener('click', () => {
                            datiPartita.giocatori.splice(index, 1);
                            aggiornaListaGiocatoriUI_1ed();
                        });
                    }
                    li.appendChild(deleteBtn);

                    setup1ed.ui.listaGiocatori.appendChild(li);
                });
                const num = datiPartita.giocatori.filter(g => !g.isFreeCity).length;
                setup1ed.bottoni.iniziaPartita.disabled = num < 2;

                const canPlayTeams = num === 4 || num === 6 || num === 8;
                setup1ed.ui.teamPlayContainer.classList.toggle('hidden', !canPlayTeams);
                if (!canPlayTeams) {
                    setup1ed.inputs.teamPlay.checked = false;
                }
                updateExpansions_1ed(true);
            }

            function aggiungiGiocatore_1ed() {
                const nome = setup1ed.inputs.nomeGiocatore.value.trim();
                const realPlayerCount = datiPartita.giocatori.filter(g => !g.isFreeCity).length;
                if (nome && realPlayerCount < 8) {
                    datiPartita.giocatori.push({ nome, meraviglia: '', team: 'A', punteggi: {}, totale: 0 });
                    setup1ed.inputs.nomeGiocatore.value = '';
                    aggiornaListaGiocatoriUI_1ed();
                    setup1ed.inputs.nomeGiocatore.focus();
                }
            }
            
            function assegnaMeraviglieCasuali_1ed() {
                const numGiocatori = datiPartita.giocatori.length;
                if (numGiocatori === 0) return;
                let wonders = getWondersDisponibili_1ed();
                if (wonders.length < numGiocatori) {
                    alert(translations.notEnoughWonders[currentLanguage]);
                    return;
                }
                for (let i = wonders.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [wonders[i], wonders[j]] = [wonders[j], wonders[i]];
                }
                datiPartita.giocatori.forEach((g, i) => {
                    g.meraviglia = wonders[i];
                });
                aggiornaListaGiocatoriUI_1ed();
            }

            function avviaPartita_1ed() {
                updateExpansions_1ed(true);
                datiPartita.categoriePartita = CATEGORIE_1ED.filter(cat => !cat.expansion || datiPartita.espansioni[cat.expansion]);
                avviaPartitaGenerale();
            }

            function updateExpansions_1ed(isStartingGame = false) {
                 for (const key in setup1ed.inputs.esp) {
                    datiPartita.espansioni[key] = setup1ed.inputs.esp[key].checked;
                }
                if(isStartingGame){
                     datiPartita.espansioni.giocoASquadre = setup1ed.inputs.teamPlay.checked;
                     datiPartita.luogo = setup1ed.inputs.luogoPartita.value.trim();
                     datiPartita.manualDate = setup1ed.inputs.dateToggle.checked ? setup1ed.inputs.manualDateInput.value : null;
                }
            }

            // ===================================================
            // E. LOGICA 2A EDIZIONE
            // ===================================================
            
            const setup2ed = {
                 inputs: { 
                    nomeGiocatore: document.getElementById('nomeGiocatoreInput-2ed'), 
                    luogoPartita: document.getElementById('luogoPartitaInput-2ed'), 
                    esp: { 
                        cities: document.getElementById('esp-2ed-cities'), 
                        leaders: document.getElementById('esp-2ed-leaders'), 
                        armada: document.getElementById('esp-2ed-armada'), 
                        edifice: document.getElementById('esp-2ed-edifice'), 
                        greatwall: document.getElementById('esp-2ed-greatwall'),
                        mannekenpis: document.getElementById('esp-2ed-mannekenpis')
                    }, 
                    teamPlay: document.getElementById('team-play-checkbox-2ed'), 
                    dateToggle: document.getElementById('date-toggle-2ed'), 
                    manualDateInput: document.getElementById('manual-date-input-2ed') 
                },
                bottoni: {
                    aggiungiGiocatore: document.getElementById('aggiungiGiocatoreBtn-2ed'),
                    iniziaPartita: document.getElementById('iniziaPartitaBtn-2ed'),
                    randomWonder: document.getElementById('randomWonderBtn-2ed'),
                    resetSettings: document.getElementById('resetSettingsBtn-2ed'),
                },
                ui: {
                    listaGiocatori: document.getElementById('listaGiocatori-2ed'),
                    teamPlayContainer: document.getElementById('team-play-container-2ed'),
                    manualDateContainer: document.getElementById('manual-date-container-2ed')
                }
            };

            function getWondersDisponibili_2ed() { 
                let w = [...MERAVIGLIE_2ED.base]; 
                for (const key in datiPartita.espansioni) {
                    if (datiPartita.espansioni[key] && MERAVIGLIE_2ED[key]) {
                        w.push(...MERAVIGLIE_2ED[key]);
                    }
                }
                return w.sort(); 
            }

            function aggiornaListaGiocatoriUI_2ed() {
                updateExpansions_2ed();
                setup2ed.ui.listaGiocatori.innerHTML = '';
                const wondersDisponibili = getWondersDisponibili_2ed();
                const teamPlayActive = setup2ed.inputs.teamPlay.checked;
                datiPartita.giocatori.forEach((g, index) => {
                    const li = document.createElement('li');
                    li.className = 'giocatore-setup-item';
                    
                    const nomeInput = document.createElement('input');
                    nomeInput.type = 'text';
                    nomeInput.className = 'nome-giocatore-input';
                    nomeInput.value = g.nome;
                    nomeInput.dataset.index = index;
                    nomeInput.addEventListener('input', (e) => {
                        datiPartita.giocatori[index].nome = e.target.value;
                    });
                    li.appendChild(nomeInput);

                    if(teamPlayActive) {
                        const teamSelect = document.createElement('select');
                        teamSelect.className = 'team-select';
                        const teamOptions = datiPartita.giocatori.length === 4 ? ['A', 'B'] : ['A', 'B', 'C'];
                        const teamLabel = translations.team[currentLanguage];
                        teamSelect.innerHTML = teamOptions.map(t => `<option value="${t}" ${g.team === t ? 'selected' : ''}>${teamLabel} ${t}</option>`).join('');
                        teamSelect.addEventListener('change', (e) => { g.team = e.target.value; });
                        li.appendChild(teamSelect);
                    }
                    
                    const selectEl = document.createElement('select');
                    selectEl.className = 'wonder-select'; 
                    selectEl.innerHTML = `<option value="">${translations.chooseWonder[currentLanguage]}</option>`;
                    wondersDisponibili.forEach(w => { 
                        const o = document.createElement('option'); 
                        o.value = w; 
                        o.textContent = getWonderName(w); 
                        if (g.meraviglia === w) o.selected = true; 
                        selectEl.appendChild(o); 
                    });
                    selectEl.addEventListener('change', (e) => { g.meraviglia = e.target.value; });
                    li.appendChild(selectEl); 
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-player-btn';
                    deleteBtn.innerHTML = '&#10006;';
                    deleteBtn.title = translations.deletePlayer[currentLanguage];
                    deleteBtn.addEventListener('click', () => {
                        datiPartita.giocatori.splice(index, 1);
                        aggiornaListaGiocatoriUI_2ed();
                    });
                    li.appendChild(deleteBtn);

                    setup2ed.ui.listaGiocatori.appendChild(li);
                });
                const num = datiPartita.giocatori.length;
                setup2ed.bottoni.iniziaPartita.disabled = num < 3;
                const canPlayTeams = num === 4 || num === 6;
                setup2ed.ui.teamPlayContainer.classList.toggle('hidden', !canPlayTeams);
                if (!canPlayTeams) {
                    setup2ed.inputs.teamPlay.checked = false;
                }
                 updateExpansions_2ed(true);
            }
            
            function aggiungiGiocatore_2ed() {
                const nome = setup2ed.inputs.nomeGiocatore.value.trim();
                if (nome && datiPartita.giocatori.length < 7) {
                    datiPartita.giocatori.push({ nome, meraviglia: '', team: 'A', punteggi: {}, totale: 0 });
                    setup2ed.inputs.nomeGiocatore.value = '';
                    aggiornaListaGiocatoriUI_2ed();
                    setup2ed.inputs.nomeGiocatore.focus();
                }
            }
            
            function assegnaMeraviglieCasuali_2ed() {
                const numGiocatori = datiPartita.giocatori.length;
                if (numGiocatori === 0) return;
                let wonders = getWondersDisponibili_2ed();
                if (wonders.length < numGiocatori) {
                    alert(translations.notEnoughWonders[currentLanguage]);
                    return;
                }
                for (let i = wonders.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [wonders[i], wonders[j]] = [wonders[j], wonders[i]];
                }
                datiPartita.giocatori.forEach((g, i) => {
                    g.meraviglia = wonders[i];
                });
                aggiornaListaGiocatoriUI_2ed();
            }
            
            function avviaPartita_2ed() {
                updateExpansions_2ed(true); 
                datiPartita.categoriePartita = CATEGORIE_2ED.filter(cat => !cat.expansion || datiPartita.espansioni[cat.expansion]);
                avviaPartitaGenerale();
            }
            
            function updateExpansions_2ed(isStartingGame = false) {
                 for (const key in setup2ed.inputs.esp) {
                    datiPartita.espansioni[key] = setup2ed.inputs.esp[key].checked;
                }
                if(isStartingGame){
                    datiPartita.espansioni.giocoASquadre = setup2ed.inputs.teamPlay.checked;
                    datiPartita.luogo = setup2ed.inputs.luogoPartita.value.trim();
                    datiPartita.manualDate = setup2ed.inputs.dateToggle.checked ? setup2ed.inputs.manualDateInput.value : null;
                }
            }

            // ===================================================
            // F. LOGICA ARCHITECTS
            // ===================================================

            const setupArchitects = {
                 inputs: { 
                    nomeGiocatore: document.getElementById('nomeGiocatoreInput-architects'), 
                    luogoPartita: document.getElementById('luogoPartitaInput-architects'),
                    dateToggle: document.getElementById('date-toggle-architects'), 
                    manualDateInput: document.getElementById('manual-date-input-architects'),
                    esp: {
                        medals: document.getElementById('esp-architects-medals')
                    }
                },
                bottoni: {
                    aggiungiGiocatore: document.getElementById('aggiungiGiocatoreBtn-architects'),
                    iniziaPartita: document.getElementById('iniziaPartitaBtn-architects'),
                    randomWonder: document.getElementById('randomWonderBtn-architects'),
                },
                ui: {
                    listaGiocatori: document.getElementById('listaGiocatori-architects'),
                    manualDateContainer: document.getElementById('manual-date-container-architects'),
                }
            };
            
            function getWondersDisponibili_architects() {
                let w = [...MERAVIGLIE_ARCHITECTS.base];
                if (datiPartita.espansioni.medals) {
                    w.push(...MERAVIGLIE_ARCHITECTS.medals);
                }
                return w.sort();
            }

            function aggiornaListaGiocatoriUI_architects() {
                updateExpansions_architects();
                setupArchitects.ui.listaGiocatori.innerHTML = '';
                const wondersDisponibili = getWondersDisponibili_architects();
                
                datiPartita.giocatori.forEach((g, index) => {
                    const li = document.createElement('li');
                    li.className = 'giocatore-setup-item';
                    
                    const nomeInput = document.createElement('input');
                    nomeInput.type = 'text';
                    nomeInput.className = 'nome-giocatore-input';
                    nomeInput.value = g.nome;
                    nomeInput.dataset.index = index;
                    nomeInput.addEventListener('input', (e) => {
                        datiPartita.giocatori[index].nome = e.target.value;
                    });
                    li.appendChild(nomeInput);

                    const selectEl = document.createElement('select');
                    selectEl.className = 'wonder-select'; 
                    selectEl.innerHTML = `<option value="">${translations.chooseWonder[currentLanguage]}</option>`;
                    wondersDisponibili.forEach(w => { 
                        const o = document.createElement('option'); 
                        o.value = w; 
                        o.textContent = getWonderName(w); 
                        if (g.meraviglia === w) o.selected = true; 
                        selectEl.appendChild(o); 
                    });
                    selectEl.addEventListener('change', (e) => { g.meraviglia = e.target.value; });
                    li.appendChild(selectEl); 
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-player-btn';
                    deleteBtn.innerHTML = '&#10006;';
                    deleteBtn.title = translations.deletePlayer[currentLanguage];
                    deleteBtn.addEventListener('click', () => {
                        datiPartita.giocatori.splice(index, 1);
                        aggiornaListaGiocatoriUI_architects();
                    });
                    li.appendChild(deleteBtn);

                    setupArchitects.ui.listaGiocatori.appendChild(li);
                });

                const num = datiPartita.giocatori.length;
                setupArchitects.bottoni.iniziaPartita.disabled = num < 2;
            }

            function aggiungiGiocatore_architects() {
                const nome = setupArchitects.inputs.nomeGiocatore.value.trim();
                if (nome && datiPartita.giocatori.length < 7) {
                    datiPartita.giocatori.push({ nome, meraviglia: '', punteggi: {}, totale: 0 });
                    setupArchitects.inputs.nomeGiocatore.value = '';
                    aggiornaListaGiocatoriUI_architects();
                    setupArchitects.inputs.nomeGiocatore.focus();
                }
            }

            function assegnaMeraviglieCasuali_architects() {
                const numGiocatori = datiPartita.giocatori.length;
                if (numGiocatori === 0) return;
                let wonders = getWondersDisponibili_architects();
                if (wonders.length < numGiocatori) {
                    alert(translations.notEnoughWonders[currentLanguage]);
                    return;
                }
                for (let i = wonders.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [wonders[i], wonders[j]] = [wonders[j], wonders[i]];
                }
                datiPartita.giocatori.forEach((g, i) => {
                    g.meraviglia = wonders[i];
                });
                aggiornaListaGiocatoriUI_architects();
            }


             function updateExpansions_architects() {
                 for (const key in setupArchitects.inputs.esp) {
                    datiPartita.espansioni[key] = setupArchitects.inputs.esp[key].checked;
                }
            }
            function avviaPartita_architects() {
                updateExpansions_architects();
                datiPartita.categoriePartita = CATEGORIE_ARCHITECTS.filter(cat => !cat.expansion || datiPartita.espansioni[cat.expansion]);
                datiPartita.luogo = setupArchitects.inputs.luogoPartita.value.trim();
                datiPartita.manualDate = setupArchitects.inputs.dateToggle.checked ? setupArchitects.inputs.manualDateInput.value : null;
                avviaPartitaGenerale();
            }

            // ===================================================
            // G. LOGICA DUEL
            // ===================================================

            const setupDuel = {
                 inputs: { 
                    nomeGiocatore: document.getElementById('nomeGiocatoreInput-duel'), 
                    luogoPartita: document.getElementById('luogoPartitaInput-duel'),
                    dateToggle: document.getElementById('date-toggle-duel'), 
                    manualDateInput: document.getElementById('manual-date-input-duel'),
                    esp: {
                        pantheon: document.getElementById('esp-duel-pantheon'),
                        agora: document.getElementById('esp-duel-agora'),
                        messe: document.getElementById('esp-duel-messe'),
                        statue: document.getElementById('esp-duel-statue'),
                        stonehenge: document.getElementById('esp-duel-stonehenge'),
                        sagrada: document.getElementById('esp-duel-sagrada')
                    }
                },
                bottoni: {
                    aggiungiGiocatore: document.getElementById('aggiungiGiocatoreBtn-duel'),
                    iniziaPartita: document.getElementById('iniziaPartitaBtn-duel'),
                    randomWonder: document.getElementById('randomWonderBtn-duel'),
                },
                ui: {
                    listaGiocatori: document.getElementById('listaGiocatori-duel'),
                    manualDateContainer: document.getElementById('manual-date-container-duel'),
                    instantVictoryContainer: document.getElementById('instant-victory-buttons-duel')
                }
            };
            
            function getWondersDisponibili_duel() {
                let w = [...MERAVIGLIE_DUEL.base];
                if (datiPartita.espansioni.pantheon) w.push(...MERAVIGLIE_DUEL.pantheon);
                if (datiPartita.espansioni.agora) w.push(...MERAVIGLIE_DUEL.agora);
                if (datiPartita.espansioni.messe) w.push(...MERAVIGLIE_DUEL.messe);
                if (datiPartita.espansioni.statue) w.push(...MERAVIGLIE_DUEL.statue);
                if (datiPartita.espansioni.stonehenge) w.push(...MERAVIGLIE_DUEL.stonehenge);
                if (datiPartita.espansioni.sagrada) w.push(...MERAVIGLIE_DUEL.sagrada);
                return w.sort();
            }
            
            function aggiornaListaGiocatoriUI_duel() {
                updateExpansions_duel();
                setupDuel.ui.listaGiocatori.innerHTML = '';
                
                datiPartita.giocatori.forEach((g, playerIndex) => {
                    const li = document.createElement('li');
                    li.className = 'giocatore-setup-item form-group-column';
                    li.style.alignItems = 'stretch';
                    
                    const header = document.createElement('div');
                    header.style.display = 'flex';
                    header.style.justifyContent = 'space-between';

                    const nomeInput = document.createElement('input');
                    nomeInput.type = 'text';
                    nomeInput.className = 'nome-giocatore-input';
                    nomeInput.value = g.nome;
                    nomeInput.dataset.index = playerIndex;
                    nomeInput.addEventListener('input', (e) => {
                        datiPartita.giocatori[playerIndex].nome = e.target.value;
                         aggiornaBottoniVittoriaIstantanea_duel();
                    });
                    header.appendChild(nomeInput);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-player-btn';
                    deleteBtn.innerHTML = '&#10006;';
                    deleteBtn.title = translations.deletePlayer[currentLanguage];
                    deleteBtn.addEventListener('click', () => {
                        datiPartita.giocatori.splice(playerIndex, 1);
                        aggiornaListaGiocatoriUI_duel();
                    });
                    header.appendChild(deleteBtn);
                    li.appendChild(header);

                    const wondersContainer = document.createElement('div');
                    wondersContainer.className = 'checkbox-container';
                    wondersContainer.style.marginTop = '10px';
                    
                    for (let i = 0; i < 4; i++) {
                         const selectEl = document.createElement('select');
                         selectEl.className = 'wonder-select'; 
                         selectEl.innerHTML = `<option value="">${translations.chooseWonder[currentLanguage]} #${i + 1}</option>`;
                         const wondersDisponibili = getWondersDisponibili_duel();
                         wondersDisponibili.forEach(w => { 
                             const o = document.createElement('option'); 
                             o.value = w; 
                             o.textContent = getWonderName(w); 
                             if (g.meraviglie && g.meraviglie[i] === w) o.selected = true; 
                             selectEl.appendChild(o); 
                         });
                         selectEl.addEventListener('change', (e) => { 
                             if (!g.meraviglie) g.meraviglie = [];
                             g.meraviglie[i] = e.target.value; 
                         });
                         wondersContainer.appendChild(selectEl);
                    }
                    li.appendChild(wondersContainer);

                    setupDuel.ui.listaGiocatori.appendChild(li);
                });

                const num = datiPartita.giocatori.length;
                setupDuel.bottoni.iniziaPartita.disabled = num !== 2;
                setupDuel.bottoni.aggiungiGiocatore.disabled = num >= 2;
                setupDuel.bottoni.randomWonder.disabled = num !== 2;
                aggiornaBottoniVittoriaIstantanea_duel();
            }
             function assegnaMeraviglieCasuali_duel() {
                const numGiocatori = datiPartita.giocatori.length;
                if (numGiocatori !== 2) return;

                let wonders = getWondersDisponibili_duel();
                if (wonders.length < 8) {
                    alert(translations.notEnoughWonders[currentLanguage]);
                    return;
                }
                
                for (let i = wonders.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [wonders[i], wonders[j]] = [wonders[j], wonders[i]];
                }
                
                datiPartita.giocatori[0].meraviglie = wonders.slice(0, 4);
                datiPartita.giocatori[1].meraviglie = wonders.slice(4, 8);
                
                aggiornaListaGiocatoriUI_duel();
            }

            function aggiungiGiocatore_duel() {
                const nome = setupDuel.inputs.nomeGiocatore.value.trim();
                if (nome && datiPartita.giocatori.length < 2) {
                    datiPartita.giocatori.push({ nome, punteggi: {}, totale: 0 });
                    setupDuel.inputs.nomeGiocatore.value = '';
                    aggiornaListaGiocatoriUI_duel();
                    setupDuel.inputs.nomeGiocatore.focus();
                }
            }
            
            function aggiornaBottoniVittoriaIstantanea_duel() {
                const container = setupDuel.ui.instantVictoryContainer;
                container.innerHTML = '';
                if(datiPartita.giocatori.length !== 2) return;

                const supremacyTypes = [
                    { key: 'militarySupremacy', label: translations.militarySupremacy[currentLanguage] },
                    { key: 'scientificSupremacy', label: translations.scientificSupremacy[currentLanguage] },
                ];
                if (datiPartita.espansioni.agora) {
                     supremacyTypes.push({ key: 'politicalSupremacy', label: translations.politicalSupremacy[currentLanguage] });
                }

                datiPartita.giocatori.forEach((player, index) => {
                    supremacyTypes.forEach(supremacy => {
                        const btn = document.createElement('button');
                        btn.className = 'bottone-grande';
                        btn.style.fontSize = '0.9em';
                        btn.textContent = `${player.nome || `Giocatore ${index+1}`} - ${supremacy.label}`;
                        btn.addEventListener('click', () => {
                            mostraVittoriaIstantanea(player.nome, supremacy.label);
                        });
                        container.appendChild(btn);
                    });
                });
            }

            function mostraVittoriaIstantanea(vincitore, motivo) {
                 const dataPartita = datiPartita.manualDate ? new Date(datiPartita.manualDate) : new Date();
                const locale = currentLanguage === 'it' ? 'it-IT' : 'en-US';
                datiPartita.data = datiPartita.data || dataPartita.toLocaleString(locale, { day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit' });
                datiPartita.luogo = setupDuel.inputs.luogoPartita.value.trim();

                sezioni.risultati.innerHTML = `
                    <div class="header-info">
                        <span>${datiPartita.data}${datiPartita.luogo ? `, ${datiPartita.luogo}` : ''}</span>
                    </div>
                    <h2 style="color: var(--colore-oro);">üèÜ ${vincitore} üèÜ</h2>
                    <p style="text-align: center; font-size: 1.2em;">${translations.winsBy[currentLanguage]} <strong>${motivo}</strong>!</p>
                `;
                 const btnGroupBottom = document.createElement('div');
                btnGroupBottom.className = 'gruppo-bottoni';
                const nuovaPartitaBtn = document.createElement('button');
                nuovaPartitaBtn.className = 'bottone-grande';
                nuovaPartitaBtn.textContent = translations.newGame[currentLanguage];
                nuovaPartitaBtn.addEventListener('click', () => {
                    mostraSezione(`setup-duel`);
                });
                btnGroupBottom.appendChild(nuovaPartitaBtn);
                sezioni.risultati.appendChild(btnGroupBottom);
                mostraSezione('risultati');
            }


            function updateExpansions_duel() {
                for (const key in setupDuel.inputs.esp) {
                    datiPartita.espansioni[key] = setupDuel.inputs.esp[key].checked;
                }
            }

            function avviaPartita_duel() {
                updateExpansions_duel();
                datiPartita.categoriePartita = CATEGORIE_DUEL.filter(cat => {
                    if (cat.key === 'gilde' && datiPartita.espansioni.pantheon) {
                        return false;
                    }
                    return !cat.expansion || datiPartita.espansioni[cat.expansion];
                });
                datiPartita.luogo = setupDuel.inputs.luogoPartita.value.trim();
                datiPartita.manualDate = setupDuel.inputs.dateToggle.checked ? setupDuel.inputs.manualDateInput.value : null;
                avviaPartitaGenerale();
            }


            // ===================================================
            // H. LOGICA DI PUNTEGGIO E RISULTATI (CONDIVISA)
            // ===================================================

            function avviaPartitaGenerale() {
                if (!datiPartita.isEditing) {
                    datiPartita.categoriaCorrenteIndex = 0;
                } else if (datiPartita.categoriaCorrenteIndex >= datiPartita.categoriePartita.length) {
                    datiPartita.categoriaCorrenteIndex = datiPartita.categoriePartita.length - 1;
                }
                delete datiPartita.isEditing; // Rimuovi il flag dopo l'uso
                mostraSezione('punteggio');
                mostraSchermataCategoria();
            }

            function mostraSchermataCategoria() {
                const index = datiPartita.categoriaCorrenteIndex;
                const categoria = datiPartita.categoriePartita[index];
                if (!categoria) return;

                ui.titoloCategoria.innerHTML = `${categoria.label.split(' ')[0]} ${translations[categoria.langKey][currentLanguage]}`;
                ui.titoloCategoria.style.backgroundColor = categoria.color || 'transparent';
                ui.inputsContainer.innerHTML = '';
                 if (categoria.descLangKey) {
                    const desc = document.createElement('p');
                    desc.id = 'avviso-categoria'; 
                    desc.textContent = translations[categoria.descLangKey][currentLanguage];
                    ui.inputsContainer.appendChild(desc);
                }


                if (categoria.key === 'gilde' && datiPartita.espansioni.armada) {
                    const avviso = document.createElement('div');
                    avviso.id = 'avviso-categoria';
                    avviso.textContent = translations.guildsWarning[currentLanguage];
                    ui.inputsContainer.appendChild(avviso);
                }

                if (categoria.key === 'tesoro' && ['1ed', '2ed', 'duel'].includes(datiPartita.gameVersion)) {
                    const avviso = document.createElement('div');
                    avviso.id = 'avviso-categoria';
                    avviso.textContent = translations.treasuryCoinInfo[currentLanguage];
                    ui.inputsContainer.appendChild(avviso);
                }

                if (categoria.type === 'science' && datiPartita.gameVersion !== 'architects') {
                    const iconHeader = document.createElement('div');
                    iconHeader.className = 'science-icon-grid';
                    iconHeader.innerHTML = `<div></div>
                                            <div><img src="https://i.postimg.cc/y6gd7hgg/compasso.png" class="science-icon" alt="Icona compasso" onerror="this.style.display='none'"></div>
                                            <div><img src="https://i.postimg.cc/7b8j4rCV/tavoletta.png" class="science-icon" alt="Icona tavoletta" onerror="this.style.display='none'"></div>
                                            <div><img src="https://i.postimg.cc/C12WvqS9/ingranaggio.png" class="science-icon" alt="Icona ingranaggio" onerror="this.style.display='none'"></div>
                                            <div><img src="https://i.postimg.cc/43WC90Mf/serie.png" class="science-icon" alt="Icona serie" onerror="this.style.display='none'"></div>`;
                    ui.inputsContainer.appendChild(iconHeader);

                    datiPartita.giocatori.forEach((giocatore, playerIndex) => {
                        const riga = document.createElement('div');
                        riga.className = 'punteggio-giocatore-riga science-row';
                        const puntiSalvati = giocatore.punteggi[categoria.key] || { compasso: 0, tavoletta: 0, ingranaggio: 0, serie: 0 };

                        const label = document.createElement('label');
                        label.innerHTML = `${giocatore.nome}<span id="anteprima-scienza-${playerIndex}" style="color: var(--colore-successo); font-weight: bold; display: block; font-size: 0.8em;">(${calcolaPuntiScienzaOttimizzati(puntiSalvati)}pt)</span>`;
                        riga.appendChild(label);

                        const scienceTypes = ['compasso', 'tavoletta', 'ingranaggio', 'serie'];
                        scienceTypes.forEach(type => {
                            const input = document.createElement('input');
                            input.type = 'number';
                            input.className = 'input-punteggio';
                            input.dataset.playerIndex = playerIndex;
                            input.dataset.scienceType = type;
                            input.value = puntiSalvati[type] || 0;
                            input.min = "0";
                            riga.appendChild(input);
                        });

                        ui.inputsContainer.appendChild(riga);
                    });

                } else if (categoria.type === 'checkbox') {
                     datiPartita.giocatori.forEach((giocatore, playerIndex) => {
                        const riga = document.createElement('div');
                        riga.className = 'punteggio-giocatore-riga checkbox-item';
                        riga.style.justifyContent = "space-between";
                        riga.innerHTML = `<label>${giocatore.nome}</label>
                                        <input type="checkbox" name="cat-check-${categoria.key}" value="${playerIndex}" ${datiPartita.giocatoreGattoIndex == playerIndex ? 'checked' : ''}>`;
                        ui.inputsContainer.appendChild(riga);
                    });
                     ui.inputsContainer.querySelectorAll(`input[name="cat-check-${categoria.key}"]`).forEach(check => {
                        check.addEventListener('change', (e) => {
                            if(e.target.checked) {
                                ui.inputsContainer.querySelectorAll(`input[name="cat-check-${categoria.key}"]`).forEach(otherCheck => {
                                    if(otherCheck !== e.target) otherCheck.checked = false;
                                });
                            }
                        });
                    });

                } else { 
                    datiPartita.giocatori.forEach((giocatore, playerIndex) => {
                        const riga = document.createElement('div');
                        const minAttribute = CATEGORIE_NEGATIVE_PERMESSE.includes(categoria.key) ? '' : 'min="0"';
                        riga.className = 'punteggio-giocatore-riga';
                        let labelHTML = `<label for="p-cat-${playerIndex}">${giocatore.nome}`;
                        
                        // Aggiunta anteprima per il tesoro
                        if (categoria.key === 'tesoro' && ['1ed', '2ed', 'duel'].includes(datiPartita.gameVersion)) {
                            const puntiTesoro = Math.floor((giocatore.punteggi.tesoro || 0) / 3);
                            labelHTML += `<span id="anteprima-tesoro-${playerIndex}" style="color: var(--colore-successo); font-weight: bold; display: block; font-size: 0.8em;">(${puntiTesoro}pt)</span>`;
                        }
                        labelHTML += '</label>';

                        riga.innerHTML = `${labelHTML}
                                        <div class="input-stepper">
                                            <button class="stepper-btn" data-player-index="${playerIndex}" data-step="-1">-</button>
                                            <input type="number" id="p-cat-${playerIndex}" class="input-punteggio" data-player-index="${playerIndex}" value="${giocatore.punteggi[categoria.key] || 0}" ${minAttribute}>
                                            <button class="stepper-btn" data-player-index="${playerIndex}" data-step="1">+</button>
                                        </div>`;
                        ui.inputsContainer.appendChild(riga);
                    });
                }

                ui.inputsContainer.querySelectorAll('.stepper-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const input = e.target.parentElement.querySelector('input');
                        const step = parseInt(e.target.dataset.step);
                        const min = parseInt(input.min);
                        const newValue = parseInt(input.value) + step;
                        if (!isNaN(min) && newValue < min) {
                            return;
                        }
                        input.value = newValue;
                        input.dispatchEvent(new Event('input')); 
                    });
                });

                ui.inputsContainer.querySelectorAll('input[type=number]').forEach(input => {
                     input.addEventListener('input', (e) => {
                        const pIndex = e.target.dataset.playerIndex;
                         if (e.target.dataset.scienceType) {
                            const simboli = { compasso: 0, tavoletta: 0, ingranaggio: 0, serie: 0 };
                            document.querySelectorAll(`input[data-player-index="${pIndex}"][data-science-type]`).forEach(i => {
                                simboli[i.dataset.scienceType] = parseInt(i.value) || 0;
                            });
                            document.getElementById(`anteprima-scienza-${pIndex}`).textContent = `(${calcolaPuntiScienzaOttimizzati(simboli)}pt)`;
                         } else if (datiPartita.categoriePartita[datiPartita.categoriaCorrenteIndex].key === 'tesoro' && ['1ed', '2ed', 'duel'].includes(datiPartita.gameVersion)) {
                            const monete = parseInt(e.target.value) || 0;
                            const punti = Math.floor(monete / 3);
                            document.getElementById(`anteprima-tesoro-${pIndex}`).textContent = `(${punti}pt)`;
                         }
                    });
                });

                bottoni.prevCat.disabled = index === 0;
                const isLastCategory = index === datiPartita.categoriePartita.length - 1;
                bottoni.nextCat.innerHTML = isLastCategory ? (datiPartita.hasCalculatedResults ? translations.recalculateResults[currentLanguage] : translations.seeResults[currentLanguage]) : `${translations.next[currentLanguage]} ‚Üí`;
            }

            function navigaCategorie(dir) {
                salvaPunteggiCategoriaCorrente();
                datiPartita.categoriaCorrenteIndex += dir;
                if (datiPartita.categoriaCorrenteIndex >= datiPartita.categoriePartita.length) {
                    datiPartita.categoriaCorrenteIndex = datiPartita.categoriePartita.length - 1;
                    mostraRisultati();
                } else {
                    mostraSchermataCategoria();
                }
            }

            function salvaPunteggiCategoriaCorrente() {
                const cat = datiPartita.categoriePartita[datiPartita.categoriaCorrenteIndex];
                if (!cat) return;
                
                if (cat.type === 'number') {
                    ui.inputsContainer.querySelectorAll('.punteggio-giocatore-riga input.input-punteggio').forEach(input => {
                        datiPartita.giocatori[parseInt(input.dataset.playerIndex)].punteggi[cat.key] = parseInt(input.value) || 0;
                    });
                } else if (cat.type === 'science') {
                     datiPartita.giocatori.forEach((g, pIndex) => {
                        const simboli = { compasso: 0, tavoletta: 0, ingranaggio: 0, serie: 0 };
                        document.querySelectorAll(`input[data-player-index="${pIndex}"][data-science-type]`).forEach(i => {
                            simboli[i.dataset.scienceType] = parseInt(i.value) || 0;
                        });
                        g.punteggi[cat.key] = simboli;
                    });
                } else if (cat.type === 'checkbox') {
                    const selectedCheck = ui.inputsContainer.querySelector(`input[name="cat-check-${cat.key}"]:checked`);
                    if (selectedCheck) {
                        datiPartita.giocatoreGattoIndex = parseInt(selectedCheck.value);
                    } else {
                        delete datiPartita.giocatoreGattoIndex;
                    }
                }
            }

            function calcolaPuntiScienza(simboli) {
                const t = simboli.tavoletta || 0;
                const i = simboli.ingranaggio || 0;
                const c = simboli.compasso || 0;
                return (t * t + i * i + c * c) + (Math.min(t, i, c) * 7);
            }

            function calcolaPuntiScienzaOttimizzati(simboli) {
                let { compasso, tavoletta, ingranaggio, serie } = simboli;
                if (!serie || serie === 0) return calcolaPuntiScienza(simboli);
                let c = compasso || 0,
                    t = tavoletta || 0,
                    i = ingranaggio || 0;
                for (let j = 0; j < serie; j++) {
                    const score_c = calcolaPuntiScienza({ compasso: c + 1, tavoletta: t, ingranaggio: i });
                    const score_t = calcolaPuntiScienza({ compasso: c, tavoletta: t + 1, ingranaggio: i });
                    const score_i = calcolaPuntiScienza({ compasso: c, tavoletta: t, ingranaggio: i + 1 });
                    if (score_c >= score_t && score_c >= score_i) {
                        c++;
                    } else if (score_t > score_c && score_t >= score_i) {
                        t++;
                    } else {
                        i++;
                    }
                }
                return calcolaPuntiScienza({ compasso: c, tavoletta: t, ingranaggio: i });
            }

            function mostraRisultati(gameDataToDisplay = null) {
                if (gameDataToDisplay) {
                    datiPartita = JSON.parse(JSON.stringify(gameDataToDisplay)); // Deep copy to avoid modifying original history object
                } else {
                    datiPartita.hasCalculatedResults = true;
                    const dataPartita = datiPartita.manualDate ? new Date(datiPartita.manualDate) : new Date();
                    const locale = currentLanguage === 'it' ? 'it-IT' : 'en-US';
                    datiPartita.data = datiPartita.data || dataPartita.toLocaleString(locale, { day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit' });

                    datiPartita.giocatori.forEach((g, index) => {
                        const p = g.punteggi;
                        let pTesoro = 0;
                        let pScienza = 0;
                        
                        if (datiPartita.gameVersion === 'architects') {
                            p.gatto = (datiPartita.giocatoreGattoIndex === index) ? 2 : 0;
                        }

                        if(datiPartita.gameVersion === '1ed' || datiPartita.gameVersion === '2ed'){
                            pTesoro = Math.floor(Math.max(0, p.tesoro || 0) / 3);
                            pScienza = p.scienza ? calcolaPuntiScienzaOttimizzati(p.scienza) : 0;
                            g.punteggi.puntiTesoro = pTesoro;
                            g.punteggi.puntiScienza = pScienza;
                        } else if (datiPartita.gameVersion === 'duel') {
                            pTesoro = Math.floor(Math.max(0, p.tesoro || 0) / 3);
                            g.punteggi.puntiTesoro = pTesoro;
                        }

                        let total = 0;
                        datiPartita.categoriePartita.forEach(cat => {
                            const key = cat.key;
                            if (key === 'tesoro' && (datiPartita.gameVersion === '1ed' || datiPartita.gameVersion === '2ed' || datiPartita.gameVersion === 'duel')) {
                                total += pTesoro;
                            } else if (key === 'scienza' && (datiPartita.gameVersion === '1ed' || datiPartita.gameVersion === '2ed')) {
                                // gestito separatamente
                            } else if(key === 'wonderStages' && datiPartita.gameVersion === 'architects'){
                                 // non √® un punteggio, solo per spareggio
                            } else {
                                total += (p[key] || 0);
                            }
                        });

                        if(datiPartita.gameVersion === '1ed' || datiPartita.gameVersion === '2ed'){
                            total += pScienza;
                        }

                        g.totale = total;
                    });
                    saveGameToHistory(datiPartita);
                }

                const infoEl = document.createElement('div');
                infoEl.className = 'header-info';
                infoEl.innerHTML = `<span>${datiPartita.data}${datiPartita.luogo ? `, ${datiPartita.luogo}` : ''}</span>`;

                sezioni.risultati.innerHTML = '';
                sezioni.risultati.appendChild(infoEl);
                const titolo = document.createElement('h2');
                titolo.textContent = translations.finalRanking[currentLanguage];
                sezioni.risultati.appendChild(titolo);

                if (datiPartita.espansioni.giocoASquadre) {
                    mostraRisultatiSquadre();
                } else {
                    mostraRisultatiIndividuali();
                }

                const btnGroupTop = document.createElement('div');
                btnGroupTop.className = 'gruppo-bottoni';
                // Mostra il pulsante "Indietro" solo se non siamo in modalit√† "visualizza da cronologia"
                if (!gameDataToDisplay) {
                    const backToScoreBtn = document.createElement('button');
                    backToScoreBtn.textContent = translations.back[currentLanguage];
                    backToScoreBtn.addEventListener('click', () => mostraSezione('punteggio'));
                    btnGroupTop.appendChild(backToScoreBtn);
                }
                const backToHomeBtn = document.createElement('button');
                backToHomeBtn.textContent = translations.backToHome[currentLanguage];
                backToHomeBtn.addEventListener('click', () => mostraSezione('landing'));
                btnGroupTop.appendChild(backToHomeBtn);
                sezioni.risultati.appendChild(btnGroupTop);

                const btnGroupBottom = document.createElement('div');
                btnGroupBottom.className = 'gruppo-bottoni';
                const shareBtn = document.createElement('button');
                shareBtn.textContent = translations.shareResults[currentLanguage];
                shareBtn.className = 'bottone-grande';
                shareBtn.addEventListener('click', condividiComeImmagine);
                const nuovaPartitaBtn = document.createElement('button');
                nuovaPartitaBtn.className = 'bottone-grande';
                nuovaPartitaBtn.textContent = translations.newGame[currentLanguage];
                nuovaPartitaBtn.addEventListener('click', () => {
                    mostraSezione('selezioneGioco');
                });
                btnGroupBottom.appendChild(shareBtn);
                btnGroupBottom.appendChild(nuovaPartitaBtn);
                sezioni.risultati.appendChild(btnGroupBottom);

                mostraSezione('risultati');
            }

            function mostraRisultatiIndividuali() {
                let tieBreakerKey;
                if(datiPartita.gameVersion === 'architects') tieBreakerKey = 'wonderStages';
                else if (datiPartita.gameVersion === 'duel') tieBreakerKey = 'civili';
                else tieBreakerKey = 'tesoro';

                const giocatoriOrdinati = [...datiPartita.giocatori].sort((a, b) => {
                    if (b.totale !== a.totale) return b.totale - a.totale;
                    return (b.punteggi[tieBreakerKey] || 0) - (a.punteggi[tieBreakerKey] || 0);
                });
                
                const classificaUI = document.createElement('div');
                classificaUI.id = 'lista-classifica';
                const isWinner = giocatoriOrdinati.length < 2 || giocatoriOrdinati[0].totale > giocatoriOrdinati[1].totale || (giocatoriOrdinati[0].totale === giocatoriOrdinati[1].totale && (giocatoriOrdinati[0].punteggi[tieBreakerKey] || 0) > (giocatoriOrdinati[1].punteggi[tieBreakerKey] || 0));

                giocatoriOrdinati.forEach((g, index) => {
                    if (g.isFreeCity) return; // Non mostrare la citt√† franca nei risultati finali

                    const li = document.createElement('div');
                    li.className = 'risultato-giocatore';
                    if (index === 0 && isWinner) li.classList.add('vincitore');
                    
                    const prevPlayer = giocatoriOrdinati[index - 1];
                    const nextPlayer = giocatoriOrdinati[index + 1];
                    const isTied = (prevPlayer && prevPlayer.totale === g.totale) || (nextPlayer && nextPlayer.totale === g.totale);
                    
                    let scoreDisplay = `<span class="punteggio-finale">${g.totale}</span>`;
                    if (isTied) {
                        let tieBreakerIcon;
                        if (tieBreakerKey === 'tesoro') tieBreakerIcon = 'üí∞';
                        else if (tieBreakerKey === 'wonderStages') tieBreakerIcon = 'üèóÔ∏è';
                        else if (tieBreakerKey === 'civili') tieBreakerIcon = 'üîµ';

                        scoreDisplay = `<span class="punteggio-finale">${g.totale}<span class="tie-breaker">(${(g.punteggi[tieBreakerKey] || 0)}${tieBreakerIcon})</span></span>`;
                    }
                    
                    let wonderDisplayHTML = '';
                    if (datiPartita.gameVersion === 'duel' && g.meraviglie && g.meraviglie.length > 0) {
                        wonderDisplayHTML = `<span class="wonder-display wonder-display-duel">${g.meraviglie.map(w => getWonderName(w) || '').filter(Boolean).join('<br>')}</span>`;
                    } else {
                        wonderDisplayHTML = `<span class="wonder-display">${getWonderName(g.meraviglia) || translations.noWonder[currentLanguage]}</span>`;
                    }
                    
                    li.innerHTML = `<div class="risultato-header"><div><span class="medaglia">${(index === 0 && isWinner) ? 'ü•á' : `${index + 1}.`}</span><div class="nome"><span>${g.nome}</span>${wonderDisplayHTML}</div></div>${scoreDisplay}</div>`;
                    li.appendChild(createBreakdownDiv(g));
                    classificaUI.appendChild(li);
                });
                sezioni.risultati.appendChild(classificaUI);
            }

            function mostraRisultatiSquadre() {
                const squadreMap = datiPartita.giocatori.reduce((acc, g) => {
                    if (!g.isFreeCity) {
                        if (!acc[g.team]) acc[g.team] = { nome: `${translations.team[currentLanguage]} ${g.team}`, giocatori: [], punteggi: {}, totale: 0 };
                        acc[g.team].giocatori.push(g);
                    }
                    return acc;
                }, {});

                const squadre = Object.values(squadreMap);
                squadre.forEach(s => {
                    s.totale = s.giocatori.reduce((acc, g) => acc + g.totale, 0);
                    datiPartita.categoriePartita.forEach(cat => {
                        const key = cat.key;
                        if (key === 'scienza') {
                            s.punteggi.puntiScienza = s.giocatori.reduce((acc, g) => acc + (g.punteggi.puntiScienza || 0), 0);
                        } else if (key === 'tesoro') {
                            s.punteggi.puntiTesoro = s.giocatori.reduce((acc, g) => acc + (g.punteggi.puntiTesoro || 0), 0);
                            s.punteggi[key] = s.giocatori.reduce((acc, g) => acc + (g.punteggi[key] || 0), 0);
                        } else {
                            s.punteggi[key] = s.giocatori.reduce((acc, g) => acc + (g.punteggi[key] || 0), 0);
                        }
                    });
                });
                squadre.sort((a, b) => b.totale !== a.totale ? b.totale - a.totale : (b.punteggi.tesoro || 0) - (a.punteggi.tesoro || 0));
                
                const classificaUI = document.createElement('div');
                classificaUI.id = 'lista-classifica';

                const isWinner = squadre.length < 2 || squadre[0].totale > squadre[1].totale || (squadre[0].totale === squadre[1].totale && squadre[0].punteggi.tesoro > squadre[1].punteggi.tesoro);

                squadre.forEach((s, index) => {
                    const teamEl = document.createElement('div');
                    teamEl.className = 'risultato-squadra';
                    if (index === 0 && isWinner) teamEl.classList.add('vincitore');

                    const teamBreakdown = createBreakdownDiv(s);
                    const teamPlayersDetails = document.createElement('div');
                    teamPlayersDetails.className = 'dettaglio-squadra';
                    s.giocatori.sort((a, b) => b.totale - a.totale).forEach(g => {
                        const playerDetailEl = document.createElement('div');
                        playerDetailEl.className = 'dettaglio-giocatore-individuale';
                        const playerBreakdown = createBreakdownDiv(g);
                        playerDetailEl.innerHTML = `<div class="risultato-header"><div class="nome"><span>${g.nome}</span><span class="wonder-display">${getWonderName(g.meraviglia) || translations.noWonder[currentLanguage]}</span></div><span class="punteggio-finale">${g.totale}</span></div>`;
                        playerDetailEl.appendChild(playerBreakdown);
                        teamPlayersDetails.appendChild(playerDetailEl);
                    });

                    const prevTeam = squadre[index - 1];
                    const nextTeam = squadre[index + 1];
                    const isTied = (prevTeam && prevTeam.totale === s.totale) || (nextTeam && nextTeam.totale === s.totale);
                    let scoreDisplay = `<span class="punteggio-finale">${s.totale}</span>`;
                    if (isTied) scoreDisplay = `<span class="punteggio-finale">${s.totale}<span class="tie-breaker">(${(s.punteggi.tesoro || 0)}üí∞)</span></span>`;

                    teamEl.innerHTML = `<div class="risultato-header"><div><span class="medaglia">${(index === 0 && isWinner) ? 'ü•á' : `${index + 1}.`}</span><span class="nome">${s.nome}</span></div>${scoreDisplay}</div>`;
                    teamEl.appendChild(teamBreakdown);
                    teamEl.appendChild(teamPlayersDetails);
                    classificaUI.appendChild(teamEl);
                });
                sezioni.risultati.appendChild(classificaUI);
            }

            function createBreakdownDiv(entity) {
                const div = document.createElement('div');
                div.className = 'risultato-breakdown';
                datiPartita.categoriePartita.forEach(cat => {
                    if (cat.key === 'wonderStages') return;

                    let pCat = 0;
                    if (cat.key === 'scienza' && (datiPartita.gameVersion === '1ed' || datiPartita.gameVersion === '2ed')) {
                        pCat = entity.punteggi.puntiScienza || 0;
                    } else if (cat.key === 'tesoro' && (datiPartita.gameVersion === '1ed' || datiPartita.gameVersion === '2ed' || datiPartita.gameVersion === 'duel')) {
                        pCat = entity.punteggi.puntiTesoro || 0;
                    } else {
                        pCat = entity.punteggi[cat.key] || 0;
                    }
                    
                    const firstSpaceIndex = cat.label.indexOf(' ');
                    const icon = cat.label.substring(0, firstSpaceIndex);
                    const name = translations[cat.langKey] ? translations[cat.langKey][currentLanguage] : cat.label;
                    div.innerHTML += `<span class="breakdown-item" title="${name}">${icon} ${pCat}</span>`;
                });
                return div;
            }

            function condividiComeImmagine() {
                const SHARE_WIDTH = 500; 

                const shareableContent = document.createElement('div');
                shareableContent.style.width = `${SHARE_WIDTH}px`;
                shareableContent.style.height = 'auto'; // Lascia che l'altezza si adatti al contenuto
                shareableContent.style.padding = '30px';
                shareableContent.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--colore-sfondo');
                shareableContent.style.fontFamily = "'Roboto', sans-serif";
                shareableContent.style.color = getComputedStyle(document.documentElement).getPropertyValue('--colore-testo');
                shareableContent.style.boxSizing = 'border-box';
                shareableContent.style.display = 'flex';
                shareableContent.style.flexDirection = 'column';

                let logoSrc;
                switch(datiPartita.gameVersion){
                    case '1ed': logoSrc = 'https://i.postimg.cc/8zKZnZ89/pngegg.png'; break;
                    case '2ed': logoSrc = 'https://i.imgur.com/p1PgYrh.png'; break;
                    case 'architects': logoSrc = 'https://i.postimg.cc/mgqzt9fK/arc-common-logo-1630334595b-VXy-Z-large.png'; break;
                    case 'duel': logoSrc = 'https://i.postimg.cc/vmV19mGT/7WDuel.png'; break;
                    default: logoSrc = 'https://i.imgur.com/p1PgYrh.png';
                }
                
                const logo = document.createElement('img');
                logo.src = logoSrc;
                logo.style.maxWidth = '60%';
                logo.style.maxHeight = '100px';
                logo.style.margin = '0 auto 20px auto';
                logo.style.display = 'block';
                logo.style.objectFit = 'contain';

                // Clona solo il contenuto necessario
                const resultsContent = document.getElementById('lista-classifica').cloneNode(true);
                const headerInfo = document.querySelector('#risultati-sezione .header-info').cloneNode(true);
                const title = document.querySelector('#risultati-sezione h2').cloneNode(true);

                shareableContent.appendChild(logo);
                shareableContent.appendChild(headerInfo);
                shareableContent.appendChild(title);
                shareableContent.appendChild(resultsContent);
                
                // Aggiungi il container temporaneo al body per il rendering
                document.body.appendChild(shareableContent);

                html2canvas(shareableContent, {
                    scale: 2, // Aumenta la risoluzione
                    backgroundColor: null,
                    useCORS: true,
                    // Non √® necessario specificare width/height qui, le prender√† dall'elemento
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `7wonders-results-${Date.now()}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    document.body.removeChild(shareableContent); // Pulisce il DOM
                }).catch(err => {
                    console.error("Errore durante la generazione dell'immagine:", err);
                    document.body.removeChild(shareableContent); // Pulisce anche in caso di errore
                });
            }

            
            // ===============================================
            // I. LOGICA CRONOLOGIA E STATISTICHE
            // ===============================================

            function displayGameHistory() {
                // MODIFICATO: Reset della pagina corrente quando si applicano i filtri
                if (typeof displayGameHistory.lastFilter !== 'undefined' && 
                    (displayGameHistory.lastFilter.version !== ui.historyGameFilter.value || displayGameHistory.lastFilter.sort !== ui.historySortFilter.value)) {
                    currentPage = 1;
                }
                displayGameHistory.lastFilter = { version: ui.historyGameFilter.value, sort: ui.historySortFilter.value };

                const history = getGameHistory();
                ui.historyList.innerHTML = '';
            
                const previouslySelectedVersion = ui.historyGameFilter.value;
            
                const gameVersions = [...new Set(history.map(g => g.gameVersion))];
                const allGamesText = translations.allGames[currentLanguage] || 'Tutti i giochi';
                ui.historyGameFilter.innerHTML = `<option value="">${allGamesText}</option>`;
                gameVersions.sort().forEach(v => {
                    const gameName = (translations.gameVersionMap[v] && translations.gameVersionMap[v][currentLanguage]) 
                                        ? translations.gameVersionMap[v][currentLanguage]
                                        : v;
                    ui.historyGameFilter.innerHTML += `<option value="${v}">${gameName}</option>`;
                });
            
                ui.historyGameFilter.value = previouslySelectedVersion;
            
                const versionFilter = ui.historyGameFilter.value;
                const sortOrder = ui.historySortFilter.value;
            
                let filteredHistory = history;
                if (versionFilter) {
                    filteredHistory = filteredHistory.filter(game => game.gameVersion === versionFilter);
                }
            
                filteredHistory.sort((a, b) => {
                    const dateA = a.manualDate ? new Date(a.manualDate) : new Date(parseInt(a.idPartita.split('_')[1]));
                    const dateB = b.manualDate ? new Date(b.manualDate) : new Date(parseInt(b.idPartita.split('_')[1]));
                    return sortOrder === 'newest' ? dateB - dateA : dateA - dateB;
                });
            
                // NUOVO: Logica di paginazione
                const totalPages = Math.ceil(filteredHistory.length / ITEMS_PER_PAGE);
                const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
                const endIndex = startIndex + ITEMS_PER_PAGE;
                const paginatedItems = filteredHistory.slice(startIndex, endIndex);

                if (paginatedItems.length === 0) {
                    ui.historyList.innerHTML = `<p>${translations.noHistory[currentLanguage]}</p>`;
                    document.getElementById('history-pagination').innerHTML = ''; // Nasconde i controlli se non ci sono risultati
                    return;
                }
            
                paginatedItems.forEach(game => {
                    const li = document.createElement('li');
                    li.className = 'history-item';
            
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'history-item-content';
                    
                    let detailsText = '';

                    // NUOVO: Logica avanzata per spareggio e visualizzazione
                    const getTieBreakerKey = (gameVersion) => {
                        if (['1ed', '2ed', 'duel'].includes(gameVersion)) return 'tesoro'; // Monete
                        if (gameVersion === 'architects') return 'wonderStages'; // Stadi meraviglia
                        return 'totale'; // Fallback
                    };
                    const tieBreakerKey = getTieBreakerKey(game.gameVersion);

                    if (game.espansioni && game.espansioni.giocoASquadre) {
                         const squadreMap = game.giocatori.reduce((acc, g) => {
                            if (!g.isFreeCity) {
                                if (!acc[g.team]) acc[g.team] = { giocatori: [], totale: 0 };
                                acc[g.team].giocatori.push(g);
                                acc[g.team].totale += g.totale;
                            }
                            return acc;
                        }, {});
                        const squadre = Object.values(squadreMap);
                        squadre.sort((a, b) => b.totale - a.totale);
            
                        if (squadre.length > 0) {
                            const winningTeam = squadre[0];
                            const winningTeamNames = winningTeam.giocatori.map(p => p.nome).join(' & ');
                            const otherTeams = squadre.slice(1).map(s => `${s.giocatori.map(p => p.nome).join(' & ')} ${s.totale}`);
                            detailsText = `<strong>${translations.winners[currentLanguage]}: ${winningTeamNames} ${winningTeam.totale}</strong> (${otherTeams.join(', ')})`;
                        }
                    } else {
                        const giocatoriOrdinati = [...game.giocatori].filter(p => !p.isFreeCity).sort((a, b) => {
                            if (b.totale !== a.totale) return b.totale - a.totale;
                            return (b.punteggi[tieBreakerKey] || 0) - (a.punteggi[tieBreakerKey] || 0);
                        });

                        if (giocatoriOrdinati.length > 0) {
                             const playerStrings = giocatoriOrdinati.map((g, index, arr) => {
                                let displayString = `${g.nome} ${g.totale}`;
                                const isTied = (index > 0 && arr[index - 1].totale === g.totale) || (index < arr.length - 1 && arr[index + 1].totale === g.totale);
                                
                                if (isTied) {
                                    const tieValue = g.punteggi[tieBreakerKey] || 0;
                                    displayString += `<sup>&nbsp;(${tieValue})</sup>`;
                                }
                                return displayString;
                            });
                             detailsText = `<strong>${translations.winner[currentLanguage]}: ${playerStrings[0]}</strong> (${playerStrings.slice(1).join(', ')})`;
                        }
                    }
                    
                    const gameVersionName = (translations.gameVersionMap[game.gameVersion] && translations.gameVersionMap[game.gameVersion][currentLanguage]) 
                                           ? translations.gameVersionMap[game.gameVersion][currentLanguage] 
                                           : game.gameVersion;
            
                    contentDiv.innerHTML = `
                        <div class="history-item-header">
                            <span>${gameVersionName}</span>
                            <span>${game.data}</span>
                        </div>
                        <div class="history-item-details">
                           ${detailsText}
                        </div>
                    `;
                    
                    contentDiv.addEventListener('click', () => {
                        const clickedGame = getGameHistory().find(g => g.idPartita === game.idPartita);
                        if (clickedGame) {
                            mostraRisultati(clickedGame);
                        }
                    });
            
                    const buttonsContainer = document.createElement('div');
                    buttonsContainer.className = 'action-buttons-container';
            
                    const editBtn = document.createElement('button');
                    editBtn.className = 'edit-player-btn';
                    editBtn.innerHTML = '&#9998;';
                    editBtn.title = translations.editGame[currentLanguage];
                    editBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const gameToEdit = getGameHistory().find(g => g.idPartita === game.idPartita);
                        if (gameToEdit) {
                            datiPartita = JSON.parse(JSON.stringify(gameToEdit));
                            datiPartita.isEditing = true;
                            const gameCategories = {
                                '1ed': CATEGORIE_1ED, '2ed': CATEGORIE_2ED, 
                                'architects': CATEGORIE_ARCHITECTS, 'duel': CATEGORIE_DUEL
                            };
                            datiPartita.categoriePartita = gameCategories[datiPartita.gameVersion].filter(cat => {
                                if (datiPartita.gameVersion === 'duel' && cat.key === 'gilde' && datiPartita.espansioni.pantheon) {
                                    return false;
                                }
                                return !cat.expansion || (datiPartita.espansioni && datiPartita.espansioni[cat.expansion]);
                            });
                            mostraSezione('punteggio');
                            mostraSchermataCategoria();
                        }
                    });
            
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-player-btn';
                    deleteBtn.innerHTML = '&#10006;';
                    deleteBtn.title = translations.deleteGame[currentLanguage];
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        showConfirmationModal(
                            translations.deleteGameConfirm[currentLanguage],
                            () => deleteGameFromHistory(game.idPartita)
                        );
                    });
                    
                    buttonsContainer.appendChild(editBtn);
                    buttonsContainer.appendChild(deleteBtn);
                    
                    li.appendChild(contentDiv);
                    li.appendChild(buttonsContainer);
                    
                    ui.historyList.appendChild(li);
                });

                // NUOVO: Renderizza i controlli di paginazione
                const paginationContainer = document.getElementById('history-pagination');
                if (totalPages > 1) {
                    paginationContainer.innerHTML = `
                        <button id="prevPageBtn" class="bottone-grande" style="flex: 0.5;">&laquo; ${translations.back[currentLanguage].replace('‚Üê ','')}</button>
                        <span style="font-size: 0.9em;">${currentPage} / ${totalPages}</span>
                        <button id="nextPageBtn" class="bottone-grande" style="flex: 0.5;">${translations.next[currentLanguage]} &raquo;</button>
                    `;

                    const prevBtn = document.getElementById('prevPageBtn');
                    const nextBtn = document.getElementById('nextPageBtn');

                    prevBtn.disabled = currentPage === 1;
                    nextBtn.disabled = currentPage === totalPages;

                    prevBtn.addEventListener('click', () => {
                        if (currentPage > 1) {
                            currentPage--;
                            displayGameHistory();
                        }
                    });
                    nextBtn.addEventListener('click', () => {
                        if (currentPage < totalPages) {
                            currentPage++;
                            displayGameHistory();
                        }
                    });
                } else {
                    paginationContainer.innerHTML = '';
                }
            }
            
            // Sostituisci le vecchie funzioni delle statistiche con queste tre
            function calculateAndDisplayStats() {
                const history = getGameHistory();
                
                if (history.length === 0) {
                    ui.overallStatsContainer.innerHTML = `<p>${translations.noStats[currentLanguage]}</p>`;
                    ui.playerStatsContainer.innerHTML = '';
                    document.getElementById('overall-stats-filter-container').classList.add('hidden');
                    document.getElementById('stats-filter-container').classList.add('hidden');
                    return;
                }
            
                document.getElementById('overall-stats-filter-container').classList.remove('hidden');
                document.getElementById('stats-filter-container').classList.remove('hidden');
            
                const allPlayers = [...new Set(history.flatMap(g => g.giocatori.filter(p => !p.isFreeCity).map(p => p.nome)))].filter(Boolean).sort();
                const gameVersions = [...new Set(history.map(g => g.gameVersion))].sort();
            
                const populateSelect = (selectEl, options, allText) => {
                    const currentValue = selectEl.value;
                    selectEl.innerHTML = `<option value="">${allText}</option>`;
                    options.forEach(opt => {
                        const optionText = opt.isVersion 
                            ? (translations.gameVersionMap[opt.value] && translations.gameVersionMap[opt.value][currentLanguage] ? translations.gameVersionMap[opt.value][currentLanguage] : opt.text)
                            : opt.text;
                        selectEl.innerHTML += `<option value="${opt.value}">${optionText}</option>`;
                    });
                    if (Array.from(selectEl.options).some(opt => opt.value === currentValue)) {
                        selectEl.value = currentValue;
                    }
                };
            
                populateSelect(ui.overallStatsGameFilter, gameVersions.map(v => ({value: v, text: v, isVersion: true})), translations.allGames[currentLanguage]);
                populateSelect(ui.statsGameVersionFilter, gameVersions.map(v => ({value: v, text: v, isVersion: true})), translations.allGames[currentLanguage]);
                populateSelect(ui.statsPlayerFilter, allPlayers.map(p => ({value: p, text: p, isVersion: false})), translations.selectPlayer[currentLanguage]);
                
                const renderAllStats = () => {
                    const overallVersion = ui.overallStatsGameFilter.value;
                    renderOverallStats(overallVersion ? history.filter(g => g.gameVersion === overallVersion) : history);
                    renderPlayerStats(history, allPlayers);
                };
                
                // Rimuovi e ri-aggiungi listener per evitare duplicati
                const rebindListener = (el) => {
                    const newEl = el.cloneNode(true);
                    el.parentNode.replaceChild(newEl, el);
                    newEl.addEventListener('change', renderAllStats);
                    return newEl;
                };
            
                ui.overallStatsGameFilter = rebindListener(ui.overallStatsGameFilter);
                ui.statsPlayerFilter = rebindListener(ui.statsPlayerFilter);
                ui.statsGameVersionFilter = rebindListener(ui.statsGameVersionFilter);
            
                renderAllStats();
            }
            
            function renderOverallStats(filteredHistory) {
                if (filteredHistory.length === 0) {
                    ui.overallStatsContainer.innerHTML = `<p>${translations.noStats[currentLanguage]}</p>`;
                    return;
                }
            
                let wonderCounts = {}, playerWins = {}, highestScore = { score: -Infinity, player: '' };
            
                filteredHistory.forEach(game => {
                    game.giocatori.forEach(player => {
                        if (player.isFreeCity) return;
                        if (player.meraviglia) wonderCounts[player.meraviglia] = (wonderCounts[player.meraviglia] || 0) + 1;
                        if (player.meraviglie) player.meraviglie.forEach(m => { if(m) wonderCounts[m] = (wonderCounts[m] || 0) + 1; });
                        if (player.totale > highestScore.score) highestScore = { score: player.totale, player: player.nome };
                    });
            
                    const sortedPlayers = [...game.giocatori].filter(p => !p.isFreeCity).sort((a,b) => b.totale - a.totale);
                    if(sortedPlayers.length > 0) playerWins[sortedPlayers[0].nome] = (playerWins[sortedPlayers[0].nome] || 0) + 1;
                });
            
                const mostPlayedWonder = Object.entries(wonderCounts).sort((a,b) => b[1] - a[1])[0] || ['N/A', 0];
                const mostWinningPlayer = Object.entries(playerWins).sort((a,b) => b[1] - a[1])[0] || ['N/A', 0];
            
                ui.overallStatsContainer.innerHTML = `
                    <div class="stat-item"><span class="stat-label">${translations.totalGames[currentLanguage]}:</span> <span class="stat-value">${filteredHistory.length}</span></div>
                    <div class="stat-item"><span class="stat-label">${translations.mostPlayedWonder[currentLanguage]}:</span> <span class="stat-value">${getWonderName(mostPlayedWonder[0])} (${mostPlayedWonder[1]}x)</span></div>
                    <div class="stat-item"><span class="stat-label">${translations.mostWinningPlayer[currentLanguage]}:</span> <span class="stat-value">${mostWinningPlayer[0]} (${mostWinningPlayer[1]} ${translations.wins[currentLanguage]})</span></div>
                    <div class="stat-item"><span class="stat-label">${translations.highestScore[currentLanguage]}:</span> <span class="stat-value">${highestScore.score > -Infinity ? `${highestScore.score} (${highestScore.player})` : 'N/A'}</span></div>
                `;
            }
            
            function renderPlayerStats(fullHistory, allPlayers) {
                const selectedPlayer = ui.statsPlayerFilter.value;
                const selectedVersion = ui.statsGameVersionFilter.value;
                
                const playersToShow = selectedPlayer ? [selectedPlayer] : allPlayers;
                ui.playerStatsContainer.innerHTML = '';
                
                let historyForPlayerStats = selectedVersion ? fullHistory.filter(g => g.gameVersion === selectedVersion) : fullHistory;
            
                playersToShow.forEach(playerName => {
                    const playerGames = historyForPlayerStats.filter(g => g.giocatori.some(p => p.nome === playerName));
                    if (playerGames.length > 0) {
                        let wins = 0, totalScore = 0, highestScoreInVersion = -Infinity, wonderCountsInVersion = {};
            
                        playerGames.forEach(game => {
                            const p = game.giocatori.find(pl => pl.nome === playerName);
                            totalScore += p.totale;
                            if (p.totale > highestScoreInVersion) highestScoreInVersion = p.totale;
                            if (p.meraviglia) wonderCountsInVersion[p.meraviglia] = (wonderCountsInVersion[p.meraviglia] || 0) + 1;
                            if (p.meraviglie) p.meraviglie.forEach(m => { if(m) wonderCountsInVersion[m] = (wonderCountsInVersion[m] || 0) + 1; });
                            
                            const sorted = [...game.giocatori].filter(pl => !pl.isFreeCity).sort((a,b) => b.totale - a.totale);
                            if (sorted.length > 0 && sorted[0].nome === playerName) wins++;
                        });
                        
                        const losses = playerGames.length - wins;
                        const mostUsedWonderData = Object.entries(wonderCountsInVersion).sort((a, b) => b[1] - a[1])[0] || [null, 0];
                        
                        const playerCard = document.createElement('div');
                        
                        // Definiamo le stringhe HTML per le statistiche
                        let wonLostHTML = '';
                        let versionSpecificStatsHTML = '';

                        // Popoliamo le stringhe solo se √® stata selezionata una versione
                        if (selectedVersion) {
                            wonLostHTML = `<div class="stat-item"><span class="stat-label">${translations.wonLost[currentLanguage]}:</span> <span class="stat-value">${wins}/${losses}</span></div>`;
                            versionSpecificStatsHTML = `
                                <div class="stat-item"><span class="stat-label">${translations.highestScoreInVersion[currentLanguage]}:</span> <span class="stat-value">${highestScoreInVersion}</span></div>
                                <div class="stat-item"><span class="stat-label">${translations.mostUsedWonderInVersion[currentLanguage]}:</span> <span class="stat-value">${getWonderName(mostUsedWonderData[0]) || 'N/A'} (${mostUsedWonderData[1]}x)</span></div>
                            `;
                        }

                        // Assembliamo l'HTML finale nell'ordine desiderato
                        playerCard.innerHTML = `
                            <h4>${playerName}</h4>
                            <div class="stat-item"><span class="stat-label">${translations.gamesPlayed[currentLanguage]}:</span> <span class="stat-value">${playerGames.length}</span></div>
                            ${wonLostHTML}
                            <div class="stat-item"><span class="stat-label">${translations.winRate[currentLanguage]}:</span> <span class="stat-value">${((wins / playerGames.length) * 100).toFixed(0)}%</span></div>
                            <div class="stat-item"><span class="stat-label">${translations.avgScore[currentLanguage]}:</span> <span class="stat-value">${(totalScore / playerGames.length).toFixed(1)}</span></div>
                            ${versionSpecificStatsHTML}
                        `;
                        ui.playerStatsContainer.appendChild(playerCard);
                    }
                });
            }

            function setupCollapsibleRules() {
                document.querySelectorAll('.collapsible-header').forEach(header => {
                    header.addEventListener('click', () => {
                        header.classList.toggle('active');
                        const icon = header.querySelector('.toggle-icon');
                        const content = header.nextElementSibling;

                        if (content.style.maxHeight) {
                            content.style.maxHeight = null;
                            content.style.marginBottom = "0";
                            icon.textContent = 'Ôºã';
                        } else {
                            content.style.maxHeight = content.scrollHeight + "px";
                            content.style.marginBottom = "10px";
                            icon.textContent = '‚àí';
                        }
                    });
                });
            }

            // ===============================================
            // J. INIZIALIZZAZIONE
            // ===============================================
            
            function inizializzaApp() {
                initializeTranslations();
                mostraSezione('landing');
                setupCollapsibleRules();
                addEventListeners();
                setLanguage('en');
            }

            function addEventListeners() {
                bottoni.nuovaPartitaLanding.addEventListener('click', () => mostraSezione('selezioneGioco'));
                bottoni.regolamentoLanding.addEventListener('click', () => { setLanguage(currentLanguage); mostraSezione('regolamento'); });
                bottoni.cronologiaLanding.addEventListener('click', () => { displayGameHistory(); mostraSezione('cronologia'); });
                bottoni.statisticheLanding.addEventListener('click', () => { calculateAndDisplayStats(); mostraSezione('statistiche'); });
            
                bottoni.backToHomeFromRules.addEventListener('click', () => mostraSezione('landing'));
                bottoni.backToHomeFromHistory.addEventListener('click', () => mostraSezione('landing'));
                bottoni.backToHomeFromStats.addEventListener('click', () => mostraSezione('landing'));
                bottoni.backToHomeFromGameSelect.addEventListener('click', () => mostraSezione('landing'));
                
                document.querySelectorAll('.back-to-game-select').forEach(btn => {
                    btn.addEventListener('click', () => mostraSezione('selezioneGioco'));
                });
            
                bottoni.selectGame1ed.addEventListener('click', () => { resetStato('1ed'); updateExpansions_1ed(); aggiornaListaGiocatoriUI_1ed(); mostraSezione('setup-1ed'); });
                bottoni.selectGame2ed.addEventListener('click', () => { resetStato('2ed'); updateExpansions_2ed(); aggiornaListaGiocatoriUI_2ed(); mostraSezione('setup-2ed'); });
                bottoni.selectGameArchitects.addEventListener('click', () => { resetStato('architects'); aggiornaListaGiocatoriUI_architects(); mostraSezione('setup-architects');});
                bottoni.selectGameDuel.addEventListener('click', () => { resetStato('duel'); aggiornaListaGiocatoriUI_duel(); mostraSezione('setup-duel');});
                
                // Setup 1a Edizione
                setup1ed.bottoni.aggiungiGiocatore.addEventListener('click', aggiungiGiocatore_1ed);
                setup1ed.inputs.nomeGiocatore.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); aggiungiGiocatore_1ed(); } });
                setup1ed.bottoni.iniziaPartita.addEventListener('click', () => { if (!setup1ed.bottoni.iniziaPartita.disabled) avviaPartita_1ed(); });
                setup1ed.bottoni.randomWonder.addEventListener('click', assegnaMeraviglieCasuali_1ed);
                [...Object.values(setup1ed.inputs.esp), setup1ed.inputs.teamPlay].forEach(el => el.addEventListener('change', () => aggiornaListaGiocatoriUI_1ed()));
                setup1ed.inputs.dateToggle.addEventListener('change', () => setup1ed.ui.manualDateContainer.classList.toggle('hidden', !setup1ed.inputs.dateToggle.checked));
            
                // Setup 2a Edizione
                setup2ed.bottoni.aggiungiGiocatore.addEventListener('click', aggiungiGiocatore_2ed);
                setup2ed.inputs.nomeGiocatore.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); aggiungiGiocatore_2ed(); } });
                setup2ed.bottoni.iniziaPartita.addEventListener('click', () => { if (!setup2ed.bottoni.iniziaPartita.disabled) avviaPartita_2ed(); });
                setup2ed.bottoni.randomWonder.addEventListener('click', assegnaMeraviglieCasuali_2ed);
                [...Object.values(setup2ed.inputs.esp), setup2ed.inputs.teamPlay, setup2ed.inputs.dateToggle].forEach(el => el.addEventListener('change', () => {
                    setup2ed.ui.manualDateContainer.classList.toggle('hidden', !setup2ed.inputs.dateToggle.checked);
                    aggiornaListaGiocatoriUI_2ed();
                }));
                
                // Setup Architects
                setupArchitects.bottoni.aggiungiGiocatore.addEventListener('click', aggiungiGiocatore_architects);
                setupArchitects.inputs.nomeGiocatore.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); aggiungiGiocatore_architects(); } });
                setupArchitects.bottoni.iniziaPartita.addEventListener('click', () => { if (!setupArchitects.bottoni.iniziaPartita.disabled) avviaPartita_architects(); });
                setupArchitects.bottoni.randomWonder.addEventListener('click', assegnaMeraviglieCasuali_architects);
                setupArchitects.inputs.esp.medals.addEventListener('change', () => aggiornaListaGiocatoriUI_architects());
                setupArchitects.inputs.dateToggle.addEventListener('change', () => setupArchitects.ui.manualDateContainer.classList.toggle('hidden', !setupArchitects.inputs.dateToggle.checked));
                
                // Setup Duel
                setupDuel.bottoni.aggiungiGiocatore.addEventListener('click', aggiungiGiocatore_duel);
                setupDuel.inputs.nomeGiocatore.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); aggiungiGiocatore_duel(); } });
                setupDuel.bottoni.iniziaPartita.addEventListener('click', () => { if (!setupDuel.bottoni.iniziaPartita.disabled) avviaPartita_duel(); });
                setupDuel.bottoni.randomWonder.addEventListener('click', assegnaMeraviglieCasuali_duel);
                [...Object.values(setupDuel.inputs.esp)].forEach(el => el.addEventListener('change', () => {
                    updateExpansions_duel();
                    aggiornaBottoniVittoriaIstantanea_duel();
                    aggiornaListaGiocatoriUI_duel();
                }));
                setupDuel.inputs.dateToggle.addEventListener('change', () => setupDuel.ui.manualDateContainer.classList.toggle('hidden', !setupDuel.inputs.dateToggle.checked));
            
                // Navigazione punteggio
                bottoni.nextCat.addEventListener('click', () => navigaCategorie(1));
                bottoni.prevCat.addEventListener('click', () => { salvaPunteggiCategoriaCorrente(); datiPartita.categoriaCorrenteIndex -= 1; mostraSchermataCategoria(); });
                bottoni.backToSetup.addEventListener('click', () => { salvaPunteggiCategoriaCorrente(); mostraSezione(`setup-${datiPartita.gameVersion}`); });
                
                // Filtri cronologia
                ui.historyGameFilter.addEventListener('change', displayGameHistory);
                ui.historySortFilter.addEventListener('change', displayGameHistory);
                
                // Lingua
                bottoni.langIt.addEventListener('click', () => setLanguage('it'));
                bottoni.langEn.addEventListener('click', () => setLanguage('en'));
                
                // Modale
                ui.modal.cancelBtn.addEventListener('click', hideConfirmationModal);
                ui.modal.confirmBtn.addEventListener('click', () => { if(onConfirmCallback) onConfirmCallback(); hideConfirmationModal(); });
                ui.modal.overlay.addEventListener('click', (e) => { if(e.target === ui.modal.overlay) hideConfirmationModal(); });
            }

            inizializzaApp();
        });
    </script>
</body>
</html>
